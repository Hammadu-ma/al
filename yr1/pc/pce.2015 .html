<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF | Advanced Medical Education</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/protect.js"></script>
    <style type="text/css">
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --primary-light: #dbeafe; 
            --secondary: #6b7280; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #eab308; 
            --info: #0ea5e9; 
            --background: #ffffff; 
            --surface: #f9fafb; 
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-tertiary: #9ca3af; 
            --border: #e5e7eb; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.05);
            --radius: 8px; 
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --glass: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(229, 231, 235, 0.3);
        }

        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --background: #000000; 
            --surface: #111827; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-tertiary: #6b7280; 
            --border: #1f2937; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.6);
            --glass: rgba(17, 24, 39, 0.85); 
            --glass-border: rgba(31, 41, 55, 0.3);
            .mode-btn,
    .question-text,
    .option-text {
        color: var(--text-primary) !important;
    }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .logo i {
            font-size: 24px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            background: var(--glass);
            border-radius: var(--radius);
            margin: 0 16px 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--glass);
            border-left-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .categories-section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .categories-grid {
            padding: 0 16px;
        }

        .category-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .category-card.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .category-card.active .category-icon {
            background: var(--primary);
        }

        .category-name {
            font-weight: 500;
            font-size: 14px;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-right: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-card.active .progress-text {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.sidebar-open {
            margin-left: 280px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-light);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 24px 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quiz Container */
        .quiz-container {
            padding: 0 32px 32px;
        }

        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .question-card.fade-in {
            opacity: 1;
        }

        .question-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--glass);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text-primary);
            overflow-x: auto;
        }

        .question-text table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            text-align: left;
            overflow-x: auto;
            display: block;
        }

        .question-text th, .question-text td {
            padding: 12px;
            border: 1px solid var(--border);
        }

        .question-text th {
            background-color: var(--surface);
            font-weight: bold;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            min-height: 60px;
        }

        .option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .explanation-section details {
            margin-bottom: 16px;
        }

        .explanation-section summary {
            padding: 12px 16px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .explanation-section summary:hover {
            background: var(--primary-light);
        }

        .explanation-section details[open] summary {
            background: var(--primary);
            color: white;
        }

        .explanation-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .correct-answer, .why-not-section, .related-questions {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: var(--radius);
        }

        .correct-answer {
            background: rgba(34, 197, 94, 0.05);
            border-left: 4px solid var(--success);
        }

        .why-not-section {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--error);
        }

        .related-questions {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }

        .related-questions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .related-question-tag {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .related-question-tag:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .quiz-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .quiz-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .check-btn {
            background: var(--primary);
            color: white;
        }

        .check-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .next-btn {
            background: var(--success);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: #16a34a;
        }

        .submit-btn {
            background: var(--gradient);
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        /* Results Screen */
        .results-screen {
            padding: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .results-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .results-header {
            margin-bottom: 32px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            margin: 32px 0;
            color: var(--text-primary);
        }

        .score-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .results-details {
            text-align: left;
            margin: 48px 0;
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-question {
            flex: 1;
            font-size: 14px;
        }

        .result-status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-correct {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .result-incorrect {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .restart-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Enhanced Features */
        .search-container {
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: var(--text-tertiary);
            margin-right: 8px;
        }


        .export-section {
            padding: 16px 32px;
            text-align: center;
        }

        .export-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Custom Quiz Modal Styles */
        .custom-quiz-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .custom-quiz-modal.active {
            display: flex;
        }

        .custom-quiz-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        .custom-quiz-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .custom-quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .custom-quiz-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
        }

        .custom-quiz-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .custom-quiz-option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .custom-quiz-option .option-selector {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .custom-quiz-option.selected .option-selector {
            background: var(--primary);
            border-color: var(--primary);
        }

        .custom-quiz-option.selected .option-selector::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .custom-quiz-option label {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            margin: 0;
        }

        .quiz-options-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .quiz-options-section label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .custom-quiz-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Modern Dropdown for Custom Quiz */
        .custom-quiz-content .modern-dropdown {
            position: relative;
            margin-top: 8px;
        }

        .custom-quiz-content .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
        }

        .custom-quiz-content .modern-dropdown select:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }

        .custom-quiz-content .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Glass effect for modal */
        .custom-quiz-content.glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark-mode .custom-quiz-content.glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 66vw;
            }

            .main-content.sidebar-open {
                margin-left: 100vw;
            }

            .top-nav {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
                justify-content: space-between;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .quiz-container {
                padding: 0 16px 16px;
            }

            .question-card {
                padding: 24px;
            }

            .question-text {
                font-size: 17px;
            }

            .option {
                padding: 12px;
                min-height: 70px;
            }

            .results-card {
                padding: 32px 24px;
            }

            .score-display {
                font-size: 48px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                padding: 12px 16px;
            }

            .analytics-section {
                margin: 16px;
                padding: 16px;
            }

            .quiz-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) {
            .quiz-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 24px;
            }

            .question-card {
                max-width: 1000px;
                margin: 0 auto 24px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .hidden {
            display: none;
        }

        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-gradient {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .question-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .question-dropdown {
            margin-top: 8px;
            display: block;
        }

        .question-dropdown select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-error {
            color: var(--error);
        }

        .loading-spinner {
            display: none;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra Modern Styles */
        /* Glass Morphism Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Hover Effects with Glow */
        .nav-item:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left-color: var(--primary) !important;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(10px);
        }

        .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(255, 255, 255, 0.95) 100%) !important;
            transform: translateY(-5px) scale(1.03) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.1) !important;
            border-color: var(--primary) !important;
            backdrop-filter: blur(10px);
        }

        .option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.12) 100%) !important;
            transform: translateY(-3px) scale(1.03) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2) !important;
            border-color: var(--primary) !important;
        }

        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25) !important;
            filter: brightness(1.1);
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            transform: scale(1.15) rotate(8deg) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
        }

        /* Ultra Modern Dropdown */
        .modern-dropdown {
            position: relative;
            margin-top: 12px;
        }

        .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--glass) 100%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .modern-dropdown select:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 25px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        /* Enhanced Search with Blur Effect */
        .search-container {
            transition: all 0.4s ease;
        }

        .search-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-blur-active .main-content > *:not(.search-container):not(.quiz-container) {
            filter: blur(8px);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Beautiful Stats Cards */
        .stat-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2) !important;
        }

        /* Modern Progress Bars */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), #8b5cf6) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Beautiful Notification */
        .notification {
            border-radius: 20px !important;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)) !important;
        }

        .dark-mode .notification {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2)) !important;
        }

        /* Enhanced Question Cards */
        .question-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-3px);
            border-color: var(--primary-light);
        }

        /* Modern Settings Panel */
        .settings-panel {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Question Creator */
        .custom-question-creator {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 32px;
        }

        .dark-mode .custom-question-creator {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
        }

        /* Dark mode adjustments */
        .dark-mode .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.1) 100%) !important;
        }

        .dark-mode .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(17, 24, 39, 0.95) 100%) !important;
        }

        .dark-mode .option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 100%) !important;
        }

        /* Search Results Highlight */
        .search-highlight {
            background: linear-gradient(120deg, var(--primary-light) 0%, transparent 50%);
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 12px 16px;
    }

    .stat-card {
        padding: 16px 12px;
        min-height: 80px;
    }

    .stat-header {
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .stat-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }

    .stat-value {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .stat-label {
        font-size: 11px;
        line-height: 1.3;
    }

    .stat-trend {
        font-size: 10px;
    }

    .stat-trend i {
        font-size: 10px;
    }
}

/* Extra small devices (phones under 400px) */
@media (max-width: 400px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px 12px;
    }

    .stat-card {
        padding: 14px 10px;
        min-height: 70px;
    }

    .stat-value {
        font-size: 18px;
    }

    .stat-label {
        font-size: 10px;
    }
}
.analytics-grid {
    display: none;
}

/* OR hide individual cards */
.analytics-card {
    display: none;
}

/* If you want to keep the section structure but hide content */
.analytics-section {
    padding: 0;
    margin: 0;
    height: 0;
    overflow: hidden;
}
@media (max-width: 768px) {
    /* Your existing mobile styles... */
    
    .sidebar {
        width: 66vw;
    }

    .main-content.sidebar-open {
        margin-left: 100vw;
    }

    .top-nav {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    /* Hide all custom question and export buttons on mobile */
    .fab {
        display: none !important;
    }
    
    #createCustomQuizBtn {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }

    /* Your stats grid and other mobile styles... */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
    /* ... rest of your mobile CSS */
}
@media (max-width: 768px) {
    .fab {
        display: none !important;
    }
    
    /* Hide entire export section from Dashboard */
    .export-section {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }
}
@media (max-width: 768px) {
    /* Hide all stat cards except Correct Answers */
    .stat-card:not(:first-child) {
        display: none !important;
    }
    
    /* Optional: Make the Correct Answers card full width */
    .stat-card:first-child {
        width: 100% !important;
        flex: 1 !important;
    }

    /* Your existing mobile styles for stats grid */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
}
.user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
/* Primary action button */
.action-btn.primary {
    background: var(--primary);
    color: white;
}

.action-btn.primary:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}
/* Responsive Images */
.question-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 16px 0;
    display: block;
    box-shadow: var(--shadow);
}

.question-image-container {
    width: 100%;
    text-align: center;
    margin: 16px 0;
}

/* Ensure images don't overflow their containers */
.question-image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: var(--shadow);
}

/* Responsive Tables */
.question-text table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 14px;
    text-align: left;
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--radius);
    background: var(--surface);
}

.question-text th, .question-text td {
    padding: 12px;
    border: 1px solid var(--border);
    min-width: 120px; /* Prevents columns from becoming too narrow */
}

.question-text th {
    background-color: var(--surface);
    font-weight: bold;
    position: sticky;
    left: 0;
    color: var(--text-primary);
}

.question-text td {
    color: var(--text-secondary);
    background: var(--background);
}

/* Responsive Question Cards */
.question-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    width: 100%;
    overflow: hidden;
}

.question-card:hover {
    box-shadow: var(--shadow-lg);
}

/* Mobile-specific adjustments */
@media (max-width: 768px) {
    /* Question card mobile optimization */
    .question-card {
        padding: 16px;
        margin-bottom: 12px;
        border-radius: var(--radius);
    }
    
    .question-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .question-meta {
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
    }
    
    .question-actions {
        align-self: flex-end;
        margin-top: -40px; /* Position actions at top right */
        position: relative;
        z-index: 2;
    }
    
    .question-text {
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 20px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* Image mobile optimization */
    .question-image {
        margin: 12px 0;
        border-radius: 6px;
    }
    
    .question-image-container {
        margin: 12px 0;
    }
    
    /* Table mobile optimization */
    .question-text table {
        font-size: 12px;
        margin: 12px 0;
        border-radius: 6px;
    }
    
    .question-text th, .question-text td {
        padding: 8px 10px;
        min-width: 100px;
    }
    
    /* Options grid mobile optimization */
    .options-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .option {
        padding: 14px;
        min-height: auto;
    }
    
    .option-letter {
        width: 28px;
        height: 28px;
        font-size: 13px;
    }
    
    .option-text {
        font-size: 14px;
        line-height: 1.4;
    }
    
    /* Quiz controls mobile optimization */
    .quiz-controls {
        flex-direction: column;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
    }
    
    .quiz-btn {
        width: 100%;
        justify-content: center;
        padding: 14px 20px;
        font-size: 15px;
    }
    
    /* Explanation section mobile optimization */
    .explanation-section {
        margin-top: 20px;
        padding: 16px;
    }
    
    .explanation-section summary {
        padding: 10px 12px;
        font-size: 14px;
    }
    
    .explanation-content {
        padding: 12px;
        font-size: 13px;
        line-height: 1.5;
    }
}

/* Extra small devices optimization (phones under 480px) */
@media (max-width: 480px) {
    .question-card {
        padding: 12px;
        margin-bottom: 10px;
    }
    
    .question-text {
        font-size: 15px;
        line-height: 1.4;
    }
    
    /* Image optimization for very small screens */
    .question-image {
        margin: 10px 0;
        border-radius: 4px;
    }
    
    .question-image-container {
        margin: 10px 0;
    }
    
    /* Table optimization for very small screens */
    .question-text table {
        font-size: 11px;
        margin: 10px 0;
    }
    
    .question-text th, .question-text td {
        padding: 6px 8px;
        min-width: 80px;
    }
    
    .question-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
    }
    
    .question-number, .question-category, .question-difficulty {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    .option {
        padding: 12px 10px;
    }
    
    .option-text {
        font-size: 13px;
    }
    
    .action-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
    }
    
    /* Ensure proper spacing in exam mode */
    .exam-mode-layout .question-card {
        margin-bottom: 16px;
    }
}

/* Fix for exam mode layout on mobile */
.exam-mode-layout {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

@media (max-width: 768px) {
    .exam-mode-layout {
        gap: 12px;
    }
    
    .exam-header {
        padding: 16px;
    }
    
    .exam-header > div:first-child {
        flex-direction: column;
        gap: 16px;
    }
    
    .exam-mode-toggle {
        align-self: stretch;
        display: flex;
    }
    
    .mode-toggle-btn {
        flex: 1;
        text-align: center;
        font-size: 12px;
        padding: 10px 8px;
    }
    
    .progress-info {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .progress-info .progress-bar {
        width: 100%;
    }
}

/* Fix for learn mode responsiveness */
@media (max-width: 768px) {
    .explanation-section {
        padding: 16px;
    }
    
    .explanation-section summary {
        padding: 10px 12px;
        font-size: 14px;
    }
    
    .explanation-content {
        padding: 12px;
        font-size: 13px;
    }
    
    .related-questions-list {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .related-question-tag {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    .correct-answer, .why-not-section, .related-questions {
        padding: 12px;
        margin-bottom: 12px;
    }
}

/* Prevent horizontal scrolling on the entire page */
@media (max-width: 768px) {
    body {
        overflow-x: hidden;
    }
    
    .quiz-container {
        padding: 0 16px 16px;
    }
    
    .main-content {
        width: 100%;
    }
}

/* Ensure images in custom questions are also responsive */
.custom-question-creator img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 10px 0;
    display: block;
}

/* Fix for image loading states */
.question-image {
    background: var(--surface);
    min-height: 50px;
}

.question-image:not([src]) {
    display: none;
}

/* Animation for image loading */
@keyframes imageFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.question-image.loaded {
    animation: imageFadeIn 0.3s ease-in;
}
    </style>
</head>
<body class="dark-mode">
    <div class="overlay" id="overlay"></div>
    
    <!-- Custom Quiz Modal -->
<div class="custom-quiz-modal" id="customQuizModal">
    <div class="custom-quiz-content glass-effect">
        <h3 class="custom-quiz-title">Create Custom Quiz</h3>
        <div class="custom-quiz-options">
            <div class="custom-quiz-option" data-category="all">
                <div class="option-selector"></div>
                <label>All Categories</label>
            </div>
            <div class="custom-quiz-option" data-category="easy">
                <div class="option-selector"></div>
                <label>Easy Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="medium">
                <div class="option-selector"></div>
                <label>Medium Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="hard">
                <div class="option-selector"></div>
                <label>Hard Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="bookmarked">
                <div class="option-selector"></div>
                <label>Bookmarked Questions Only</label>
            </div>
            <div class="quiz-options-section">
                <label>Number of Questions</label>
                <div class="modern-dropdown">
                    <select id="questionCount">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="0">All Questions</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="custom-quiz-actions">
            <button class="quiz-btn" id="cancelCustomQuiz">
                Cancel
            </button>
            <button class="quiz-btn check-btn" id="createCustomQuiz">
                Create Quiz
            </button>
        </div>
    </div>
</div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>ALIF</span>
                </div>
                <div class="sidebar-subtitle">Advanced Medical Education Platform</div>
            </div>
            
            <div class="user-profile">
    <div class="user-avatar">
        <img src="logo.png" alt="User Avatar">
    </div>
    <div class="user-info">
        <h3>ALIFO</h3>
        <p>Medical Student</p>
    </div>
</div>

            
            <div class="nav-item active">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>My Courses</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Progress Analytics</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <span>Bookmarked Questions</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <span>Settings</span>
            </div>
            
            <div class="categories-section">
                <div class="section-title">
                    <span>Medical Categories</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <div class="top-nav">
    <div class="nav-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Add Back and Home buttons -->
        <a href="/" class="action-btn" id="backBtn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <a href="/" class="action-btn primary">
            <i class="fas fa-home"></i>
        </a>
        
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
    </div>
    <div class="nav-right">
        <!-- Your existing mode selector and buttons -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="exam" aria-label="Exam Mode">
                <i class="fas fa-file-alt"></i>
                Exam
            </button>
            <button class="mode-btn" data-mode="quiz" aria-label="Quiz Mode">
                <i class="fas fa-tasks"></i>
                Quiz
            </button>
            <button class="mode-btn" data-mode="learn" aria-label="Learn Mode">
                <i class="fas fa-brain"></i>
                Learn
            </button>
        </div>
        <div class="action-btn" id="themeToggle" aria-label="Toggle Theme">
            <i class="fas fa-sun"></i>
        </div>
        <div class="action-btn" aria-label="Notifications">
            <i class="fas fa-bell"></i>
        </div>
    </div>
</div>
            
            <!-- Search Section -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search questions or categories...">
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            <span style="color: var(--error); font-size: 13px;">-5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="timeSpent">0h</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="masteryLevel">0%</div>
                    <div class="stat-label">Mastery Level</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--warning);"></i>
                            <span style="color: var(--warning); font-size: 13px;">+3</span>
                        </div>
                    </div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="analytics-section">
                <h3 class="analytics-title">Learning Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="weakAreasCount">0</div>
                        <div class="analytics-label">Weak Areas Identified</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avgTimePerQuestion">0s</div>
                        <div class="analytics-label">Avg Time Per Question</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="improvementRate">0%</div>
                        <div class="analytics-label">Weekly Improvement</div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer"></div>
            
            <!-- Results Screen -->
            <div class="results-screen hidden" id="resultsScreen"></div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" id="exportProgress">
                    <i class="fas fa-download"></i>
                     
                </button>
                <button class="export-btn" id="createCustomQuizBtn" style="margin-left: 12px;">
                    <i class="fas fa-plus"></i>
                     
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // Check if running inside Telegram
  const tg = window.Telegram?.WebApp;

  // --- 1ï¸âƒ£ Handle Telegram Mini App Back Button ---
  if (tg) {
    tg.ready(); // Initialize Telegram SDK
    tg.BackButton.show();

    tg.BackButton.onClick(() => {
      console.log("Telegram back button pressed");
      handleBackAction();
    });
  }

  // --- 2ï¸âƒ£ Handle Browser/Phone Back Button ---
  window.addEventListener('popstate', () => {
    console.log("Browser back button pressed");
    handleBackAction();
  });

  // --- 3ï¸âƒ£ Function to handle back action globally ---
  function handleBackAction() {
    // Example actions (customize as you wish):
    // Go back if possible, otherwise go to home page
    if (document.referrer && window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = '/'; // or your home page route
    }
  }

  // --- 4ï¸âƒ£ Optional: Prevent unwanted exits ---
  // This ensures pressing back doesnâ€™t immediately close the app
  history.pushState(null, '', location.href);
</script>

     <script>
        // Anti-copy, anti-inspect measures
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
    }
});

// Enhanced quiz data with more questions
const quizData = [
    {
        "id": 1,
        "question": "Which of the following best describes pre-systemic metabolism?",
        "options": [
            "Inactivation of a drug as a result of the gastric acids.",
            "Absorption of a drug through the duodenum.",
            "Drug given orally is metabolized by the liver before entering the circulation.",
            "Drug given IV accumulates quickly in the central nervous system (CNS)."
        ],
        "answer": 2,
        "correctAnswer": "Drug given orally is metabolized by the liver before entering the circulation.",
        "explanation": "Pre-systemic metabolism, also known as first-pass metabolism, occurs when an orally administered drug is metabolized primarily by the liver (via portal vein) before reaching systemic circulation, reducing bioavailability.",
        "whyNotOtherOptions": {
            "a": "Gastric acid inactivation is part of degradation, not specifically pre-systemic metabolism.",
            "b": "Duodenal absorption is part of the absorption process, not metabolism.",
            "d": "IV drugs bypass first-pass metabolism and do not accumulate preferentially in CNS unless lipophilic."
        },
        "relatedQuestions": ["11", "35"],
        "category": "Pharmacokinetics",
        "difficulty": "Easy"
    },
    {
        "id": 2,
        "question": "A laboratory experiment is being conducted in which a mammal is injected with a noncompetitive antagonist to the histamine receptor. Which of the following best describes this agent?",
        "options": [
            "The drug binds to the histamine receptor and partially activates it.",
            "The drug binds to the histamine receptor but does not activate it.",
            "The drug binds to the receptor, but not where histamine binds, and prevents the receptor from being activated.",
            "The drug irreversibly binds to the histamine receptor and renders it ineffective."
        ],
        "answer": 2,
        "correctAnswer": "The drug binds to the receptor, but not where histamine binds, and prevents the receptor from being activated.",
        "explanation": "Noncompetitive antagonists bind to an allosteric site (not the agonist binding site), reducing the receptor's response to the agonist regardless of agonist concentration; effect cannot be overcome by increasing agonist.",
        "whyNotOtherOptions": {
            "a": "Partial activation describes a partial agonist.",
            "b": "Binding without activation could describe competitive antagonist.",
            "d": "Irreversible binding is a property of some antagonists but not defining noncompetitive."
        },
        "relatedQuestions": ["7", "16"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium"
    },
    {
        "id": 3,
        "question": "A drug M is injected IV into a laboratory subject. It is noted to have high serum protein binding. Which of the following is most likely to be increased as a result?",
        "options": [
            "Drug interaction",
            "Distribution of the drug to tissue sites",
            "Renal excretion",
            "Liver metabolism"
        ],
        "answer": 0,
        "correctAnswer": "Drug interaction",
        "explanation": "High plasma protein binding (mainly to albumin) reduces the free fraction of drug available for distribution, excretion, and metabolism, but increases potential for displacement interactions with other highly bound drugs.",
        "whyNotOtherOptions": {
            "b": "High binding decreases tissue distribution (lower Vd).",
            "c": "Only free drug is filtered/excreted; high binding decreases excretion.",
            "d": "Only free drug is metabolized; high binding may prolong half-life but not increase metabolism rate."
        },
        "relatedQuestions": ["20", "24"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 4,
        "question": "All of the following are capable of initiating a signal transduction process except",
        "options": [
            "Combination of an agonist with its receptor",
            "Combination of an antagonist with its receptor",
            "Combination of a neurotransmitter with its receptor",
            "Combination of a hormone with its receptor"
        ],
        "answer": 1,
        "correctAnswer": "Combination of an antagonist with its receptor",
        "explanation": "Antagonists bind receptors but do not activate them or initiate signal transduction; they block agonists from doing so. Agonists (including neurotransmitters/hormones acting as such) trigger transduction.",
        "whyNotOtherOptions": {
            "a": "Agonist binding activates transduction.",
            "c": "Neurotransmitters often act as agonists.",
            "d": "Hormones act as agonists at receptors."
        },
        "relatedQuestions": ["16", "53"],
        "category": "Pharmacodynamics",
        "difficulty": "Easy"
    },
    {
        "id": 5,
        "question": "Concerning the renal excretion of drugs:",
        "options": [
            "Drugs that are ionized in the renal tubule are more likely to undergo passive reabsorption than those that are unionized",
            "Low-molecular-weight drugs are much more likely to be actively secreted than filtered.",
            "Only drug that is not bound to plasma proteins (i.e., free drug) is filtered by the glomerulus.",
            "Decreasing renal tubular fluid pH will increase elimination of weakly acidic drugs."
        ],
        "answer": 2,
        "correctAnswer": "Only drug that is not bound to plasma proteins (i.e., free drug) is filtered by the glomerulus.",
        "explanation": "Glomerular filtration occurs only for unbound (free) drug; protein-bound drug is too large to pass the capillary pores.",
        "whyNotOtherOptions": {
            "a": "Ionized drugs are less lipid-soluble, decreasing reabsorption (trapped in tubule).",
            "b": "Low MW drugs are filtered; active secretion is for specific drugs via transporters, not primarily MW-dependent.",
            "d": "Decreasing pH ionizes weak acids (HA â†’ H+ + A-), decreasing reabsorption and increasing elimination."
        },
        "relatedQuestions": ["24", "3"],
        "category": "Pharmacokinetics",
        "difficulty": "Hard"
    },
    {
        "id": 6,
        "question": "KR2250 is an investigational cholesterol-lowering agent. KR2250 has a low molecular weight and is lipophobic. KR2250 will have a(n) ______ apparent volume of distribution (Vd):",
        "options": [
            "High",
            "Low",
            "Moderate",
            "Normal"
        ],
        "answer": 1,
        "correctAnswer": "Low",
        "explanation": "Lipophobic (hydrophilic) drugs have poor tissue penetration and remain largely in plasma/extracellular fluid, resulting in low Vd (typically <0.2 L/kg). Low MW aids filtration but not distribution if hydrophilic.",
        "whyNotOtherOptions": {
            "a": "High Vd requires lipophilicity for tissue binding.",
            "c": "Moderate Vd for balanced solubility.",
            "d": "Normal not standard term; context implies low."
        },
        "relatedQuestions": ["20", "54"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 7,
        "question": "In the presence of propranolol, a higher concentration of epinephrine is required to elicit full anti-asthmatic activity. Propranolol has no effect on asthma symptoms. Which is correct regarding these medications?",
        "options": [
            "Epinephrine is less efficacious than is propranolol",
            "Epinephrine is a full agonist, and propranolol is a partial agonist.",
            "Epinephrine is an agonist, and propranolol is a competitive antagonist.",
            "Epinephrine is an agonist, and propranolol is a noncompetitive antagonist."
        ],
        "answer": 2,
        "correctAnswer": "Epinephrine is an agonist, and propranolol is a competitive antagonist.",
        "explanation": "Propranolol (beta-blocker) competitively antagonizes epinephrine at Î²2 receptors in bronchi; higher epinephrine needed to overcome blockade (surmountable), max response unchanged.",
        "whyNotOtherOptions": {
            "a": "Efficacy same; potency shifted.",
            "b": "Propranolol has no agonist activity.",
            "d": "Noncompetitive would reduce max response."
        },
        "relatedQuestions": ["2", "53"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium"
    },
    {
        "id": 8,
        "question": "Prior to clinical trials in patients with heart failure, an animal study was carried out to compare two new positive inotropic drugs (A and B) to a current standard agent (C). The results of cardiac output measurements are shown in the graph below. Which of the following statements is correct?",
        "options": [
            "Drug A is most effective",
            "Drug B is least potent",
            "Drug C is most potent",
            "Drug B is more potent than drug C and more effective than drug A",
            "Drug A is more potent than drug B and more effective than drug C"
        ],
        "answer": 1,
        "correctAnswer": "Drug B is least potent",
        "explanation": "Note: No graph provided; standard interpretation assumes typical dose-response curves. Potency: left-shift = higher potency. Efficacy: higher max = higher efficacy. Common pattern: A potent/high efficacy, B low potency/high efficacy, C moderate. Least potent = rightmost curve (B).",
        "whyNotOtherOptions": {
            "a": "Depends on max; if B highest max, not A.",
            "c": "If C right of A, not most potent.",
            "d": "If B right of C, not more potent.",
            "e": "Complex; unlikely both."
        },
        "relatedQuestions": ["9", "54"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium",
        "image": "2015.8.png"
    },
    {
        "id": 9,
        "question": "Two cholesterol-lowering drugs, X and Y, were studied in a large group of patients, and the percentages of the group showing a specific therapeutic effect (35% reduction in low-density lipoprotein [LDL] cholesterol) were determined. The results are shown in the following table. Which of the following statements about these results is correct?",
        "options": [
            "Drug X is safer than drug Y",
            "Drug Y is more effective than drug X",
            "The 2 drugs act on the same receptors",
            "Drug X is less potent than drug Y",
            "The therapeutic index of drug Y is 10 10"
        ],
        "answer": 3,
        "correctAnswer": "Drug X is less potent than drug Y",
        "explanation": "Quantal dose-response: Y curve left-shifted vs X (lower doses achieve same % response, e.g., 50% at ~20mg Y vs ~50mg X), indicating higher potency for Y. Max response both 100% (same efficacy).",
        "whyNotOtherOptions": {
            "a": "No toxicity data.",
            "b": "Both reach 100%; same efficacy.",
            "c": "No mechanism info.",
            "e": "TI requires LD50/ED50; incomplete."
        },
        "relatedQuestions": ["8", "54"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard",
        "image": "2015.9.png"
    },
    {
        "id": 10,
        "question": "Biotransformation of the drugs may lead to all of the following except",
        "options": [
            "Inactive metabolite from an active drug",
            "Active metabolite from an active drug",
            "Active metabolite from an inactive drug (prodrug)",
            "Inactive metabolite from inactive drug"
        ],
        "answer": 3,
        "correctAnswer": "Inactive metabolite from inactive drug",
        "explanation": "Biotransformation typically inactivates active drugs or activates prodrugs; producing inactive from already inactive is not a useful outcome and rarely emphasized as biotransformation goal.",
        "whyNotOtherOptions": {
            "a": "Common (termination).",
            "b": "Possible (e.g., codeine to morphine).",
            "c": "Prodrug activation."
        },
        "relatedQuestions": ["13", "21"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 11,
        "question": "Choose out the appropriate alimentary route of administration where the passage of drugs through liver is minimized",
        "options": [
            "Oral route",
            "Sublingual route",
            "Buccal route",
            "Both b and c are correct"
        ],
        "answer": 3,
        "correctAnswer": "Both b and c are correct",
        "explanation": "Sublingual/buccal routes absorb directly into systemic circulation via oral mucosa veins, bypassing portal vein and first-pass hepatic metabolism.",
        "whyNotOtherOptions": {
            "a": "Oral undergoes full first-pass.",
            "b": "Correct but incomplete alone."
        },
        "relatedQuestions": ["1", "35"],
        "category": "Pharmacokinetics",
        "difficulty": "Easy"
    },
    {
        "id": 12,
        "question": "Which one of the following is the correct description of a brand named drug?",
        "options": [
            "Pamadol",
            "pamadol",
            "PamadolÂ®",
            "pamadolÂ®"
        ],
        "answer": 2,
        "correctAnswer": "PamadolÂ®",
        "explanation": "Brand (proprietary/trade) names are capitalized with registered trademark symbol (Â®); generic names are lowercase.",
        "whyNotOtherOptions": {
            "a": "Capitalized but no Â®.",
            "b": "Lowercase generic style.",
            "d": "Lowercase with Â® incorrect."
        },
        "relatedQuestions": ["26"],
        "category": "General Pharmacology",
        "difficulty": "Easy"
    },
    {
        "id": 13,
        "question": "Choose the correct statement",
        "options": [
            "Few drugs undergo phase 1 and phase 2 metabolism simultaneously",
            "Hydrophilic drugs can undergo phase 2 metabolism directly",
            "All drugs are metabolized by cytochrome enzymes",
            "Metabolites of few drugs are mostly inactive"
        ],
        "answer": 1,
        "correctAnswer": "Hydrophilic drugs can undergo phase 2 metabolism directly",
        "explanation": "Phase 2 (conjugation) adds polar groups; hydrophilic drugs may skip Phase 1 (oxidation/reduction) and go directly to conjugation for excretion.",
        "whyNotOtherOptions": {
            "a": "Sequential or separate, not simultaneous.",
            "c": "Not all; some Phase 2 only or non-CYP.",
            "d": "Most metabolites inactive; few active."
        },
        "relatedQuestions": ["10", "21"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 14,
        "question": "Which is wrong concerning the safety of using penicillin versus warfarin?",
        "options": [
            "Penicillin is a safer drug because it has a high therapeutic index.",
            "Warfarin treatment has a higher chance of resulting in dangerous adverse effects if bioavailability is altered.",
            "The high therapeutic index makes penicillin a safe drug for all patients.",
            "Penicillin treatment has a low chance of causing dangerous adverse effects if bioavailability is altered."
        ],
        "answer": 2,
        "correctAnswer": "The high therapeutic index makes penicillin a safe drug for all patients.",
        "explanation": "High TI (penicillin ~1000) means wide safety margin, but allergies/idiosyncratic reactions can occur in some patients; not safe for all (e.g., penicillin-allergic).",
        "whyNotOtherOptions": {
            "a": "Correct; high TI.",
            "b": "Warfarin narrow TI; bioavailability changes risky.",
            "d": "High TI buffers variability."
        },
        "relatedQuestions": ["54", "55"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium"
    },
    {
        "id": 15,
        "question": "Main factor for this interaction of drugs at the level of absorption is:",
        "options": [
            "Chelation",
            "High plasma protein binding ability",
            "Enzyme induction or inhibition",
            "Tubular secretion or reabsorption",
            "None"
        ],
        "answer": 0,
        "correctAnswer": "Chelation",
        "explanation": "Question implies common absorption interaction (e.g., tetracyclines with divalent cations); chelation forms insoluble complexes reducing absorption.",
        "whyNotOtherOptions": {
            "b": "Protein binding affects distribution/metabolism.",
            "c": "Affects biotransformation.",
            "d": "Renal excretion."
        },
        "relatedQuestions": ["43"],
        "category": "Drug Interactions",
        "difficulty": "Easy"
    },
    {
        "id": 16,
        "question": "Select the wrong statement among the following",
        "options": [
            "Agonist has full affinity and high intrinsic activity",
            "Partial agonist has full affinity and low intrinsic activity",
            "Partial agonist can produce a full biological response at high concentration",
            "Inverse agonist has full affinity and intrinsic activity",
            "Antagonist has full affinity but no intrinsic activity"
        ],
        "answer": 2,
        "correctAnswer": "Partial agonist can produce a full biological response at high concentration",
        "explanation": "Partial agonists have submaximal intrinsic activity; even at 100% occupancy/saturation, response < full agonist max.",
        "whyNotOtherOptions": {
            "a": "Correct definition.",
            "b": "Correct.",
            "d": "Inverse has negative intrinsic activity.",
            "e": "Correct (zero efficacy)."
        },
        "relatedQuestions": ["2", "53"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard"
    },
    {
        "id": 17,
        "question": "One of the following statement is incorrect about antagonists",
        "options": [
            "Irreversible competitive antagonist effect can be overcome by increasing concentration of the agonist",
            "Noncompetitive antagonist effect cannot be overcome even after increasing concentration of the agonist",
            "Reversible competitive antagonist shift the agonist log concentration-effect curve to the right, without change of slope or maximum effect",
            "A and B only",
            "None of the above"
        ],
        "answer": 0,
        "correctAnswer": "Irreversible competitive antagonist effect can be overcome by increasing concentration of the agonist",
        "explanation": "Irreversible competitive (binds covalently to same site) reduces receptor number; max response depressed (insurmountable), not overcome by agonist.",
        "whyNotOtherOptions": {
            "b": "Correct for noncompetitive.",
            "c": "Correct for reversible competitive."
        },
        "relatedQuestions": ["7", "2"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard"
    },
    {
        "id": 18,
        "question": "All of the following characteristics of drug increases its movement and availability at sites of action except",
        "options": [
            "High lipid to water partition coefficient",
            "Low molecular size and degree of ionization",
            "High plasma protein binding affinity",
            "None of the above"
        ],
        "answer": 2,
        "correctAnswer": "High plasma protein binding affinity",
        "explanation": "High protein binding retains drug in plasma, reducing free fraction available for diffusion to tissues/sites of action.",
        "whyNotOtherOptions": {
            "a": "Lipophilicity aids membrane crossing.",
            "b": "Small/unionized favors passive diffusion."
        },
        "relatedQuestions": ["3", "20"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 19,
        "question": "Which of the following is incorrect about the processes of drug absorption",
        "options": [
            "Facilitated diffusion is protein carrier mediated passive process",
            "Clathrin dependent transport increases the efficiency of endocytosis",
            "Endocytosis is important for protozoa and worms nutritional supply",
            "Pinocytosis is a process by which liquid substances are engulfed by the cell",
            "None of the above"
        ],
        "answer": 4,
        "correctAnswer": "None of the above",
        "explanation": "All statements correct: facilitated = carrier passive down gradient; clathrin coats vesicles in receptor-mediated endocytosis; parasites use endocytosis; pinocytosis = fluid-phase endocytosis.",
        "whyNotOtherOptions": {
            "a": "Correct.",
            "b": "Correct.",
            "c": "Correct.",
            "d": "Correct."
        },
        "relatedQuestions": ["20"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 20,
        "question": "Select the correct statement among the following",
        "options": [
            "A highly plasma protein bound drugs will have a low volume of distribution",
            "Highly tissue protein bound drugs are confined to the blood plasma",
            "Vasoconstrictor agents increases the absorption of drugs",
            "For a drug to be readily absorbed it must be hydrophobic with no solubility in aqueous solutions",
            "None of the above"
        ],
        "answer": 0,
        "correctAnswer": "A highly plasma protein bound drugs will have a low volume of distribution",
        "explanation": "High plasma binding â†’ low free drug â†’ limited tissue distribution â†’ low Vd.",
        "whyNotOtherOptions": {
            "b": "Tissue binding increases Vd.",
            "c": "Vasoconstrictors decrease absorption (reduce blood flow).",
            "d": "Needs balance; pure hydrophobic poor dissolution."
        },
        "relatedQuestions": ["6", "3"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 21,
        "question": "All of the following can be the outcome of drug metabolism except",
        "options": [
            "Conversion of inactive drug into active metabolite",
            "Conversion of active drug into active metabolite",
            "Conversion of active drug to toxic metabolite",
            "Conversion of polar drug to non-polar metabolite",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Conversion of polar drug to non-polar metabolite",
        "explanation": "Metabolism increases polarity (Phase 1 adds functional groups, Phase 2 conjugates) to facilitate excretion; rarely decreases polarity.",
        "whyNotOtherOptions": {
            "a": "Prodrug activation.",
            "b": "Active to active.",
            "c": "Toxification."
        },
        "relatedQuestions": ["10", "13"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 22,
        "question": "Which of the following statement is incorrect",
        "options": [
            "Chronic reduction in receptor stimulation leads to super sensitivity",
            "Agonistic drugs prevent receptor down-regulation due to endogenous agonist",
            "Sudden withdrawal of antagonists produce an exaggerated response",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Agonistic drugs prevent receptor down-regulation due to endogenous agonist",
        "explanation": "Chronic agonists cause down-regulation (desensitization); antagonists cause up-regulation, withdrawal leads to supersensitivity.",
        "whyNotOtherOptions": {
            "a": "Correct (up-regulation).",
            "c": "Correct (rebound)."
        },
        "relatedQuestions": ["23"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium"
    },
    {
        "id": 23,
        "question": "Receptor desensitization can be the result of which of the following",
        "options": [
            "Temporarily inaccessibility of receptors to agonist",
            "Fewer receptors are synthesized and available at the cell surface",
            "Agonist mediated endocytosis",
            "All of the above",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "All of the above",
        "explanation": "Desensitization mechanisms: phosphorylation (inaccessibility), down-regulation (reduced synthesis), internalization/endocytosis.",
        "whyNotOtherOptions": {
            "a": "Phosphorylation/sequestration.",
            "b": "Down-regulation.",
            "c": "Endocytosis."
        },
        "relatedQuestions": ["22"],
        "category": "Pharmacodynamics",
        "difficulty": "Easy"
    },
    {
        "id": 24,
        "question": "Which of the following is incorrect about renal excretion of drugs",
        "options": [
            "P-glycoprotein and the multidrug-resistance-associated protein type 2 are responsible for the secretion of amphipathic anions and conjugated metabolites",
            "Solute carrier transporters that are more selective for organic cationic drugs are involved in the secretion of organic acids",
            "When the tubular urine is made more alkaline, weak acids are excreted more rapidly and to a greater extent",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Solute carrier transporters that are more selective for organic cationic drugs are involved in the secretion of organic acids",
        "explanation": "OCT (organic cation transporters) secrete cations; OAT (organic anion transporters) secrete anions/acids.",
        "whyNotOtherOptions": {
            "a": "P-gp/MRP2 for anions/conjugates.",
            "c": "Alkaline urine ionizes weak acids (A-), reduces reabsorption."
        },
        "relatedQuestions": ["5", "3"],
        "category": "Pharmacokinetics",
        "difficulty": "Hard"
    },
    {
        "id": 25,
        "question": "Suspension dosage forms can be administered through all of the following route of drug administration except",
        "options": [
            "Oral",
            "Sub-cutaneous",
            "Intramuscular",
            "Intravenous",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Intravenous",
        "explanation": "Suspensions contain undissolved particles; risk embolism if IV; suitable for oral, SC/IM (depot).",
        "whyNotOtherOptions": {
            "a": "Common oral suspensions.",
            "b": "SC suspensions (insulin).",
            "c": "IM depot injections."
        },
        "relatedQuestions": ["35"],
        "category": "Pharmaceutics",
        "difficulty": "Easy"
    },
    {
        "id": 26,
        "question": "Which of the following is incorrect about drug nomenclature",
        "options": [
            "Chemical name is too long and difficult to recognize",
            "One drug may have more than one proprietary name",
            "One drug has only one generic name",
            "Chemical name is internationally accepted name of drugs used in pharmacopoeias",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Chemical name is internationally accepted name of drugs used in pharmacopoeias",
        "explanation": "INN (International Nonproprietary Name)/generic is standardized; chemical name descriptive but not used as official in pharmacopoeias.",
        "whyNotOtherOptions": {
            "a": "True.",
            "b": "Multiple brands possible.",
            "c": "One INN."
        },
        "relatedQuestions": ["12"],
        "category": "General Pharmacology",
        "difficulty": "Medium"
    },
    {
        "id": 27,
        "question": "Which of the following is incorrect about excretion of drug through milk and saliva",
        "options": [
            "The concentration of acidic drugs at saliva is parallel to that in plasma",
            "The concentration of acidic drugs in the milk is lower than in plasma",
            "The concentration of basic drugs in the milk is lower than in plasma",
            "A and C only"
        ],
        "answer": 2,
        "correctAnswer": "The concentration of basic drugs in the milk is lower than in plasma",
        "explanation": "Milk pH < plasma; basic drugs ion-trapped in milk (higher concentration); acidic lower.",
        "whyNotOtherOptions": {
            "a": "Saliva pH ~ plasma for non-ionized.",
            "b": "Acidic lower in milk."
        },
        "relatedQuestions": ["24"],
        "category": "Pharmacokinetics",
        "difficulty": "Hard"
    },
    {
        "id": 28,
        "question": "Which of the following is the most useful parameter for the evaluation of the elimination mechanism and of the eliminating organs",
        "options": [
            "Clearance",
            "Metabolism",
            "Volume of distribution",
            "Excretion",
            "All except C"
        ],
        "answer": 0,
        "correctAnswer": "Clearance",
        "explanation": "Clearance (CL) = volume plasma cleared per time; quantifies elimination efficiency; organ CL (renal/hepatic) identifies mechanisms.",
        "whyNotOtherOptions": {
            "b": "Part of elimination.",
            "c": "Distribution parameter.",
            "d": "Part but not quantitative."
        },
        "relatedQuestions": ["29"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 29,
        "question": "The maximum (peak) plasma concentration is used to determine all of the following except",
        "options": [
            "Comparative bioavailability",
            "Comparative bioequivalence",
            "Preferred route of administration",
            "Onset of action",
            "None of the above"
        ],
        "answer": 2,
        "correctAnswer": "Preferred route of administration",
        "explanation": "Cmax used in BE/BA (extent/rate), correlates with onset; route preference involves multiple factors (first-pass, patient factors).",
        "whyNotOtherOptions": {
            "a": "F metric.",
            "b": "Cmax/AUC.",
            "d": "Higher Cmax faster onset."
        },
        "relatedQuestions": ["28"],
        "category": "Pharmacokinetics",
        "difficulty": "Medium"
    },
    {
        "id": 30,
        "question": "One of the following effectors controlled by G-proteins is incorrectly matched with its secondary messenger",
        "options": [
            "Adenylate cyclase (AC) / cAMP",
            "Phospholipase A / inositol trisphosphate (IP3) / diacylglycerol (DAG)",
            "Phospholipase C / inositol trisphosphate (IP3) / diacylglycerol (DAG)",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Phospholipase A / inositol trisphosphate (IP3) / diacylglycerol (DAG)",
        "explanation": "PLC (Gq) produces IP3/DAG; PLA2 produces arachidonic acid (prostaglandins).",
        "whyNotOtherOptions": {
            "a": "Gs/Gi on AC.",
            "c": "Correct for PLC."
        },
        "relatedQuestions": ["31"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard"
    },
    {
        "id": 31,
        "question": "Which of the following is incorrect about receptors",
        "options": [
            "Receptors are components of a cell that serve as sensing elements of hormones and neurotransmitters",
            "Receptors are components of a cell designed for interaction with a drug to initiate the chain of events leading to the drugs observed effects",
            "The response obtained at a given receptor remains the same in spite of the difference in the type of agonists",
            "Receptors for which no ligand has been discovered but they have a similar structure to other identified receptors are called orphan receptors",
            "None of the above"
        ],
        "answer": 2,
        "correctAnswer": "The response obtained at a given receptor remains the same in spite of the difference in the type of agonists",
        "explanation": "Different agonists (full/partial) at same receptor produce different maximal responses due to varying efficacy.",
        "whyNotOtherOptions": {
            "a": "Correct.",
            "b": "Correct.",
            "d": "Orphan receptors definition."
        },
        "relatedQuestions": ["32", "4"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium"
    },
    {
        "id": 32,
        "question": "All of the following receptors are ligand gated ion channels except",
        "options": [
            "Muscarinic acetylcholine receptor",
            "Gamma-aminobutyric acid type A (GABA-A) receptor",
            "5-hydroxytryptamine type 3 (5-HT3) receptors",
            "None of the above"
        ],
        "answer": 0,
        "correctAnswer": "Muscarinic acetylcholine receptor",
        "explanation": "Muscarinic = GPCR (metabotropic); GABA-A, nACh, 5-HT3 = ionotropic ligand-gated channels.",
        "whyNotOtherOptions": {
            "b": "Ionotropic.",
            "c": "Ionotropic."
        },
        "relatedQuestions": ["30"],
        "category": "Pharmacodynamics",
        "difficulty": "Easy"
    },
    {
        "id": 33,
        "question": "Which of the following statement is incorrect about adverse drug reaction (ADR)",
        "options": [
            "Carcinogenic and teratogenic effects of a drug are dose independent",
            "Idiosyncrasy reaction is an extension of the pharmacological activity of the drug",
            "Hypersensitivity reactions are dose unrelated and often unpredictable",
            "Overdosage toxicity is a direct extension of the drugs pharmacological action and is predictable",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Idiosyncrasy reaction is an extension of the pharmacological activity of the drug",
        "explanation": "Idiosyncrasy = genetically determined abnormal response, not pharmacologic extension (Type B ADR); overdosage = Type A.",
        "whyNotOtherOptions": {
            "a": "Type B, unpredictable.",
            "c": "Type B.",
            "d": "Type A."
        },
        "relatedQuestions": ["51", "55"],
        "category": "Adverse Effects",
        "difficulty": "Medium"
    },
    {
        "id": 34,
        "question": "From the following statements, select the wrong statement about spare receptor",
        "options": [
            "Spare receptors allow maximal response without total receptor occupancy",
            "Economy of hormone or neurotransmitter secretion is achieved at the expense of spare receptors",
            "Spare receptors increase selectivity of the agonists",
            "Spare receptors prevent an exaggerated response if too much ligand is present"
        ],
        "answer": 2,
        "correctAnswer": "Spare receptors increase selectivity of the agonists",
        "explanation": "Spare receptors (receptor reserve) allow max response with partial occupancy (high potency systems); no direct role in selectivity (affinity-related).",
        "whyNotOtherOptions": {
            "a": "Definition.",
            "b": "Less ligand needed.",
            "d": "Buffer against excess."
        },
        "relatedQuestions": ["16"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard"
    },
    {
        "id": 35,
        "question": "The route of drug administration devoid of the process of absorption is/are",
        "options": [
            "Oral route",
            "Intravenous route",
            "Subcutaneous route",
            "Intramuscular route",
            "All except A"
        ],
        "answer": 4,
        "correctAnswer": "All except A",
        "explanation": "IV injects directly into blood; no absorption barrier. Oral/SC/IM require absorption from GI/depot to blood.",
        "whyNotOtherOptions": {
            "b": "IV no absorption.",
            "c": "SC absorption.",
            "d": "IM absorption."
        },
        "relatedQuestions": ["11", "1"],
        "category": "Pharmacokinetics",
        "difficulty": "Easy"
    },
    {
        "id": 36,
        "question": "Which of the following is incorrect about inverse-agonist",
        "options": [
            "Inverse-agonist induces a pharmacological response opposite to that of the agonist",
            "The effect of inverse-agonist can be blocked by antagonists",
            "An inverse agonist binds to the same receptor as an agonist",
            "Inverse-agonist initiate the same chain of events like agonist that leads to the observed effects",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Inverse-agonist initiate the same chain of events like agonist that leads to the observed effects",
        "explanation": "Inverse agonists reduce constitutive activity (opposite direction); bind same site but stabilize inactive conformation, not same signaling chain.",
        "whyNotOtherOptions": {
            "a": "Definition.",
            "b": "Competitive inverse blocked by neutral antagonist.",
            "c": "Same receptor."
        },
        "relatedQuestions": ["16"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard"
    },
    {
        "id": 37,
        "question": "The remarkably powerful and specific activity of antimicrobial drugs is due to all of the following except",
        "options": [
            "their selectivity for targets that are unique to microorganisms (MO)",
            "their selectivity for targets that are much more important in MO than in humans",
            "their selectivity for targets that are unique to humans",
            "their selectivity for targets that are present in both MO and humans but show exploitable differences"
        ],
        "answer": 2,
        "correctAnswer": "their selectivity for targets that are unique to humans",
        "explanation": "Antimicrobials target bacterial/fungal/parasitic structures/processes absent or different in humans (e.g., cell wall, folate synthesis).",
        "whyNotOtherOptions": {
            "a": "e.g., peptidoglycan.",
            "b": "e.g., ribosomes.",
            "d": "e.g., bacterial vs human DNA gyrase."
        },
        "relatedQuestions": ["38", "42"],
        "category": "Antimicrobials",
        "difficulty": "Easy"
    },
    {
        "id": 38,
        "question": "Which of the following problems arise with the use of antimicrobials",
        "options": [
            "Acquired resistance",
            "Nutritional deficiency",
            "Super-infection",
            "All of the above",
            "A and C only"
        ],
        "answer": 4,
        "correctAnswer": "A and C only",
        "explanation": "Resistance and superinfection (e.g., C. difficile, candidiasis) common; nutritional deficiency not typical (except rare gut flora disruption).",
        "whyNotOtherOptions": {
            "b": "Not standard.",
            "d": "Includes b."
        },
        "relatedQuestions": ["41", "59"],
        "category": "Antimicrobials",
        "difficulty": "Medium"
    },
    {
        "id": 39,
        "question": "Which of the following pair of antibiotics are contraindicated due to their opposite mode of action",
        "options": [
            "Cell wall synthesis inhibitors / protein synthesis inhibitors",
            "Nucleic acid synthesis inhibitors / protein synthesis inhibitors",
            "Nucleic acid synthesis inhibitors / antimetabolites",
            "Protein synthesis inhibitors / antimetabolites",
            "None of the above"
        ],
        "answer": 4,
        "correctAnswer": "None of the above",
        "explanation": "Bacteriostatic (protein synthesis) + bactericidal (cell wall) often synergistic if static allows wall targeting; no absolute contraindication for listed pairs.",
        "whyNotOtherOptions": {
            "a": "Penicillin + tetracycline sometimes avoided but not absolute."
        },
        "relatedQuestions": ["42"],
        "category": "Antimicrobials",
        "difficulty": "Medium"
    },
    {
        "id": 40,
        "question": "Microorganisms develop resistance against antimicrobial agents through all of the following mechanisms except",
        "options": [
            "Blocking entry of antimicrobials",
            "Enzymatic alteration",
            "Efflux pump of antimicrobial agents",
            "Loss of cell wall",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Loss of cell wall",
        "explanation": "Resistance: reduced permeability, enzyme inactivation (Î²-lactamase), efflux, target alteration; cell wall loss would increase susceptibility to wall inhibitors.",
        "whyNotOtherOptions": {
            "a": "Porin mutation.",
            "b": "Common.",
            "c": "Pumps."
        },
        "relatedQuestions": ["41"],
        "category": "Antimicrobials",
        "difficulty": "Medium"
    },
    {
        "id": 41,
        "question": "All of the following factors promote antimicrobial resistance except",
        "options": [
            "Use of antibiotics for treatment of viral infection",
            "Lack of hygiene in hospitals",
            "Exposure to sub-therapeutic levels of antimicrobial",
            "Antibiotics combination therapy",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Antibiotics combination therapy",
        "explanation": "Combination reduces resistance emergence (multiple targets); others select resistant strains.",
        "whyNotOtherOptions": {
            "a": "Unnecessary use.",
            "b": "Nosocomial spread.",
            "c": "Incomplete courses."
        },
        "relatedQuestions": ["40", "42"],
        "category": "Antimicrobials",
        "difficulty": "Easy"
    },
    {
        "id": 42,
        "question": "Select the wrong statement among the following",
        "options": [
            "Bactericidal agents preferred to bacteriostatic when host defenses are impaired",
            "Bacteriostatic agents are preferred to bactericidal for treatment of meningitis",
            "Bacteriostatic and bactericidal combination is not advisable",
            "Most mitochondrial protein synthesis is more prone to antimicrobial protein synthesis inhibitors than its own protein synthesis",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Most mitochondrial protein synthesis is more prone to antimicrobial protein synthesis inhibitors than its own protein synthesis",
        "explanation": "Mitochondrial ribosomes resemble bacterial; inhibited by some antibacterials (e.g., linezolid, chloramphenicol toxicity), but statement misphrased/wrong priority.",
        "whyNotOtherOptions": {
            "a": "Correct (immunocompromised).",
            "b": "Bactericidal for CNS (penetration/kill).",
            "c": "Sometimes avoided but not absolute."
        },
        "relatedQuestions": ["39", "56"],
        "category": "Antimicrobials",
        "difficulty": "Hard"
    },
    {
        "id": 43,
        "question": "All of the following are examples of useful drug interaction except:",
        "options": [
            "The use of a Î²2 agonist with a glucocorticoid in the treatment of asthma",
            "The use of anti-platelet drug with a fibrinolytic in treating myocardial infarction",
            "The use of isoniazid and pyridoxine combination to reduce risk of peripheral neuropathy",
            "Concurrent use of antihypertensive and non-steroidal anti-inflammatory drugs",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Concurrent use of antihypertensive and non-steroidal anti-inflammatory drugs",
        "explanation": "NSAIDs reduce antihypertensive efficacy (prostaglandin inhibition, sodium retention); harmful interaction.",
        "whyNotOtherOptions": {
            "a": "Synergistic.",
            "b": "Synergistic thrombolysis.",
            "c": "Preventive."
        },
        "relatedQuestions": ["15"],
        "category": "Drug Interactions",
        "difficulty": "Medium"
    },
    {
        "id": 44,
        "question": "One of the following anti-cancer drug is cell cycle nonspecific (CCNS)",
        "options": [
            "Doxorubicin",
            "Taxol",
            "Vincristine",
            "Cyclophosphamide",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Cyclophosphamide",
        "explanation": "Alkylating agents (cyclophosphamide) act on DNA anytime; CCNS. Anthracyclines, vinca, taxanes CCS.",
        "whyNotOtherOptions": {
            "a": "G2.",
            "b": "M.",
            "c": "M."
        },
        "relatedQuestions": ["45", "48"],
        "category": "Antineoplastics",
        "difficulty": "Medium"
    },
    {
        "id": 45,
        "question": "Which of the following is incorrect about cytotoxic antibiotics",
        "options": [
            "Doxorubicin prevent topoisomerase II activity through DNA intercalation",
            "Dactinomycin interfere with the movement of DNA polymerase through intercalation in the minor grooves of DNA",
            "Bleomycins are group of metal chelating glycopeptide antibiotics that degrade preformed DNA",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Dactinomycin interfere with the movement of DNA polymerase through intercalation in the minor grooves of DNA",
        "explanation": "Dactinomycin (actinomycin D) intercalates GC-rich regions, inhibits transcription (RNA polymerase); not minor groove or primarily DNA polymerase.",
        "whyNotOtherOptions": {
            "a": "Topo II poison.",
            "c": "Fe-dependent DNA cleavage."
        },
        "relatedQuestions": ["44"],
        "category": "Antineoplastics",
        "difficulty": "Hard"
    },
    {
        "id": 46,
        "question": "One of the following is incorrect about monoclonal antibodies",
        "options": [
            "The binding of monoclonal antibodies to its target causes the death of cancer cells through complement mediated lysis",
            "Attachment of the monoclonal antibodies to target inactivate growth factor receptors on cancer cells",
            "Rituximab, a monoclonal antibody, sensitizes cancer cells to chemotherapeutic drugs",
            "The binding of rituximab to the calcium channel forming CD20 protein of cancer cells activate complement system",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "The binding of rituximab to the calcium channel forming CD20 protein of cancer cells activate complement system",
        "explanation": "CD20 is not a calcium channel (tetraspanin signaling); rituximab binds CD20, triggers ADCC, complement, apoptosis; no Ca channel role.",
        "whyNotOtherOptions": {
            "a": "CDC.",
            "b": "e.g., trastuzumab HER2.",
            "c": "Sensitization known."
        },
        "relatedQuestions": ["49"],
        "category": "Antineoplastics",
        "difficulty": "Hard"
    },
    {
        "id": 47,
        "question": "Select the wrong statement about hormones use for treatment of cancer",
        "options": [
            "Prednisolone is used in the treatment of leukemias and lymphomas",
            "Estrogen inhibit the growth of prostatic tissue by blocking the production of LH",
            "Flutamide and bicalutamide are used to treat breast tumor",
            "Ethinylestradiol is clinically used in the palliative treatment of androgen dependent prostate tumor",
            "None of the above"
        ],
        "answer": 2,
        "correctAnswer": "Flutamide and bicalutamide are used to treat breast tumor",
        "explanation": "Flutamide/bicalutamide = androgen receptor antagonists for prostate cancer; breast uses tamoxifen/SERM or aromatase inhibitors.",
        "whyNotOtherOptions": {
            "a": "Glucocorticoid apoptosis.",
            "b": "Negative feedback.",
            "d": "High-dose estrogen palliative."
        },
        "relatedQuestions": ["48"],
        "category": "Antineoplastics",
        "difficulty": "Medium"
    },
    {
        "id": 48,
        "question": "One of the following anticancer drugs inhibit folate reductase enzyme",
        "options": [
            "Methotrexate",
            "Tamoxifen",
            "Cyclophosphamide",
            "Doxorubicin"
        ],
        "answer": 0,
        "correctAnswer": "Methotrexate",
        "explanation": "Methotrexate = DHFR inhibitor, blocks folate metabolism, DNA synthesis.",
        "whyNotOtherOptions": {
            "b": "SERM.",
            "c": "Alkylator.",
            "d": "Anthracycline."
        },
        "relatedQuestions": ["44"],
        "category": "Antineoplastics",
        "difficulty": "Easy"
    },
    {
        "id": 49,
        "question": "Which of the following anticancer drug binds to tubulin and inhibits its polymerization into microtubule",
        "options": [
            "Vincristine",
            "Cyproterone",
            "Taxol",
            "Rituximab"
        ],
        "answer": 0,
        "correctAnswer": "Vincristine",
        "explanation": "Vinca alkaloids (vincristine) bind tubulin, prevent polymerization, mitotic arrest.",
        "whyNotOtherOptions": {
            "c": "Taxol stabilizes polymers.",
            "b": "Antiandrogen.",
            "d": "mAb."
        },
        "relatedQuestions": ["44"],
        "category": "Antineoplastics",
        "difficulty": "Medium"
    },
    {
        "id": 50,
        "question": "Which of the following drugs is used for treatment of acute lymphoblastic leukemia by catalyzing the breakdown of asparagine to aspartic acid and ammonia",
        "options": [
            "Vincristine",
            "Crisantaspase",
            "Bleomycin",
            "Rituximab",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Crisantaspase",
        "explanation": "Crisantaspase (asparaginase) depletes asparagine, starving leukemia cells (lack synthetase).",
        "whyNotOtherOptions": {
            "a": "Vinca.",
            "c": "Antibiotic.",
            "d": "mAb."
        },
        "relatedQuestions": ["48"],
        "category": "Antineoplastics",
        "difficulty": "Medium"
    },
    {
        "id": 51,
        "question": "One of the following reactions is not an idiosyncratic reaction",
        "options": [
            "Serious hemolytic anemia when an antimalarial primaquine is used by black males",
            "Peripheral neuropathy when INH is used by slow acetylators",
            "Resistance to the anticoagulant action of warfarin due to an alteration in the vitamin K epoxide reductase of an individual",
            "Anaphylactic shock when penicillin is used by some hypersensitive individuals",
            "None of the above"
        ],
        "answer": 2,
        "correctAnswer": "Resistance to the anticoagulant action of warfarin due to an alteration in the vitamin K epoxide reductase of an individual",
        "explanation": "Warfarin resistance = pharmacogenetic variant in target (VKOR), predictable dose-response shift; others unpredictable/genetic enzyme deficiencies or immune.",
        "whyNotOtherOptions": {
            "a": "G6PD deficiency.",
            "b": "NAT2 slow.",
            "d": "Type I hypersensitivity."
        },
        "relatedQuestions": ["33", "55"],
        "category": "Adverse Effects",
        "difficulty": "Hard"
    },
    {
        "id": 52,
        "question": "One of the following pharmacodynamic parameter cannot be measured from quantal dose response curve",
        "options": [
            "Efficacy",
            "Potency",
            "LD50",
            "Therapeutic index",
            "None of the above"
        ],
        "answer": 0,
        "correctAnswer": "Efficacy",
        "explanation": "Quantal = % population responding vs dose; gives ED50, LD50, TI, potency; efficacy (max effect) requires graded curve.",
        "whyNotOtherOptions": {
            "b": "ED50.",
            "c": "From toxicity curve.",
            "d": "LD50/ED50."
        },
        "relatedQuestions": ["9", "54"],
        "category": "Pharmacodynamics",
        "difficulty": "Hard"
    },
    {
        "id": 53,
        "question": "Select the wrong statement among the following",
        "options": [
            "In the presence of a full agonist, a partial agonist acts as an inhibitor",
            "Antagonists have affinity but no intrinsic activity",
            "Competitive antagonists increase the ED50 of agonists",
            "Noncompetitive antagonist binds to a site other than the active site but only when agonist is bound",
            "None of the above"
        ],
        "answer": 3,
        "correctAnswer": "Noncompetitive antagonist binds to a site other than the active site but only when agonist is bound",
        "explanation": "Noncompetitive bind allosteric site independently of agonist; reduce max response.",
        "whyNotOtherOptions": {
            "a": "Partial competes, lowers response.",
            "b": "Definition.",
            "c": "Right shift."
        },
        "relatedQuestions": ["7", "16"],
        "category": "Pharmacodynamics",
        "difficulty": "Medium"
    },
    {
    "id": 54,
    "question": "The predefined data obtained for two drugs (A and B) acting on the same receptor and by the same mechanism of action is presented in the following table. Based on the given data answer the following question:\n\n| Drug | LDâ‚…â‚€ (mg) | EDâ‚…â‚€ (mg) | Dose producing maximum effect (mg) | VDL1 |\n|------|-----------|------------|-------------------------------------|------|\n| A    | 5500      | 250        | 500                                 | 20   |\n| B    | 5500      | 500        | 750                                 | 50   |",
    "options": [
        "Drug A has higher therapeutic index and better tissue distribution",
        "Drug B is safer but less potent than Drug A", 
        "Drug A is more potent but Drug B has better tissue distribution",
        "Both drugs have equal safety profiles and efficacy",
        "Drug B is more efficacious and has a wider therapeutic index"
    ],
    "answer": 2,
    "correctAnswer": "Drug A is more potent but Drug B has better tissue distribution",
    "explanation": "**Therapeutic Index Calculation:**  \nDrug A: 5500/250 = 22  \nDrug B: 5500/500 = 11  \n\n**Analysis:**  \n- Drug A has lower EDâ‚…â‚€ (250 mg vs 500 mg) â†’ **more potent**  \n- Drug A has higher therapeutic index (22 vs 11) â†’ **safer**  \n- Drug B has higher VDL1 (50 vs 20) â†’ **better tissue distribution**",
    "whyNotOtherOptions": {
        "a": "Drug A has better therapeutic index but worse tissue distribution (lower VDL1)",
        "b": "Drug A is safer (higher TI: 22 vs 11) and more potent (lower EDâ‚…â‚€)",
        "d": "Drugs have different safety (TI: 22 vs 11) and distribution profiles",
        "e": "Drug B has lower therapeutic index (11 vs 22) and similar efficacy"
    },
    "relatedQuestions": ["55", "56"],
    "category": "Pharmacokinetics/Pharmacodynamics",
    "difficulty": "Medium"
  },
    {
        "id": 55,
        "question": "Which of the following adverse drug reactions precludes a patient from being rechallenged with that drug in the future?",
        "options": [
            "Idiosyncrasy from penicillin",
            "Stevens-Johnson syndrome from sulfamethoxazole-trimethoprim",
            "Gastrointestinal (GI) upset from clarithromycin",
            "Clostridium difficile superinfection from moxifloxacin"
        ],
        "answer": 1,
        "correctAnswer": "Stevens-Johnson syndrome from sulfamethoxazole-trimethoprim",
        "explanation": "SJS/TEN = life-threatening hypersensitivity; absolute contraindication to rechallenge. Others may allow cautious retry or alternatives.",
        "whyNotOtherOptions": {
            "a": "Depends on type; anaphylaxis yes.",
            "c": "Mild, manageable.",
            "d": "Treatable, not drug-specific."
        },
        "relatedQuestions": ["33", "51"],
        "category": "Adverse Effects",
        "difficulty": "Medium"
    },
    {
        "id": 56,
        "question": "Which of the following antibiotics exhibits a long postantibiotic effect that permits once-daily dosing?",
        "options": [
            "Gentamicin",
            "Penicillin G",
            "Vancomycin",
            "Azithromycin"
        ],
        "answer": 3,
        "correctAnswer": "Azithromycin",
        "explanation": "Azithromycin has prolonged PAE (>8h), tissue accumulation; once-daily despite short t1/2.",
        "whyNotOtherOptions": {
            "a": "Aminoglycoside PAE but q8-24h dosing.",
            "b": "Short PAE.",
            "c": "Minimal PAE."
        },
        "relatedQuestions": ["42", "59"],
        "category": "Antimicrobials",
        "difficulty": "Medium"
    },
    {
        "id": 57,
        "question": "A 24-year-old pregnant woman presents to the urgent care clinic with fever and urine frequency and urgency. She is diagnosed with a urinary tract infection (UTI). Based on potential harm to the fetus, which of the following medications should be avoided in treating her UTI?",
        "options": [
            "Nitrofurantoin",
            "Amoxicillin",
            "Cephalexin",
            "Doxycycline"
        ],
        "answer": 3,
        "correctAnswer": "Doxycycline",
        "explanation": "Tetracyclines (doxycycline) category D; teratogenic (teeth/bone). Others safe in pregnancy for UTI.",
        "whyNotOtherOptions": {
            "a": "Safe except 3rd trimester.",
            "b": "Category B.",
            "c": "Category B."
        },
        "relatedQuestions": ["58"],
        "category": "Antimicrobials",
        "difficulty": "Easy"
    },
    {
        "id": 58,
        "question": "Which of the following agents is considered a narrow spectrum antibiotic?",
        "options": [
            "Ceftriaxone",
            "Ciprofloxacin",
            "Isoniazid",
            "Imipenem"
        ],
        "answer": 2,
        "correctAnswer": "Isoniazid",
        "explanation": "Isoniazid = mycobacteria only (narrow). Others broad (3rd gen ceph, fluoroquinolone, carbapenem).",
        "whyNotOtherOptions": {
            "a": "Broad G+ / G-.",
            "b": "Broad.",
            "d": "Very broad."
        },
        "relatedQuestions": ["59"],
        "category": "Antimicrobials",
        "difficulty": "Easy"
    },
    {
        "id": 59,
        "question": "Which types of antibiotics predispose patients to super infection?",
        "options": [
            "Narrow spectrum antibiotics",
            "Broad spectrum antibiotics",
            "Extended spectrum antibiotics",
            "All"
        ],
        "answer": 1,
        "correctAnswer": "Broad spectrum antibiotics",
        "explanation": "Broad disrupt normal flora widely, allowing resistant/opportunistic overgrowth (e.g., C. diff, Candida).",
        "whyNotOtherOptions": {
            "a": "Spare flora.",
            "c": "Subset of broad."
        },
        "relatedQuestions": ["38", "56"],
        "category": "Antimicrobials",
        "difficulty": "Medium"
    },
    {
        "id": 60,
        "question": "When evaluating drug therapy for meningitis, which of the following factors is expected have the LEAST influence on the penetration and concentration of an antibacterial agent the cerebrospinal fluid?",
        "options": [
            "Lipid solubility of the drug",
            "Minimum inhibitory concentration of the drug",
            "Protein binding of the drug",
            "Molecular weight of the drug"
        ],
        "answer": 1,
        "correctAnswer": "Minimum inhibitory concentration of the drug",
        "explanation": "MIC = susceptibility measure post-penetration; BBB crossing depends on lipophilicity, low MW (<400-600), low protein binding. Inflamed meninges aid.",
        "whyNotOtherOptions": {
            "a": "Key for passive diffusion.",
            "c": "Only free drug crosses.",
            "d": "Size restriction."
        },
        "relatedQuestions": ["42"],
        "category": "Antimicrobials",
        "difficulty": "Medium"
    }
]

;

// Core application variables
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const categoriesGrid = document.getElementById('categoriesGrid');
const themeToggle = document.getElementById('themeToggle');
const quizContainer = document.getElementById('quizContainer');
const resultsScreen = document.getElementById('resultsScreen');
const pageTitle = document.getElementById('pageTitle');
const modeButtons = document.querySelectorAll('.mode-btn');
const correctAnswersEl = document.getElementById('correctAnswers');
const timeSpentEl = document.getElementById('timeSpent');
const masteryLevelEl = document.getElementById('masteryLevel');
const streakCountEl = document.getElementById('streakCount');
const searchInput = document.getElementById('searchInput');
const exportProgressBtn = document.getElementById('exportProgress');
const createCustomQuizBtn = document.getElementById('createCustomQuizBtn');
const customQuizModal = document.getElementById('customQuizModal');
const cancelCustomQuizBtn = document.getElementById('cancelCustomQuiz');
const createCustomQuizBtnModal = document.getElementById('createCustomQuiz');
const weakAreasCountEl = document.getElementById('weakAreasCount');
const avgTimePerQuestionEl = document.getElementById('avgTimePerQuestion');
const improvementRateEl = document.getElementById('improvementRate');

// Navigation elements
const navItems = document.querySelectorAll('.nav-item');

// Application state
let currentMode = 'exam';
let selectedCategories = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let questions = [];
let incorrectQuestions = [];
let isAnswerChecked = false;
let bookmarkedQuestions = new Set();
let userProgress = {};
let userStats = {
    totalQuestions: 0,
    correctAnswers: 0,
    timeSpent: 0,
    masteryLevel: 0,
    streak: 0,
    lastActive: null,
    weeklyProgress: []
};
let timerInterval = null;
let startTime = null;
let remainingTime = 0;
let isCountdown = false;
let examCheckMode = 'immediate';
let examSubmitted = false;
let questionTimers = [];
let searchResults = [];
let isSearchActive = false;
let currentPage = 'Dashboard';
let customQuestions = [];

// Core application functions
function init() {
    initializeCategories();
    initializeEventListeners();
    initializeNavigation();
    loadUserData();
    updateDashboardStats();
    updateAnalytics();
    showDashboard();
    createFAB();
    updateCustomQuizModalHTML();
}

function createFAB() {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '<i class="fas fa-plus"></i>';
    fab.title = 'Create Custom Question';
    fab.addEventListener('click', showCustomQuestionCreator);
    document.body.appendChild(fab);
}

function initializeNavigation() {
    navItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            switch(index) {
                case 0: // Dashboard
                    currentPage = 'Dashboard';
                    showDashboard();
                    break;
                case 1: // My Courses
                    currentPage = 'courses';
                    showCourses();
                    break;
                case 2: // Progress Analytics
                    currentPage = 'analytics';
                    showAnalytics();
                    break;
                case 3: // Bookmarked Questions
                    currentPage = 'bookmarks';
                    showBookmarks();
                    break;
                case 4: // Settings
                    currentPage = 'settings';
                    showSettings();
                    break;
            }
            
            closeSidebar();
        });
    });
}

function showDashboard() {
    console.log('showDashboard called'); // Debug
    
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.search-container').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    
    // Reset page title
    pageTitle.textContent = 'Dashboard';
    updateDashboardStats();
    
    // ALWAYS load questions and show quiz layout
    questions = [...quizData, ...customQuestions];
    selectedCategories = [...new Set(questions.map(q => q.category))];
    
    // Reset quiz state
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    console.log('Questions loaded:', questions.length);
    console.log('Current mode:', currentMode);
    
    // Force show quiz container
    quizContainer.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    
    if (questions.length > 0) {
        console.log('Calling renderQuizLayout...');
        renderQuizLayout();
    } else {
        console.log('No questions, showing message');
        showNoQuestionsMessage();
    }
}

function showCourses() {
    hideAllSections();
    pageTitle.textContent = 'My Courses';
    
    quizContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Learning Pathways</h2>
            <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                Structured learning paths designed to build your medical knowledge systematically.
            </p>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 40px;">
                    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Anatomy Mastery', 'fas fa-brain', '#6366f1', 75, 'Build foundational anatomy knowledge')}
                    </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Physiology Deep Dive', 'fas fa-heartbeat', '#06b6d4', 45, 'Understand body systems and functions')}
                   </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Clinical Pathology', 'fas fa-virus', '#10b981', 30, 'Study diseases and diagnostics')}
                    </div> 
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Pharmacology', 'fas fa-pills', '#f59e0b', 20, 'Master drug mechanisms and effects')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Medical Imaging', 'fas fa-x-ray', '#8b5cf6', 15, 'Learn radiology and imaging techniques')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Emergency Medicine', 'fas fa-ambulance', '#ef4444', 10, 'Critical care and emergency procedures')}
                    </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createCourseCard(title, icon, color, progress, description) {
    return `
        <div class="category-card" style="text-align: left; cursor: pointer; border-left: 4px solid ${color};" onclick="startCourse('${title.toLowerCase()}')">
            <div class="category-header">
                <div class="category-icon" style="background: ${color}20; color: ${color};">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <div class="category-name" style="font-size: 16px; font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${description}</div>
                </div>
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${color}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                <span style="font-size: 11px; color: var(--text-tertiary);">${Math.floor(progress/10)}/10 Modules</span>
                <span style="font-size: 11px; color: ${color}; font-weight: 600;">Continue â†’</span>
            </div>
        </div>
    `;
}

function showAnalytics() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    pageTitle.textContent = 'Progress Analytics';
    updateAnalytics();
    
    quizContainer.innerHTML = `
        <div style="padding: 24px;">
            <div class="analytics-section glass-effect" style="border-radius: 24px; padding: 32px;">
                <h3 class="analytics-title" style="font-size: 24px; margin-bottom: 8px;">Performance Insights</h3>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">Detailed analytics to optimize your learning journey</p>
                <div class="analytics-grid">
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: var(--primary);">${weakAreasCountEl.textContent}</div>
                        <div class="analytics-label">Areas Needing Focus</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #06b6d4;">${avgTimePerQuestionEl.textContent}</div>
                        <div class="analytics-label">Average Response Time</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #10b981;">${improvementRateEl.textContent}</div>
                        <div class="analytics-label">Weekly Progress Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">ðŸ“Š Learning Recommendations</h3>
                <div style="display: grid; gap: 16px;">
                    ${createRecommendation('Focus on Weak Areas', 'fas fa-bullseye', 'var(--primary)', 'Spend 60% of study time on topics below 70% mastery')}
                    ${createRecommendation('Consistent Practice', 'fas fa-chart-line', '#10b981', `Maintain your ${userStats.streak}-day streak for optimal retention`)}
                    ${createRecommendation('Active Recall', 'fas fa-brain', '#8b5cf6', 'Use spaced repetition for better long-term memory')}
                    ${createRecommendation('Mixed Practice', 'fas fa-random', '#f59e0b', 'Combine different topics in single study sessions')}
                </div>
            </div>

            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">ðŸŽ¯ Study Plan</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    ${createStudyPlanItem('Daily Goal', '50 questions', 'fas fa-calendar-day', '#6366f1')}
                    ${createStudyPlanItem('Weekly Target', '5 hours', 'fas fa-chart-bar', '#06b6d4')}
                    ${createStudyPlanItem('Mastery Goal', '85% overall', 'fas fa-trophy', '#f59e0b')}
                    ${createStudyPlanItem('Weak Topics', '2 sessions/week', 'fas fa-exclamation-triangle', '#ef4444')}
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createRecommendation(title, icon, color, description) {
    return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border-left: 4px solid ${color};">
            <i class="${icon}" style="color: ${color}; font-size: 24px;"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${description}</div>
            </div>
        </div>
    `;
}

function createStudyPlanItem(title, value, icon, color) {
    return `
        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
            <i class="${icon}" style="color: ${color}; font-size: 32px; margin-bottom: 12px;"></i>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
            <div style="font-size: 18px; color: ${color}; font-weight: 700;">${value}</div>
        </div>
    `;
}

function showBookmarks() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    hideAllSections();
    pageTitle.textContent = 'Bookmarked Questions';
    
    if (bookmarkedQuestionsList.length === 0) {
        quizContainer.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 96px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                    <i class="far fa-bookmark"></i>
                </div>
                <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">No Bookmarked Questions Yet</h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                    Click the bookmark icon on any question to save it here for quick review. This is perfect for difficult concepts or important topics you want to revisit.
                </p>
                <button class="quiz-btn" onclick="showDashboard(); navItems[0].click()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 32px; border-radius: 16px;">
                    <i class="fas fa-arrow-left"></i>
                    Explore Questions
                </button>
            </div>
        `;
    } else {
        quizContainer.innerHTML = `
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                            ${bookmarkedQuestionsList.length} Saved Question${bookmarkedQuestionsList.length !== 1 ? 's' : ''}
                        </h2>
                        <p style="color: var(--text-secondary);">Your personal collection of important questions</p>
                    </div>
                    <button class="quiz-btn" onclick="startBookmarksQuiz()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px;">
                        <i class="fas fa-play"></i>
                        Practice Bookmarks
                    </button>
                </div>
                <div style="display: grid; gap: 20px;">
                    ${bookmarkedQuestionsList.map(question => `
                        <div class="question-card glass-effect" style="cursor: pointer; border-radius: 20px; padding: 24px;" onclick="jumpToBookmarkQuestion(${question.id})">
                            <div class="question-header">
                                <div class="question-meta">
                                    <div class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Q${question.id}</div>
                                    <div class="question-category glass-effect">${question.category}</div>
                                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                        ${question.difficulty}
                                    </div>
                                    ${question.custom ? '<div class="question-category glass-effect" style="background: #10b98120; color: #10b981;">Custom</div>' : ''}
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn bookmark-btn" onclick="event.stopPropagation(); toggleBookmark(${question.id}); showBookmarks();" aria-label="Remove Bookmark" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="question-text" style="font-size: 16px; line-height: 1.6;">${question.question}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    quizContainer.classList.remove('hidden');
}

// Add this function to handle clicking on individual bookmark questions
function jumpToBookmarkQuestion(questionId) {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    // Start a quiz with just this one question
    questions = [bookmarkedQuestionsList.find(q => q.id === questionId)];
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Question';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

function showSettings() {
    hideAllSections();
    pageTitle.textContent = 'Settings & Preferences';
    
    quizContainer.innerHTML = `
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ðŸŽ¨ Appearance</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Customize the look and feel of your study environment</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Theme</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? '' : 'active'}" onclick="setTheme('light')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-sun"></i>
                                Light Mode
                            </button>
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? 'active' : ''}" onclick="setTheme('dark')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-moon"></i>
                                Dark Mode
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Animation</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn active" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-bolt"></i>
                                Smooth
                            </button>
                            <button class="mode-btn" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-minus"></i>
                                Minimal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">âš¡ Study Preferences</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Optimize your learning experience</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Default Mode</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${currentMode === 'quiz' ? 'active' : ''}" onclick="setDefaultMode('quiz')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-tasks"></i>
                                Quiz
                            </button>
                            <button class="mode-btn ${currentMode === 'exam' ? 'active' : ''}" onclick="setDefaultMode('exam')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-file-alt"></i>
                                Exam
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Questions Per Session</label>
                        <select class="modern-dropdown" style="width: 100%;" onchange="setQuestionsPerSession(this.value)">
                            <option value="10">10 Questions</option>
                            <option value="25" selected>25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ðŸ“Š Data & Progress</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Manage your learning data</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="quiz-btn" onclick="exportProgress()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-download" style="margin-right: 12px;"></i>
                         
                    </button>
                    <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-plus" style="margin-right: 12px;"></i>
                        Create Custom Question
                    </button>
                    <button class="quiz-btn" onclick="resetProgress()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-trash" style="margin-right: 12px;"></i>
                        Reset All Progress
                    </button>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">â„¹ï¸ About ALIF</h3>
                <div style="color: var(--text-secondary); line-height: 1.7;">
                    <p>ALIF is an advanced medical education platform designed to help medical students and professionals enhance their knowledge through interactive quizzes and detailed analytics.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                        <div>
                            <strong style="color: var(--text-primary);">Version</strong>
                            <div>2.1.0</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Questions</strong>
                            <div>${quizData.length + customQuestions.length} total</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Last Updated</strong>
                            <div>${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function setTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-moon';
    }
    showNotification(`Theme set to ${theme} mode`, 'success');
}

function setDefaultMode(mode) {
    currentMode = mode;
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[mode === 'quiz' ? 1 : 0].classList.add('active');
    showNotification(`Default mode set to ${mode}`, 'success');
}

function setQuestionsPerSession(count) {
    showNotification(`Questions per session set to ${count === '0' ? 'all' : count}`, 'info');
}

function showCustomQuestionCreator() {
    const modal = document.createElement('div');
    modal.className = 'custom-quiz-modal active';
    modal.innerHTML = `
        <div class="custom-quiz-content glass-effect" style="max-width: 600px; border-radius: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Create Custom Question</h3>
                <button class="action-btn" onclick="closeCustomQuestionModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-question-creator">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Question Text (Markdown supported for tables)</label>
                        <textarea id="customQuestionText" placeholder="Enter your question here... Use Markdown for tables, e.g., | Col1 | Col2 |" style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 100px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Image URL (optional)</label>
                        <input type="url" id="customImageUrl" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Category</label>
                        <select id="customQuestionCategory" class="modern-dropdown" style="width: 100%;">
                            <option value="Custom Anatomy">Custom Anatomy</option>
                            <option value="Custom Physiology">Custom Physiology</option>
                            <option value="Custom Pathology">Custom Pathology</option>
                            <option value="Custom Pharmacology">Custom Pharmacology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Difficulty</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button type="button" class="mode-btn difficulty-btn active" data-difficulty="Easy" style="border-radius: 12px; padding: 12px 16px;">
                                Easy
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Medium" style="border-radius: 12px; padding: 12px 16px;">
                                Medium
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Hard" style="border-radius: 12px; padding: 12px 16px;">
                                Hard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Options</label>
                        <div style="display: grid; gap: 12px;">
                            ${['A', 'B', 'C', 'D'].map(letter => `
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">${letter}</div>
                                    <input type="text" id="customOption${letter}" placeholder="Option ${letter}" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text-primary);">
                                    <input type="radio" name="correctAnswer" value="${letter}" id="correct${letter}" style="transform: scale(1.2);">
                                    <label for="correct${letter}" style="color: var(--text-secondary); font-weight: 600;">Correct</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Explanation</label>
                        <textarea id="customExplanation" placeholder="Explain why the correct answer is right..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                </div>
                
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
                    <button class="quiz-btn" onclick="closeCustomQuestionModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        Cancel
                    </button>
                    <button class="quiz-btn check-btn" onclick="saveCustomQuestion()" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-save"></i>
                        Save Question
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add difficulty button handlers
    modal.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function closeCustomQuestionModal() {
    const modal = document.querySelector('.custom-quiz-modal');
    if (modal) {
        modal.remove();
    }
}

function saveCustomQuestion() {
    const questionText = document.getElementById('customQuestionText').value;
    const imageUrl = document.getElementById('customImageUrl').value || '';
    const category = document.getElementById('customQuestionCategory').value;
    const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    const explanation = document.getElementById('customExplanation').value;
    
    // Get options
    const options = [];
    for (let letter of ['A', 'B', 'C', 'D']) {
        const optionText = document.getElementById(`customOption${letter}`).value;
        if (optionText.trim()) {
            options.push(optionText);
        }
    }
    
    // Get correct answer
    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
    if (!correctAnswerRadio) {
        showNotification('Please select the correct answer', 'error');
        return;
    }
    
    const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerRadio.value);
    
    if (!questionText.trim() || options.length < 2) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Generate a unique ID for the custom question
    const maxId = Math.max(
        ...quizData.map(q => q.id),
        ...customQuestions.map(q => q.id),
        0
    );
    
    const newQuestion = {
        id: maxId + 1,
        question: questionText,
        options: options,
        answer: correctAnswerIndex,
        correctAnswer: options[correctAnswerIndex],
        explanation: explanation || 'No explanation provided.',
        whyNotOtherOptions: {},
        relatedQuestions: [],
        category: category,
        difficulty: difficulty,
        custom: true,
        image: imageUrl
    };
    
    customQuestions.push(newQuestion);
    saveUserData();
    
    closeCustomQuestionModal();
    showNotification('Custom question created successfully!', 'success');
    
    // Refresh the current view and categories
    initializeCategories();
    if (currentPage === 'Dashboard') {
        showDashboard();
    } else if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}

function hideAllSections() {
    quizContainer.classList.add('hidden');
    resultsScreen.classList.add('hidden');
    document.querySelector('.stats-grid').style.display = 'none';
    document.querySelector('.analytics-section').style.display = 'none';
    document.querySelector('.export-section').style.display = 'none';
    // Note: search-container is NOT hidden here - we want it always visible during search
}

function startCourse(courseName) {
    showNotification(`Starting ${courseName} course...`, 'info');
    // Filter questions by course/category and start quiz
    const courseQuestions = [...quizData, ...customQuestions].filter(q => 
        q.category.toLowerCase().includes(courseName.toLowerCase())
    );
    
    if (courseQuestions.length === 0) {
        showNotification('No questions available for this course yet', 'info');
        return;
    }
    
    questions = courseQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active');
    pageTitle.textContent = `Quiz Mode - ${courseName}`;
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

// FIXED BOOKMARK PRACTICE FUNCTION
function startBookmarksQuiz() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    if (bookmarkedQuestionsList.length === 0) {
        showNotification('No bookmarked questions to practice!', 'error');
        return;
    }
    
    questions = bookmarkedQuestionsList;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Questions';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    
    showNotification(`Starting practice with ${questions.length} bookmarked questions`, 'success');
}

function resetProgress() {
    if (confirm('Are you sure you want to reset all your progress? This action cannot be undone.')) {
        userProgress = {};
        userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: new Date().toISOString(),
            weeklyProgress: []
        };
        bookmarkedQuestions = new Set();
        customQuestions = [];
        saveUserData();
        updateDashboardStats();
        updateAnalytics();
        showNotification('All progress has been reset', 'success');
        showDashboard();
    }
}

function initializeEventListeners() {
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
            pageTitle.textContent = `${btn.dataset.mode.charAt(0).toUpperCase() + btn.dataset.mode.slice(1)} Mode`;
            startQuiz();
        });
    });
    
    initializeEnhancedFeatures();
    document.getElementById('backBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // Use browser back navigation
        window.history.back();
    });
}
function updateBackButton() {
    const backBtn = document.getElementById('backBtn');
    // Show back button if there's history to go back to
    if (window.history.length > 1) {
        backBtn.style.display = 'flex';
    } else {
        backBtn.style.display = 'none';
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    mainContent.classList.toggle('sidebar-open');
    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
    document.body.style.overflow = '';
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

function initializeEnhancedFeatures() {
    initializeSearch();
    initializeKeyboardNavigation();
    enhanceAccessibility();
    
    exportProgressBtn.addEventListener('click', exportProgress);
    createCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.add('active');
    });
    cancelCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.remove('active');
    });
    createCustomQuizBtnModal.addEventListener('click', () => {
        const selectedOptions = document.querySelectorAll('.custom-quiz-option.selected');
        const options = {
            categories: selectedCategories,
            difficulty: null,
            bookmarkedOnly: false
        };
        
        selectedOptions.forEach(option => {
            const category = option.dataset.category;
            if (category === 'easy' || category === 'medium' || category === 'hard') {
                options.difficulty = category;
            } else if (category === 'bookmarked') {
                options.bookmarkedOnly = true;
            }
        });
        
        createCustomQuiz(options);
    });
    
    // Add selection toggling for custom quiz options
    document.addEventListener('click', (e) => {
        if (e.target.closest('.custom-quiz-option')) {
            const option = e.target.closest('.custom-quiz-option');
            option.classList.toggle('selected');
        }
    });
    
    // Ensure search works when clicking Dashboard
    navItems[0].addEventListener('click', () => {
        if (searchInput.value.trim().length > 0) {
            // If there's a search query, maintain search state
            isSearchActive = true;
        }
    });
}

// FIXED SEARCH FUNCTIONALITY
function initializeSearch() {
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            // Clear previous search state when input is empty
            if (query.length === 0) {
                document.body.classList.remove('search-blur-active');
                isSearchActive = false;
                if (currentPage === 'Dashboard') {
                    showDashboard();
                }
                return;
            }
            
            // Add blur effect when searching
            document.body.classList.add('search-blur-active');
            
            if (query.length < 2) {
                isSearchActive = false;
                return;
            }
            
            isSearchActive = true;
            performSearch(query);
        });
        
        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    }
}

function performSearch(query) {
    const allQuestions = [...quizData, ...customQuestions];
    searchResults = allQuestions.filter(q => 
        q.question.toLowerCase().includes(query) ||
        q.category.toLowerCase().includes(query) ||
        (q.explanation && q.explanation.toLowerCase().includes(query)) ||
        q.options.some(opt => opt.toLowerCase().includes(query))
    );
    
    console.log('Search query:', query, 'Results:', searchResults.length); // Debug log
    
    if (searchResults.length > 0) {
        // Show search results in quiz layout
        questions = searchResults;
        currentQuestionIndex = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        
        hideAllSections();
        quizContainer.classList.remove('hidden');
        renderQuizLayout();
        
        // Update page title to show search context
        pageTitle.textContent = `Search: "${query}" (${searchResults.length} results)`;
        
        // Highlight search terms
        setTimeout(() => {
            highlightSearchTerms(query);
        }, 100);
    } else {
        // Show no results message
        showSearchNoResults(query);
    }
}

function showSearchNoResults(query) {
    hideAllSections();
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-search"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Results Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                No questions match your search for "<strong style="color: var(--primary);">${query}</strong>". Try different keywords or browse categories.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Clear Search
                </button>
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Browse Categories
                </button>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
    pageTitle.textContent = `Search: "${query}" (0 results)`;
}

function clearSearch() {
    searchInput.value = '';
    document.body.classList.remove('search-blur-active');
    isSearchActive = false;
    showDashboard();
}

function highlightSearchTerms(query) {
    const questionTexts = document.querySelectorAll('.question-text');
    const optionTexts = document.querySelectorAll('.option-text');
    const categoryElements = document.querySelectorAll('.question-category');
    
    const highlightText = (element) => {
        const originalText = element.innerHTML;  // Use innerHTML to preserve Markdown
        const regex = new RegExp(`(${query})`, 'gi');
        const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
        element.innerHTML = highlighted;
    };
    
    questionTexts.forEach(highlightText);
    optionTexts.forEach(highlightText);
    categoryElements.forEach(highlightText);
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                navigateOptions(e.key === 'ArrowDown' ? 1 : -1);
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option:not(.disabled)');
                if (options[index]) {
                    options[index].click();
                }
                break;
            case 'Escape':
                if (document.querySelector('.custom-quiz-modal')) {
                    document.querySelector('.custom-quiz-modal').remove();
                }
                break;
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const currentIndex = Array.from(options).findIndex(opt => opt === document.activeElement);
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    options[nextIndex].focus();
}

function enhanceAccessibility() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('option')) {
            const options = e.target.parentElement.querySelectorAll('.option');
            options.forEach((opt, index) => {
                opt.setAttribute('aria-checked', opt.classList.contains('selected') ? 'true' : 'false');
                opt.setAttribute('role', 'radio');
                opt.setAttribute('tabindex', '0');
            });
        }
    });
}

function loadUserData() {
    const savedProgress = localStorage.getItem('mediQuizProgress');
    const savedStats = localStorage.getItem('mediQuizStats');
    const savedBookmarks = localStorage.getItem('mediQuizBookmarks');
    const savedCustomQuestions = localStorage.getItem('mediQuizCustomQuestions');
    
    if (savedProgress) {
        userProgress = JSON.parse(savedProgress);
    }
    if (savedStats) {
        userStats = JSON.parse(savedStats);
        const today = new Date().toDateString();
        const lastActive = new Date(userStats.lastActive).toDateString();
        if (lastActive !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastActive === yesterday.toDateString()) {
                userStats.streak++;
            } else {
                userStats.streak = 1;
            }
        }
    }
    if (savedBookmarks) {
        bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
    }
    if (savedCustomQuestions) {
        customQuestions = JSON.parse(savedCustomQuestions);
    }
    
    userStats.lastActive = new Date().toISOString();
    saveUserData();
}

function saveUserData() {
    localStorage.setItem('mediQuizProgress', JSON.stringify(userProgress));
    localStorage.setItem('mediQuizStats', JSON.stringify(userStats));
    localStorage.setItem('mediQuizBookmarks', JSON.stringify(Array.from(bookmarkedQuestions)));
    localStorage.setItem('mediQuizCustomQuestions', JSON.stringify(customQuestions));
}

function updateDashboardStats() {
    correctAnswersEl.textContent = userStats.correctAnswers;
    timeSpentEl.textContent = `${Math.floor(userStats.timeSpent / 60)}h ${userStats.timeSpent % 60}m`;
    masteryLevelEl.textContent = `${userStats.masteryLevel}%`;
    streakCountEl.textContent = userStats.streak;
}

function updateAnalytics() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => allQuestions.find(q => q.id == id)?.category)
        .reduce((acc, category) => {
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        
    weakAreasCountEl.textContent = Object.keys(weakAreas).length;
    
    const totalTime = userStats.timeSpent * 60;
    const avgTime = userStats.totalQuestions > 0 ? Math.round(totalTime / userStats.totalQuestions) : 0;
    avgTimePerQuestionEl.textContent = `${avgTime}s`;
    
    if (userStats.weeklyProgress.length > 1) {
        const latest = userStats.weeklyProgress[userStats.weeklyProgress.length - 1];
        const previous = userStats.weeklyProgress[userStats.weeklyProgress.length - 2];
        const improvement = ((latest - previous) / previous) * 100;
        improvementRateEl.textContent = `${Math.round(improvement)}%`;
    } else {
        improvementRateEl.textContent = "0%";
    }
}

function exportProgress() {
    const data = {
        progress: userProgress,
        stats: userStats,
        bookmarks: Array.from(bookmarkedQuestions),
        customQuestions: customQuestions,
        exportDate: new Date().toISOString(),
        analytics: generateStudyReport()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mediquiz-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Progress data exported successfully!', 'success');
}

function createCustomQuiz(options) {
    let filteredQuestions = [...quizData, ...customQuestions];
    
    if (options.categories && options.categories.length > 0) {
        filteredQuestions = filteredQuestions.filter(q => options.categories.includes(q.category));
    }
    
    if (options.difficulty) {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty.toLowerCase() === options.difficulty);
    }
    
    if (options.bookmarkedOnly) {
        filteredQuestions = filteredQuestions.filter(q => bookmarkedQuestions.has(q.id));
    }
    
    if (options.count && options.count > 0) {
        filteredQuestions = shuffleArray(filteredQuestions).slice(0, options.count);
    }
    
    questions = filteredQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    customQuizModal.classList.remove('active');
    showNotification(`Custom quiz created with ${questions.length} questions`, 'success');
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}


function generateStudyReport() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    const strongAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) >= 0.8)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    return {
        weakAreas,
        strongAreas,
        totalMastered: Object.values(userProgress).filter(p => p.correct >= 3).length,
        totalQuestions: allQuestions.length,
        masteryPercentage: calculateMasteryLevel(),
        generatedAt: new Date().toISOString()
    };
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 20px 28px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
        color: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
        max-width: 400px;
        line-height: 1.5;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="font-size: 20px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

function initializeCategories() {
    const allQuestions = [...quizData, ...customQuestions];
    const categories = [...new Set(allQuestions.map(q => q.category))];
    const categoryIcons = {
        "Anatomy Fundamentals": "fas fa-brain",
        "Neuroanatomy": "fas fa-brain",
        "Gastrointestinal System": "fas fa-stomach",
        "Cardiovascular System": "fas fa-heart",
        "Custom Anatomy": "fas fa-user-md",
        "Custom Physiology": "fas fa-heartbeat",
        "Custom Pathology": "fas fa-virus",
        "Custom Pharmacology": "fas fa-pills",
        "General Medicine": "fas fa-stethoscope"
    };
    
    const categoryColors = {
        "Anatomy Fundamentals": "#6366f1",
        "Neuroanatomy": "#06b6d4",
        "Gastrointestinal System": "#10b981",
        "Cardiovascular System": "#ef4444",
        "Custom Anatomy": "#8b5cf6",
        "Custom Physiology": "#f59e0b",
        "Custom Pathology": "#ec4899",
        "Custom Pharmacology": "#84cc16",
        "General Medicine": "#64748b"
    };

    categoriesGrid.innerHTML = '';
    categories.forEach(category => {
        const categoryQuestions = allQuestions.filter(q => q.category === category);
        const mastered = categoryQuestions.filter(q =>
            userProgress[q.id] && userProgress[q.id].correct >= 3
        ).length;
        const progress = categoryQuestions.length > 0 ?
            Math.round((mastered / categoryQuestions.length) * 100) : 0;
            
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card active glass-effect';
        categoryCard.dataset.category = category;
        categoryCard.style.borderLeft = `4px solid ${categoryColors[category] || '#6366f1'}`;
        categoryCard.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background: ${categoryColors[category] || '#6366f1'}20; color: ${categoryColors[category] || '#6366f1'}">
                    <i class="${categoryIcons[category] || 'fas fa-question'}"></i>
                </div>
                <div class="category-name">${category}</div>
                ${category.includes('Custom') ? '<div style="font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 8px;">Custom</div>' : ''}
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${categoryColors[category] || '#6366f1'}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${categoryQuestions.length} question${categoryQuestions.length !== 1 ? 's' : ''}
                ${categoryQuestions.filter(q => q.custom).length > 0 ? ` Â· ${categoryQuestions.filter(q => q.custom).length} custom` : ''}
            </div>
        `;
        
        if (categoryQuestions.length > 1) {
            const dropdown = document.createElement('div');
            dropdown.className = 'modern-dropdown';
            dropdown.innerHTML = `
                <select onchange="jumpToQuestion(this.value)">
                    <option value="">Jump to Question...</option>
                    ${categoryQuestions.sort((a, b) => a.id - b.id).map(q => 
                        `<option value="question-${q.id}">Q${q.id}: ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}${q.custom ? ' â˜…' : ''}</option>`
                    ).join('')}
                </select>
            `;
            categoryCard.appendChild(dropdown);
        }
        
        categoryCard.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-dropdown') && !e.target.closest('select')) {
                toggleCategory(categoryCard);
                const firstQ = categoryQuestions.sort((a, b) => a.id - b.id)[0];
                if (firstQ) {
                    jumpToQuestion(`question-${firstQ.id}`);
                }
            }
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
    
    selectedCategories = [...categories];
}

function toggleCategory(categoryCard) {
    const category = categoryCard.dataset.category;
    if (categoryCard.classList.contains('active')) {
        categoryCard.classList.remove('active');
        selectedCategories = selectedCategories.filter(c => c !== category);
    } else {
        categoryCard.classList.add('active');
        selectedCategories.push(category);
    }
    startQuiz();
    closeSidebar();
}

function startQuiz() {
    if (currentPage !== 'Dashboard') return;
    
    quizContainer.style.opacity = '0';
    setTimeout(() => {
        const allQuestions = [...quizData, ...customQuestions];
        questions = selectedCategories.length > 0 ? 
            allQuestions.filter(q => selectedCategories.includes(q.category)) : 
            allQuestions;
            
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        if (currentMode === 'learn' && incorrectQuestions.length > 0) {
            questions = allQuestions.filter(q => incorrectQuestions.includes(q.id));
        }
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        questions.sort((a, b) => a.id - b.id);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        examSubmitted = false;
        quizContainer.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        questionTimers = new Array(questions.length).fill(0);
        if (currentMode === 'exam') {
            isCountdown = true;
            remainingTime = 120 * questions.length;
        } else {
            isCountdown = false;
        }
        startTimer();
        renderQuizLayout();
        quizContainer.style.opacity = '1';
    }, 300);
}

function showNoQuestionsMessage() {
    let message = '';
    if (isSearchActive) {
        message = 'No questions match your search criteria. Try different keywords.';
    } else if (selectedCategories.length === 0) {
        message = 'No categories selected. Please select categories from the sidebar.';
    } else {
        message = 'No questions available for the selected categories.';
    }
    
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Questions Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                ${message}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Select Categories
                </button>
                <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Question
                </button>
                ${isSearchActive ? `
                    <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    resultsScreen.classList.add('hidden');
    stopTimer();
    quizContainer.style.opacity = '1';
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    startTime = new Date();
    timerInterval = setInterval(() => {
        if (isCountdown) {
            remainingTime--;
            if (remainingTime <= 0) {
                remainingTime = 0;
                clearInterval(timerInterval);
                if (currentMode === 'exam' && !examSubmitted) {
                    showNotification('Time up! Submitting exam.', 'error');
                    submitExam();
                }
            }
            updateTimerDisplay(formatTime(remainingTime), 'timerDisplay', true);
        } else {
            questionTimers[currentQuestionIndex]++;
            updateTimerDisplay(formatTime(questionTimers[currentQuestionIndex]), 'timerDisplay', false);
        }
    }, 1000);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

function updateTimerDisplay(time, id, isCountdown = false) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Time: ${time}`;
        if (isCountdown) {
            el.classList.remove('timer-warning', 'timer-error');
            if (remainingTime <= 30) {
                el.classList.add('timer-error');
            } else if (remainingTime <= 60) {
                el.classList.add('timer-warning');
            }
        }
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        if (startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000 / 60);
            userStats.timeSpent += timeSpent;
            userStats.lastActive = new Date().toISOString();
            saveUserData();
            updateDashboardStats();
        }
    }
}

function renderQuizLayout() {
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    if (currentMode === 'exam') {
        renderExamLayout();
    } else {
        renderSingleQuestionLayout();
    }
}

function renderExamLayout() {
    const isImmediateMode = examCheckMode === 'immediate';
    quizContainer.innerHTML = `
        <div class="exam-header" style="margin-bottom: 24px; padding: 20px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Exam Mode: ${questions.length} Questions
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ${isImmediateMode ?
                          'Immediate Check - See explanations as you answer' :
                          'All-in-One Check - Check all answers at the end'}
                    </p>
                </div>
                <div class="exam-mode-toggle" style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: var(--radius);">
                    <button class="mode-toggle-btn ${isImmediateMode ? 'active' : ''}" data-mode="immediate" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="Immediate Check Mode">
                        Immediate Check
                    </button>
                    <button class="mode-toggle-btn ${!isImmediateMode ? 'active' : ''}" data-mode="all-at-once" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${!isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${!isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="All-at-Once Check Mode">
                        Check All
                    </button>
                </div>
            </div>
            <div class="progress-info" style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 14px; color: var(--text-secondary);" id="answeredCount">0/${questions.length} answered</span>
                <div class="progress-bar" style="flex: 1; height: 6px;">
                    <div class="progress-fill" id="examProgressFill" style="width: 0%"></div>
                </div>
                <span id="timerDisplay" style="font-size: 14px; color: var(--text-secondary);">Time: ${formatTime(remainingTime)}</span>
                ${examSubmitted ? `<span style="color: var(--success); font-weight: 600; font-size: 14px;">Submitted!</span>` : ''}
            </div>
        </div>
        <div class="exam-mode-layout">
            ${questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const showExplanationButton = examSubmitted || (isImmediateMode && userAnswer !== undefined);
                return `
                    <div class="question-card fade-in" data-question-index="${index}" id="question-${question.id}">
                        <div class="question-header">
                            <div class="question-meta">
                                <div class="question-number">Q${question.id}</div>
                                <div class="question-category">${question.category}</div>
                                <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                    ${question.difficulty}
                                </div>
                                ${userAnswer !== undefined ? `
                                    <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                                        ${isCorrect ? 'Correct' : 'Incorrect'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="question-actions">
                                <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                                    <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="question-image-container">
                            ${question.image ? `<img src="${question.image}" alt="Question image" class="question-image">` : ''}
                        </div>
                        <div class="question-text">${marked.parse(question.question)}</div>
                        <div class="options-grid">
                            ${question.options.map((option, optIndex) => {
                                const isSelected = userAnswer === optIndex;
                                const isCorrectOption = optIndex === question.answer;
                                let optionClass = 'option';
                                if (userAnswer !== undefined) {
                                    if (isCorrectOption) {
                                        optionClass += ' correct';
                                    } else if (isSelected && !isCorrectOption) {
                                        optionClass += ' incorrect';
                                    }
                                    optionClass += ' disabled';
                                } else if (isSelected) {
                                    optionClass += ' selected';
                                }
                                return `
                                    <div class="${optionClass}" data-option-index="${optIndex}" role="button" aria-label="Option ${String.fromCharCode(65 + optIndex)}">
                                        <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                        <div class="option-text">${option}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${showExplanationButton ? `
                            <div class="explanation-section">
                                <details open>
                                    <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                                    <div class="explanation-content correct-answer">
                                        <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                                    </div>
                                </details>
                                ${userAnswer !== undefined && userAnswer !== question.answer ? `
                                    <details>
                                        <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                                        <div class="explanation-content why-not-section">
                                            <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                            <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                                        </div>
                                    </details>
                                ` : ''}
                                <details>
                                    <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                                    <div class="explanation-content">${question.explanation}</div>
                                </details>
                                <details>
                                    <summary><i class="fas fa-link"></i> Related Questions</summary>
                                    <div class="explanation-content related-questions">
                                        <div class="related-questions-list">
                                            ${question.relatedQuestions.map(q => {
                                                const qId = q.match(/\d+/)[0];
                                                return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    ${examCheckMode === 'all-at-once' && !examSubmitted ? `
                        <button class="quiz-btn check-btn" id="checkAllBtn" ${userAnswers.filter(a => a !== undefined).length === 0 ? 'disabled' : ''} aria-label="Check All Answers">
                            <i class="fas fa-check-double"></i>
                            Check All Answers
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn submit-btn" id="examSubmitBtn" ${examSubmitted ? 'disabled' : ''} aria-label="Submit Exam">
                    <i class="fas fa-paper-plane"></i>
                    ${examSubmitted ? 'Exam Submitted' : `Submit Exam (${questions.length} questions)`}
                </button>
            </div>
        </div>
    `;
    initializeExamModeEvents();
    updateExamSubmitButton();
}

function renderSingleQuestionLayout() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const isCorrect = userAnswer === question.answer;
    quizContainer.innerHTML = `
        <div class="question-card fade-in" data-question-index="${currentQuestionIndex}">
            <div class="question-header">
                <div class="question-meta">
                    <div class="question-number">Q${question.id}</div>
                    <div class="question-category">${question.category}</div>
                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                        ${question.difficulty}
                    </div>
                    ${userAnswer !== undefined ? `
                        <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </div>
                    ` : ''}
                </div>
                <div class="question-actions">
                    <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                        <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                    </button>
                </div>
            </div>
            <div class="question-image-container">
                ${question.image ? `<img src="${question.image}" alt="Question image" class="question-image">` : ''}
            </div>
            <div class="question-text">${marked.parse(question.question)}</div>
            <div class="options-grid">
                ${question.options.map((option, index) => {
                    const isSelected = userAnswer === index;
                    const isCorrectOption = index === question.answer;
                    let optionClass = 'option';
                    if (isAnswerChecked) {
                        if (isCorrectOption) {
                            optionClass += ' correct';
                        } else if (isSelected && !isCorrectOption) {
                            optionClass += ' incorrect';
                        }
                        optionClass += ' disabled';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    return `
                        <div class="${optionClass}" data-option-index="${index}" role="button" aria-label="Option ${String.fromCharCode(65 + index)}">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isAnswerChecked ? `
                <div class="explanation-section">
                    <details open>
                        <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                        <div class="explanation-content correct-answer">
                            <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                        </div>
                    </details>
                    ${userAnswer !== undefined && userAnswer !== question.answer ? `
                        <details>
                            <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                            <div class="explanation-content why-not-section">
                                <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                            </div>
                        </details>
                    ` : ''}
                    <details>
                        <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                        <div class="explanation-content">${question.explanation}</div>
                    </details>
                    <details>
                        <summary><i class="fas fa-link"></i> Related Questions</summary>
                        <div class="explanation-content related-questions">
                            <div class="related-questions-list">
                                ${question.relatedQuestions.map(q => {
                                    const qId = q.match(/\d+/)[0];
                                    return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                </div>
            ` : ''}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    <button class="quiz-btn check-btn" id="checkAnswerBtn" ${userAnswer === undefined ? 'disabled' : ''} aria-label="Check Answer">
                        <i class="fas fa-check"></i>
                        Check Answer
                    </button>
                    ${currentMode === 'learn' && incorrectQuestions.length > 0 ? `
                        <button class="quiz-btn" id="incorrectOnlyBtn" aria-label="Show Incorrect Only">
                            <i class="fas fa-filter"></i>
                            Incorrect Only
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn next-btn" id="nextQuestionBtn" ${!isAnswerChecked ? 'disabled' : ''} aria-label="Next Question">
                    <i class="fas fa-arrow-right"></i>
                    ${currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish'}
                </button>
            </div>
        </div>
    `;
    initializeQuizEvents();
    updateTimerDisplay(formatTime(isCountdown ? remainingTime : questionTimers[currentQuestionIndex]), 'timerDisplay', isCountdown);
}

function initializeQuizEvents() {
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const incorrectOnlyBtn = document.getElementById('incorrectOnlyBtn');
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    const options = document.querySelectorAll('.option:not(.disabled)');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            if (!isAnswerChecked) {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[currentQuestionIndex] = parseInt(option.dataset.optionIndex);
                if (checkAnswerBtn) checkAnswerBtn.disabled = false;
                updateExamSubmitButton();
            }
        });
    });
    
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', () => {
            checkAnswer();
            renderQuizLayout();
        });
    }
    
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (incorrectOnlyBtn) {
        incorrectOnlyBtn.addEventListener('click', () => {
            questions = quizData.filter(q => incorrectQuestions.includes(q.id));
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length);
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', () => {
            const questionId = parseInt(bookmarkBtn.dataset.questionId);
            toggleBookmark(questionId);
            bookmarkBtn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    }
}

function initializeExamModeEvents() {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const checkAllBtn = document.getElementById('checkAllBtn');
    const submitBtn = document.getElementById('examSubmitBtn');
    const modeToggleButtons = document.querySelectorAll('.mode-toggle-btn');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            const questionIndex = parseInt(option.closest('.question-card').dataset.questionIndex);
            const prevSelected = option.closest('.options-grid').querySelector('.selected');
            if (prevSelected) prevSelected.classList.remove('selected');
            option.classList.add('selected');
            userAnswers[questionIndex] = parseInt(option.dataset.optionIndex);
            updateExamProgress();
            updateExamSubmitButton();
            if (examCheckMode === 'immediate') {
                checkAnswer(questionIndex);
                renderQuizLayout();
            }
        });
    });
    
    if (checkAllBtn) {
        checkAllBtn.addEventListener('click', () => {
            userAnswers.forEach((answer, index) => {
                if (answer !== undefined) {
                    checkAnswer(index);
                }
            });
            renderQuizLayout();
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', submitExam);
    }
    
    modeToggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            examCheckMode = btn.dataset.mode;
            renderQuizLayout();
        });
    });
    
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionId = parseInt(btn.dataset.questionId);
            toggleBookmark(questionId);
            btn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    });
}

function updateExamProgress() {
    const answered = userAnswers.filter(a => a !== undefined).length;
    const progressPercent = (answered / questions.length) * 100;
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('examProgressFill');
    if (answeredCount) {
        answeredCount.textContent = `${answered}/${questions.length} answered`;
    }
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
}

function updateExamSubmitButton() {
    const submitBtn = document.getElementById('examSubmitBtn');
    if (submitBtn) {
        const allAnswered = userAnswers.every(a => a !== undefined);
        submitBtn.disabled = !allAnswered || examSubmitted;
        submitBtn.innerHTML = examSubmitted ?
            '<i class="fas fa-paper-plane"></i> Exam Submitted' :
            `<i class="fas fa-paper-plane"></i> Submit Exam (${questions.length} questions)`;
    }
}

function checkAnswer(questionIndex = currentQuestionIndex) {
    const question = questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    isAnswerChecked = true;
    if (userAnswer === question.answer) {
        score++;
        userStats.correctAnswers++;
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].correct++;
        userProgress[question.id].attempts++;
        incorrectQuestions = incorrectQuestions.filter(id => id !== question.id);
    } else {
        if (!incorrectQuestions.includes(question.id)) {
            incorrectQuestions.push(question.id);
        }
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].attempts++;
    }
    userStats.totalQuestions++;
    userStats.masteryLevel = calculateMasteryLevel();
    saveUserData();
    updateDashboardStats();
}

function submitExam() {
    examSubmitted = true;
    if (examCheckMode === 'all-at-once') {
        userAnswers.forEach((answer, index) => {
            if (answer !== undefined) {
                checkAnswer(index);
            }
        });
    }
    stopTimer();
    showResults();
}

function calculateMasteryLevel() {
    const masteredQuestions = Object.values(userProgress).filter(p => p.correct >= 3).length;
    return quizData.length > 0 ? Math.round((masteredQuestions / quizData.length) * 100) : 0;
}

function showResults() {
    stopTimer();
    quizContainer.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
    
    let restartText = 'Restart Quiz';
    if (currentPage === 'bookmarks') {
        restartText = 'Practice Again';
    }
    
    resultsScreen.innerHTML = `
        <div class="results-card fade-in">
            <div class="results-header">
                <h2 class="results-title">${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Results</h2>
                <p class="score-text">You completed ${questions.length} question${questions.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="score-display">${percentage}%</div>
            <div class="score-text">Score: ${score} out of ${questions.length} correct</div>
            <div class="results-details">
                ${questions.map((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    return `
                        <div class="result-item">
                            <div class="result-question">Q${q.id}: ${q.question}</div>
                            <div class="result-status ${isCorrect ? 'result-correct' : 'result-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="restart-btn" id="restartQuiz" aria-label="Restart Quiz" style="margin: 0;">
                    <i class="fas fa-redo"></i>
                    ${restartText}
                </button>
                ${currentPage === 'bookmarks' ? `
                    <button class="quiz-btn" onclick="showBookmarks()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 16px 24px; border-radius: var(--radius);">
                        <i class="fas fa-bookmark"></i>
                        Back to Bookmarks
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('restartQuiz').addEventListener('click', () => {
        if (currentPage === 'bookmarks') {
            startBookmarksQuiz();
        } else {
            startQuiz();
        }
    });
}

function toggleBookmark(questionId) {
    if (bookmarkedQuestions.has(questionId)) {
        bookmarkedQuestions.delete(questionId);
        showNotification('Question removed from bookmarks', 'info');
    } else {
        bookmarkedQuestions.add(questionId);
        showNotification('Question bookmarked', 'success');
    }
    saveUserData();
    
    // If we're on the bookmarks page, refresh it
    if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}


function getDifficultyColor(difficulty) {
    switch (difficulty.toLowerCase()) {
        case 'easy': return '#10b981';
        case 'medium': return '#f59e0b';
        case 'hard': return '#ef4444';
        default: return '#64748b';
    }
}

function jumpToQuestion(questionId) {
    const questionIndex = questions.findIndex(q => `question-${q.id}` === questionId);
    if (questionIndex !== -1) {
        if (currentMode === 'exam') {
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } else {
            currentQuestionIndex = questionIndex;
            isAnswerChecked = false;
            renderQuizLayout();
        }
    } else {
        // If question not in current quiz, start a new quiz with that question's category
        const question = quizData.find(q => `question-${q.id}` === questionId) || customQuestions.find(q => `question-${q.id}` === questionId);
        if (question) {
            selectedCategories = [question.category];
            startQuiz();
            setTimeout(() => {
                const element = document.getElementById(questionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }
}

// Initialize the application
init();
    </script>
</body>

</html>