<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF | Advanced Medical Education</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/protect.js"></script>
    // Production-ready service worker registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    const swUrl = '/sw.js';
    
    navigator.serviceWorker.register(swUrl)
      .then(function(registration) {
        console.log('‚úÖ SW registered successfully on scope:', registration.scope);
        
        // Check if SW is controlling the page
        if (navigator.serviceWorker.controller) {
          console.log('üéØ SW is controlling the page');
        } else {
          console.log('‚ö†Ô∏è SW registered but not controlling the page');
        }
        
        // Check cache after registration
        setTimeout(() => {
          caches.open('vercel-app-v1').then(cache => {
            cache.keys().then(requests => {
              console.log(`üì¶ Production cache: ${requests.length} files`);
            });
          });
        }, 3000);
      })
      .catch(function(error) {
        console.log('‚ùå SW registration failed:', error);
      });
  });
}
</script>
    <style type="text/css">
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --primary-light: #dbeafe; 
            --secondary: #6b7280; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #eab308; 
            --info: #0ea5e9; 
            --background: #ffffff; 
            --surface: #f9fafb; 
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-tertiary: #9ca3af; 
            --border: #e5e7eb; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.05);
            --radius: 8px; 
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --glass: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(229, 231, 235, 0.3);
        }

        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --background: #000000; 
            --surface: #111827; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-tertiary: #6b7280; 
            --border: #1f2937; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.6);
            --glass: rgba(17, 24, 39, 0.85); 
            --glass-border: rgba(31, 41, 55, 0.3);
            .mode-btn,
    .question-text,
    .option-text {
        color: var(--text-primary) !important;
    }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .logo i {
            font-size: 24px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            background: var(--glass);
            border-radius: var(--radius);
            margin: 0 16px 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--glass);
            border-left-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .categories-section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .categories-grid {
            padding: 0 16px;
        }

        .category-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .category-card.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .category-card.active .category-icon {
            background: var(--primary);
        }

        .category-name {
            font-weight: 500;
            font-size: 14px;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-right: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-card.active .progress-text {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.sidebar-open {
            margin-left: 280px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-light);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 24px 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quiz Container */
        .quiz-container {
            padding: 0 32px 32px;
        }

        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .question-card.fade-in {
            opacity: 1;
        }

        .question-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--glass);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text-primary);
            overflow-x: auto;
        }

        .question-text table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            text-align: left;
            overflow-x: auto;
            display: block;
        }

        .question-text th, .question-text td {
            padding: 12px;
            border: 1px solid var(--border);
        }

        .question-text th {
            background-color: var(--surface);
            font-weight: bold;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            min-height: 60px;
        }

        .option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .explanation-section details {
            margin-bottom: 16px;
        }

        .explanation-section summary {
            padding: 12px 16px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .explanation-section summary:hover {
            background: var(--primary-light);
        }

        .explanation-section details[open] summary {
            background: var(--primary);
            color: white;
        }

        .explanation-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .correct-answer, .why-not-section, .related-questions {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: var(--radius);
        }

        .correct-answer {
            background: rgba(34, 197, 94, 0.05);
            border-left: 4px solid var(--success);
        }

        .why-not-section {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--error);
        }

        .related-questions {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }

        .related-questions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .related-question-tag {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .related-question-tag:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .quiz-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .quiz-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .check-btn {
            background: var(--primary);
            color: white;
        }

        .check-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .next-btn {
            background: var(--success);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: #16a34a;
        }

        .submit-btn {
            background: var(--gradient);
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        /* Results Screen */
        .results-screen {
            padding: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .results-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .results-header {
            margin-bottom: 32px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            margin: 32px 0;
            color: var(--text-primary);
        }

        .score-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .results-details {
            text-align: left;
            margin: 48px 0;
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-question {
            flex: 1;
            font-size: 14px;
        }

        .result-status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-correct {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .result-incorrect {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .restart-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Enhanced Features */
        .search-container {
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: var(--text-tertiary);
            margin-right: 8px;
        }


        .export-section {
            padding: 16px 32px;
            text-align: center;
        }

        .export-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Custom Quiz Modal Styles */
        .custom-quiz-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .custom-quiz-modal.active {
            display: flex;
        }

        .custom-quiz-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        .custom-quiz-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .custom-quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .custom-quiz-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
        }

        .custom-quiz-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .custom-quiz-option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .custom-quiz-option .option-selector {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .custom-quiz-option.selected .option-selector {
            background: var(--primary);
            border-color: var(--primary);
        }

        .custom-quiz-option.selected .option-selector::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .custom-quiz-option label {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            margin: 0;
        }

        .quiz-options-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .quiz-options-section label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .custom-quiz-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Modern Dropdown for Custom Quiz */
        .custom-quiz-content .modern-dropdown {
            position: relative;
            margin-top: 8px;
        }

        .custom-quiz-content .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
        }

        .custom-quiz-content .modern-dropdown select:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }

        .custom-quiz-content .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Glass effect for modal */
        .custom-quiz-content.glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark-mode .custom-quiz-content.glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 66vw;
            }

            .main-content.sidebar-open {
                margin-left: 100vw;
            }

            .top-nav {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
                justify-content: space-between;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .quiz-container {
                padding: 0 16px 16px;
            }

            .question-card {
                padding: 24px;
            }

            .question-text {
                font-size: 17px;
            }

            .option {
                padding: 12px;
                min-height: 70px;
            }

            .results-card {
                padding: 32px 24px;
            }

            .score-display {
                font-size: 48px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                padding: 12px 16px;
            }

            .analytics-section {
                margin: 16px;
                padding: 16px;
            }

            .quiz-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) {
            .quiz-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 24px;
            }

            .question-card {
                max-width: 1000px;
                margin: 0 auto 24px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .hidden {
            display: none;
        }

        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-gradient {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .question-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .question-dropdown {
            margin-top: 8px;
            display: block;
        }

        .question-dropdown select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-error {
            color: var(--error);
        }

        .loading-spinner {
            display: none;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra Modern Styles */
        /* Glass Morphism Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Hover Effects with Glow */
        .nav-item:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left-color: var(--primary) !important;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(10px);
        }

        .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(255, 255, 255, 0.95) 100%) !important;
            transform: translateY(-5px) scale(1.03) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.1) !important;
            border-color: var(--primary) !important;
            backdrop-filter: blur(10px);
        }

        .option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.12) 100%) !important;
            transform: translateY(-3px) scale(1.03) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2) !important;
            border-color: var(--primary) !important;
        }

        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25) !important;
            filter: brightness(1.1);
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            transform: scale(1.15) rotate(8deg) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
        }

        /* Ultra Modern Dropdown */
        .modern-dropdown {
            position: relative;
            margin-top: 12px;
        }

        .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--glass) 100%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .modern-dropdown select:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 25px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        /* Enhanced Search with Blur Effect */
        .search-container {
            transition: all 0.4s ease;
        }

        .search-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-blur-active .main-content > *:not(.search-container):not(.quiz-container) {
            filter: blur(8px);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Beautiful Stats Cards */
        .stat-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2) !important;
        }

        /* Modern Progress Bars */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), #8b5cf6) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Beautiful Notification */
        .notification {
            border-radius: 20px !important;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)) !important;
        }

        .dark-mode .notification {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2)) !important;
        }

        /* Enhanced Question Cards */
        .question-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-3px);
            border-color: var(--primary-light);
        }

        /* Modern Settings Panel */
        .settings-panel {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Question Creator */
        .custom-question-creator {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 32px;
        }

        .dark-mode .custom-question-creator {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
        }

        /* Dark mode adjustments */
        .dark-mode .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.1) 100%) !important;
        }

        .dark-mode .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(17, 24, 39, 0.95) 100%) !important;
        }

        .dark-mode .option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 100%) !important;
        }

        /* Search Results Highlight */
        .search-highlight {
            background: linear-gradient(120deg, var(--primary-light) 0%, transparent 50%);
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 12px 16px;
    }

    .stat-card {
        padding: 16px 12px;
        min-height: 80px;
    }

    .stat-header {
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .stat-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }

    .stat-value {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .stat-label {
        font-size: 11px;
        line-height: 1.3;
    }

    .stat-trend {
        font-size: 10px;
    }

    .stat-trend i {
        font-size: 10px;
    }
}

/* Extra small devices (phones under 400px) */
@media (max-width: 400px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px 12px;
    }

    .stat-card {
        padding: 14px 10px;
        min-height: 70px;
    }

    .stat-value {
        font-size: 18px;
    }

    .stat-label {
        font-size: 10px;
    }
}
.analytics-grid {
    display: none;
}

/* OR hide individual cards */
.analytics-card {
    display: none;
}

/* If you want to keep the section structure but hide content */
.analytics-section {
    padding: 0;
    margin: 0;
    height: 0;
    overflow: hidden;
}
@media (max-width: 768px) {
    /* Your existing mobile styles... */
    
    .sidebar {
        width: 66vw;
    }

    .main-content.sidebar-open {
        margin-left: 100vw;
    }

    .top-nav {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    /* Hide all custom question and export buttons on mobile */
    .fab {
        display: none !important;
    }
    
    #createCustomQuizBtn {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }

    /* Your stats grid and other mobile styles... */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
    /* ... rest of your mobile CSS */
}
@media (max-width: 768px) {
    .fab {
        display: none !important;
    }
    
    /* Hide entire export section from Dashboard */
    .export-section {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }
}
@media (max-width: 768px) {
    /* Hide all stat cards except Correct Answers */
    .stat-card:not(:first-child) {
        display: none !important;
    }
    
    /* Optional: Make the Correct Answers card full width */
    .stat-card:first-child {
        width: 100% !important;
        flex: 1 !important;
    }

    /* Your existing mobile styles for stats grid */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
}
.user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
/* Primary action button */
.action-btn.primary {
    background: var(--primary);
    color: white;
}

.action-btn.primary:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}
/* Responsive Images */
.question-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 16px 0;
    display: block;
    box-shadow: var(--shadow);
}

.question-image-container {
    width: 100%;
    text-align: center;
    margin: 16px 0;
}

/* Ensure images don't overflow their containers */
.question-image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: var(--shadow);
}

/* Responsive Tables */
.question-text table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 14px;
    text-align: left;
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--radius);
    background: var(--surface);
}

.question-text th, .question-text td {
    padding: 12px;
    border: 1px solid var(--border);
    min-width: 120px; /* Prevents columns from becoming too narrow */
}

.question-text th {
    background-color: var(--surface);
    font-weight: bold;
    position: sticky;
    left: 0;
    color: var(--text-primary);
}

.question-text td {
    color: var(--text-secondary);
    background: var(--background);
}

/* Responsive Question Cards */
.question-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    width: 100%;
    overflow: hidden;
}

.question-card:hover {
    box-shadow: var(--shadow-lg);
}

/* Mobile-specific adjustments */
@media (max-width: 768px) {
    /* Question card mobile optimization */
    .question-card {
        padding: 16px;
        margin-bottom: 12px;
        border-radius: var(--radius);
    }
    
    .question-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .question-meta {
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
    }
    
    .question-actions {
        align-self: flex-end;
        margin-top: -40px; /* Position actions at top right */
        position: relative;
        z-index: 2;
    }
    
    .question-text {
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 20px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* Image mobile optimization */
    .question-image {
        margin: 12px 0;
        border-radius: 6px;
    }
    
    .question-image-container {
        margin: 12px 0;
    }
    
    /* Table mobile optimization */
    .question-text table {
        font-size: 12px;
        margin: 12px 0;
        border-radius: 6px;
    }
    
    .question-text th, .question-text td {
        padding: 8px 10px;
        min-width: 100px;
    }
    
    /* Options grid mobile optimization */
    .options-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .option {
        padding: 14px;
        min-height: auto;
    }
    
    .option-letter {
        width: 28px;
        height: 28px;
        font-size: 13px;
    }
    
    .option-text {
        font-size: 14px;
        line-height: 1.4;
    }
    
    /* Quiz controls mobile optimization */
    .quiz-controls {
        flex-direction: column;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
    }
    
    .quiz-btn {
        width: 100%;
        justify-content: center;
        padding: 14px 20px;
        font-size: 15px;
    }
    
    /* Explanation section mobile optimization */
    .explanation-section {
        margin-top: 20px;
        padding: 16px;
    }
    
    .explanation-section summary {
        padding: 10px 12px;
        font-size: 14px;
    }
    
    .explanation-content {
        padding: 12px;
        font-size: 13px;
        line-height: 1.5;
    }
}

/* Extra small devices optimization (phones under 480px) */
@media (max-width: 480px) {
    .question-card {
        padding: 12px;
        margin-bottom: 10px;
    }
    
    .question-text {
        font-size: 15px;
        line-height: 1.4;
    }
    
    /* Image optimization for very small screens */
    .question-image {
        margin: 10px 0;
        border-radius: 4px;
    }
    
    .question-image-container {
        margin: 10px 0;
    }
    
    /* Table optimization for very small screens */
    .question-text table {
        font-size: 11px;
        margin: 10px 0;
    }
    
    .question-text th, .question-text td {
        padding: 6px 8px;
        min-width: 80px;
    }
    
    .question-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
    }
    
    .question-number, .question-category, .question-difficulty {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    .option {
        padding: 12px 10px;
    }
    
    .option-text {
        font-size: 13px;
    }
    
    .action-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
    }
    
    /* Ensure proper spacing in exam mode */
    .exam-mode-layout .question-card {
        margin-bottom: 16px;
    }
}

/* Fix for exam mode layout on mobile */
.exam-mode-layout {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

@media (max-width: 768px) {
    .exam-mode-layout {
        gap: 12px;
    }
    
    .exam-header {
        padding: 16px;
    }
    
    .exam-header > div:first-child {
        flex-direction: column;
        gap: 16px;
    }
    
    .exam-mode-toggle {
        align-self: stretch;
        display: flex;
    }
    
    .mode-toggle-btn {
        flex: 1;
        text-align: center;
        font-size: 12px;
        padding: 10px 8px;
    }
    
    .progress-info {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .progress-info .progress-bar {
        width: 100%;
    }
}

/* Fix for learn mode responsiveness */
@media (max-width: 768px) {
    .explanation-section {
        padding: 16px;
    }
    
    .explanation-section summary {
        padding: 10px 12px;
        font-size: 14px;
    }
    
    .explanation-content {
        padding: 12px;
        font-size: 13px;
    }
    
    .related-questions-list {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .related-question-tag {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    .correct-answer, .why-not-section, .related-questions {
        padding: 12px;
        margin-bottom: 12px;
    }
}

/* Prevent horizontal scrolling on the entire page */
@media (max-width: 768px) {
    body {
        overflow-x: hidden;
    }
    
    .quiz-container {
        padding: 0 16px 16px;
    }
    
    .main-content {
        width: 100%;
    }
}

/* Ensure images in custom questions are also responsive */
.custom-question-creator img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 10px 0;
    display: block;
}

/* Fix for image loading states */
.question-image {
    background: var(--surface);
    min-height: 50px;
}

.question-image:not([src]) {
    display: none;
}

/* Animation for image loading */
@keyframes imageFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.question-image.loaded {
    animation: imageFadeIn 0.3s ease-in;
}
    </style>
</head>
<body class="dark-mode">
    <div class="overlay" id="overlay"></div>
    
    <!-- Custom Quiz Modal -->
<div class="custom-quiz-modal" id="customQuizModal">
    <div class="custom-quiz-content glass-effect">
        <h3 class="custom-quiz-title">Create Custom Quiz</h3>
        <div class="custom-quiz-options">
            <div class="custom-quiz-option" data-category="all">
                <div class="option-selector"></div>
                <label>All Categories</label>
            </div>
            <div class="custom-quiz-option" data-category="easy">
                <div class="option-selector"></div>
                <label>Easy Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="medium">
                <div class="option-selector"></div>
                <label>Medium Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="hard">
                <div class="option-selector"></div>
                <label>Hard Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="bookmarked">
                <div class="option-selector"></div>
                <label>Bookmarked Questions Only</label>
            </div>
            <div class="quiz-options-section">
                <label>Number of Questions</label>
                <div class="modern-dropdown">
                    <select id="questionCount">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="0">All Questions</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="custom-quiz-actions">
            <button class="quiz-btn" id="cancelCustomQuiz">
                Cancel
            </button>
            <button class="quiz-btn check-btn" id="createCustomQuiz">
                Create Quiz
            </button>
        </div>
    </div>
</div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>ALIF</span>
                </div>
                <div class="sidebar-subtitle">Advanced Medical Education Platform</div>
            </div>
            
            <div class="user-profile">
    <div class="user-avatar">
        <img src="logo.png" alt="User Avatar">
    </div>
    <div class="user-info">
        <h3>ALIFO</h3>
        <p>Medical Student</p>
    </div>
</div>

            
            <div class="nav-item active">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>My Courses</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Progress Analytics</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <span>Bookmarked Questions</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <span>Settings</span>
            </div>
            
            <div class="categories-section">
                <div class="section-title">
                    <span>Medical Categories</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <div class="top-nav">
    <div class="nav-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Add Back and Home buttons -->
        <a href="/" class="action-btn" id="backBtn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <a href="/" class="action-btn primary">
            <i class="fas fa-home"></i>
        </a>
        
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
    </div>
    <div class="nav-right">
        <!-- Your existing mode selector and buttons -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="exam" aria-label="Exam Mode">
                <i class="fas fa-file-alt"></i>
                Exam
            </button>
            <button class="mode-btn" data-mode="quiz" aria-label="Quiz Mode">
                <i class="fas fa-tasks"></i>
                Quiz
            </button>
            <button class="mode-btn" data-mode="learn" aria-label="Learn Mode">
                <i class="fas fa-brain"></i>
                Learn
            </button>
        </div>
        <div class="action-btn" id="themeToggle" aria-label="Toggle Theme">
            <i class="fas fa-sun"></i>
        </div>
        <div class="action-btn" aria-label="Notifications">
            <i class="fas fa-bell"></i>
        </div>
    </div>
</div>
            
            <!-- Search Section -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search questions or categories...">
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            <span style="color: var(--error); font-size: 13px;">-5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="timeSpent">0h</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="masteryLevel">0%</div>
                    <div class="stat-label">Mastery Level</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--warning);"></i>
                            <span style="color: var(--warning); font-size: 13px;">+3</span>
                        </div>
                    </div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="analytics-section">
                <h3 class="analytics-title">Learning Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="weakAreasCount">0</div>
                        <div class="analytics-label">Weak Areas Identified</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avgTimePerQuestion">0s</div>
                        <div class="analytics-label">Avg Time Per Question</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="improvementRate">0%</div>
                        <div class="analytics-label">Weekly Improvement</div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer"></div>
            
            <!-- Results Screen -->
            <div class="results-screen hidden" id="resultsScreen"></div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" id="exportProgress">
                    <i class="fas fa-download"></i>
                     
                </button>
                <button class="export-btn" id="createCustomQuizBtn" style="margin-left: 12px;">
                    <i class="fas fa-plus"></i>
                     
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // Check if running inside Telegram
  const tg = window.Telegram?.WebApp;

  // --- 1Ô∏è‚É£ Handle Telegram Mini App Back Button ---
  if (tg) {
    tg.ready(); // Initialize Telegram SDK
    tg.BackButton.show();

    tg.BackButton.onClick(() => {
      console.log("Telegram back button pressed");
      handleBackAction();
    });
  }

  // --- 2Ô∏è‚É£ Handle Browser/Phone Back Button ---
  window.addEventListener('popstate', () => {
    console.log("Browser back button pressed");
    handleBackAction();
  });

  // --- 3Ô∏è‚É£ Function to handle back action globally ---
  function handleBackAction() {
    // Example actions (customize as you wish):
    // Go back if possible, otherwise go to home page
    if (document.referrer && window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = '/'; // or your home page route
    }
  }

  // --- 4Ô∏è‚É£ Optional: Prevent unwanted exits ---
  // This ensures pressing back doesn‚Äôt immediately close the app
  history.pushState(null, '', location.href);
</script>

     <script>
        // Anti-copy, anti-inspect measures
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
    }
});

// Enhanced quiz data with more questions
const quizData = [
    {
        "id": 1,
        "question": "______ are single-celled prokaryotic organisms, without nuclear membrane, and no membrane-bounded organelles.",
        "options": [
            "Viruses",
            "Fungi",
            "Bacteria",
            "Prions"
        ],
        "answer": 2,
        "correctAnswer": "Bacteria",
        "explanation": "Prokaryotic organisms are characterized by the absence of a true nucleus (nuclear membrane) and membrane-bound organelles such as mitochondria or endoplasmic reticulum. Bacteria fit this description perfectly as they are unicellular prokaryotes with a simple internal structure, including a nucleoid region for DNA, ribosomes, and a cell wall. This distinguishes them from eukaryotes and non-cellular entities. Viruses lack cellular structure entirely, fungi are eukaryotic with complex organelles, and prions are mere infectious protein particles without any cellular organization.",
        "whyNotOtherOptions": {
            "a": "Viruses are acellular entities, not considered living organisms, and do not have a cellular structure like prokaryotes.",
            "b": "Fungi are eukaryotic organisms with a true nucleus and membrane-bound organelles.",
            "d": "Prions are infectious proteins without any cellular components or genetic material in the form of nucleic acids."
        },
        "relatedQuestions": [],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 2,
        "question": "Bacteria and fungi have a cell wall which is made up of ______ & ______ respectively.",
        "options": [
            "Unicellular & multicellular",
            "Chitin and peptidoglycan",
            "Peptidoglycan and chitin",
            "Flagellin and pilin"
        ],
        "answer": 2,
        "correctAnswer": "Peptidoglycan and chitin",
        "explanation": "The cell wall provides structural support and protection to microbial cells. In bacteria, the primary component is peptidoglycan, a polymer consisting of sugars (N-acetylglucosamine and N-acetylmuramic acid) cross-linked by peptide chains, which gives rigidity and determines Gram staining properties. In contrast, fungal cell walls are primarily composed of chitin, a long-chain polymer of N-acetylglucosamine, providing strength and flexibility. This difference is crucial for taxonomic classification and is targeted by certain antibiotics and antifungals that disrupt cell wall synthesis.",
        "whyNotOtherOptions": {
            "a": "Unicellular and multicellular refer to organism organization, not cell wall composition.",
            "b": "This reverses the correct components; chitin is for fungi, peptidoglycan for bacteria.",
            "d": "Flagellin and pilin are proteins involved in flagella and pili structures, not cell walls."
        },
        "relatedQuestions": ["9", "10"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 3,
        "question": "Viruses are obligate intracellular parasite with the following general characteristic EXCEPT:",
        "options": [
            "Replicate by binary fission",
            "Consists of either DNA/RNA but not both",
            "Nuclear material is enclosed in a protein coat with/without lipid membrane coat.",
            "They are very small can't be seen with light microscope"
        ],
        "answer": 0,
        "correctAnswer": "Replicate by binary fission",
        "explanation": "Viruses are acellular parasites that require a host cell for replication. They do not divide by binary fission, which is a cellular process involving chromosome duplication and cell splitting seen in bacteria. Instead, viruses replicate by infecting a host, hijacking its machinery to produce viral components, and assembling new virions. They possess either DNA or RNA as genetic material (never both), enclosed in a protein capsid that may or may not have a lipid envelope. Their small size (typically 20-300 nm) requires electron microscopy for visualization, beyond the resolution of light microscopes.",
        "whyNotOtherOptions": {
            "b": "Viruses indeed have only one type of nucleic acid, either DNA or RNA, as their genome.",
            "c": "The genetic material is always protected by a protein capsid, and some viruses have an additional lipid envelope.",
            "d": "Viruses are submicroscopic, requiring electron microscopes for observation due to their nanoscale size."
        },
        "relatedQuestions": ["25", "28"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 4,
        "question": "What is the temperature, time and pressure level in moist heat sterilization (Autoclaving) to achieve sterile environment?",
        "options": [
            "121¬∞C, 21 minutes and 15 lb/inch¬≤",
            "131¬∞C, 15 minutes and 21 lb/inch¬≤",
            "121¬∞C, 15 minutes and 15 lb/inch¬≤",
            "141¬∞C, 21 minutes and 15 lb/inch¬≤"
        ],
        "answer": 2,
        "correctAnswer": "121¬∞C, 15 minutes and 15 lb/inch¬≤",
        "explanation": "Autoclaving uses saturated steam under pressure to achieve sterilization, killing all microorganisms including bacterial endospores. The standard parameters are 121¬∞C at 15 psi (pounds per square inch) for 15 minutes, as this combination ensures penetration of heat and moisture into materials, denaturing proteins and disrupting cellular structures. Higher pressures raise the boiling point of water, allowing steam to reach lethal temperatures. These conditions are widely used in medical and laboratory settings to sterilize equipment, media, and waste, ensuring a sterile environment.",
        "whyNotOtherOptions": {
            "a": "21 minutes is longer than necessary; standard is 15 minutes at these conditions.",
            "b": "131¬∞C and 21 psi are higher than standard; used for specific high-heat applications but not the norm.",
            "d": "141¬∞C is excessively high and not the standard for routine autoclaving."
        },
        "relatedQuestions": [],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 5,
        "question": "______ is unique structure to Gram positive bacteria while ______ unique structure to Gram negative bacteria respectively.",
        "options": [
            "peptidoglycan, polysaccharide",
            "Teichoic Acids, outer membrane",
            "cytoplasmic membrane, outer membrane",
            "inner membrane, periplasmic space"
        ],
        "answer": 1,
        "correctAnswer": "Teichoic Acids, outer membrane",
        "explanation": "Gram-positive bacteria have teichoic acids, which are polyol phosphate polymers anchored to the peptidoglycan layer or cytoplasmic membrane, contributing to cell wall maintenance, ion regulation, and pathogenicity. Gram-negative bacteria feature an outer membrane, a lipid bilayer containing lipopolysaccharides (LPS), porins, and proteins, which acts as a permeability barrier and houses endotoxins. These structural differences are fundamental to Gram staining, antibiotic susceptibility, and bacterial physiology.",
        "whyNotOtherOptions": {
            "a": "Peptidoglycan is present in both, though thicker in Gram-positive; polysaccharides are not unique.",
            "c": "Both have a cytoplasmic (inner) membrane; outer membrane is unique to Gram-negative.",
            "d": "Both have an inner membrane; periplasmic space is characteristic of Gram-negative bacteria but not the most unique paired with inner membrane."
        },
        "relatedQuestions": ["9", "16"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 6,
        "question": "Obligate anaerobes cannot withstand oxygen because of the absence of all enzymes except:",
        "options": [
            "Superoxide dismutase",
            "Catalase",
            "Peroxidase",
            "Protease"
        ],
        "answer": 2,
        "correctAnswer": "Peroxidase",
        "explanation": "Obligate anaerobes are highly sensitive to oxygen due to the lack of key detoxifying enzymes like superoxide dismutase (SOD), which converts superoxide radicals to hydrogen peroxide, and catalase, which breaks down hydrogen peroxide to water and oxygen. Some obligate anaerobes may possess peroxidase, an enzyme that can reduce hydrogen peroxide using a reductant, providing limited protection. However, without SOD and catalase, toxic oxygen species accumulate, leading to cellular damage. Protease is unrelated to oxygen detoxification. This enzymatic deficiency confines obligate anaerobes to oxygen-free environments.",
        "whyNotOtherOptions": {
            "a": "Obligate anaerobes lack superoxide dismutase, making them vulnerable to superoxide radicals.",
            "b": "They also lack catalase, unable to break down hydrogen peroxide effectively.",
            "d": "Protease is involved in protein degradation, not oxygen tolerance."
        },
        "relatedQuestions": ["22"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 7,
        "question": "Which of the following is incorrect?",
        "options": [
            "Peritrichous is a bacteria with flagella all over their surface",
            "Bacteria could be classified based on the shape and the position of spores",
            "Spirochetes are a bacteria moves by using a flagellum like structure called the axial filament/endoflagella",
            "Spheroplast is bacteria without cell wall, derived from gram positive bacteria by the action of lysosome."
        ],
        "answer": 3,
        "correctAnswer": "Spheroplast is bacteria without cell wall, derived from gram positive bacteria by the action of lysosome.",
        "explanation": "The incorrect statement is about spheroplasts, which are cell wall-deficient forms derived from Gram-negative bacteria through partial removal of the peptidoglycan layer, often using lysozyme (not lysosome, which is an eukaryotic organelle) and EDTA. In Gram-positive bacteria, complete cell wall removal results in protoplasts. Peritrichous flagellation means flagella distributed over the entire surface, bacterial classification includes spore morphology (e.g., central, terminal), and spirochetes use axial filaments (endoflagella) for motility, forming a helical motion.",
        "whyNotOtherOptions": {
            "a": "Peritrichous bacteria, like Escherichia coli, have flagella distributed all over the cell surface.",
            "b": "Bacteria like Bacillus and Clostridium are classified by spore shape (oval, round) and position (central, subterminal).",
            "c": "Spirochetes, such as Treponema, use endoflagella (axial filaments) for corkscrew motility."
        },
        "relatedQuestions": ["5", "9"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 8,
        "question": "In the nomenclature system of microbes the binomial name of an organism is composed of:",
        "options": [
            "Its kingdom and genus names",
            "Its genus and a strain names",
            "Its family and class names",
            "Its genus and species names"
        ],
        "answer": 3,
        "correctAnswer": "Its genus and species names",
        "explanation": "Binomial nomenclature, established by Carl Linnaeus, assigns each organism a two-part name: the genus (capitalized) and the species epithet (lowercase), both italicized (e.g., Staphylococcus aureus). This system provides a universal, standardized way to name organisms, avoiding confusion from common names. It does not include kingdom, family, class, or strain in the basic binomial name, though strains may be denoted additionally for specific variants.",
        "whyNotOtherOptions": {
            "a": "Kingdom is a higher taxonomic rank, not part of the binomial name.",
            "b": "Strain names are used for subtypes but not in the standard binomial nomenclature.",
            "c": "Family and class are higher taxonomic levels, not used in the two-part name."
        },
        "relatedQuestions": [],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 9,
        "question": "Which type of bacterial cell wall has high amount peptidoglycan?",
        "options": [
            "Gram-negative",
            "Gram-positive",
            "Both have the same amount",
            "None of these"
        ],
        "answer": 1,
        "correctAnswer": "Gram-positive",
        "explanation": "Gram-positive bacteria possess a thick peptidoglycan layer (up to 90% of the cell wall), consisting of multiple cross-linked layers that retain crystal violet during Gram staining, appearing purple. This thickness provides structural integrity and is a target for antibiotics like penicillin. Gram-negative bacteria have a thin peptidoglycan layer (about 10%) sandwiched between inner and outer membranes, leading to pink staining after counterstain. The difference affects permeability, staining, and susceptibility to treatments.",
        "whyNotOtherOptions": {
            "a": "Gram-negative have a thin peptidoglycan layer, not high amounts.",
            "c": "The amounts differ significantly between Gram-positive (thick) and Gram-negative (thin).",
            "d": "Gram-positive do have high peptidoglycan content."
        },
        "relatedQuestions": ["2", "5"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 10,
        "question": "Acid-fast bacteria (mycobacterium) are unique because their cell wall contains ______.",
        "options": [
            "Peptidoglycan",
            "Mycolic acid",
            "Granules",
            "Lipopolysaccharide"
        ],
        "answer": 1,
        "correctAnswer": "Mycolic acid",
        "explanation": "Mycobacteria, such as Mycobacterium tuberculosis, have cell walls rich in mycolic acids, long-chain fatty acids that create a waxy, hydrophobic barrier. This makes them resistant to decolorization by acid-alcohol in acid-fast staining (e.g., Ziehl-Neelsen), appearing red. The mycolic acids contribute to pathogenicity by resisting phagocytosis and antibiotics. While peptidoglycan is present, it's the mycolic acids that define acid-fastness. Lipopolysaccharides are in Gram-negative outer membranes, and granules are storage structures.",
        "whyNotOtherOptions": {
            "a": "Peptidoglycan is common to most bacteria, not unique to acid-fast.",
            "c": "Granules are intracellular storage, not cell wall components.",
            "d": "Lipopolysaccharide is found in Gram-negative bacteria, not mycobacteria."
        },
        "relatedQuestions": ["2", "9"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 11,
        "question": "The bacterial cells that retain the primary stain after undergoing Gram staining will have what color?",
        "options": [
            "Colorless",
            "Purple",
            "Pink /red",
            "Green"
        ],
        "answer": 1,
        "correctAnswer": "Purple",
        "explanation": "In Gram staining, crystal violet (primary stain) is applied, followed by iodine (mordant), decolorizer (alcohol/acetone), and safranin (counterstain). Gram-positive bacteria, with thick peptidoglycan, retain the crystal violet-iodine complex after decolorization, appearing purple under the microscope. Gram-negative bacteria lose the primary stain and take up safranin, appearing pink/red. This differential staining is essential for bacterial identification and guides antibiotic selection.",
        "whyNotOtherOptions": {
            "a": "No bacteria remain colorless; they take either primary or counterstain.",
            "c": "Pink/red is for Gram-negative after counterstaining.",
            "d": "Green is not a color in standard Gram staining."
        },
        "relatedQuestions": ["5", "9"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 12,
        "question": "This structure in bacteria is responsible for conjugation",
        "options": [
            "Capsule",
            "Cell wall",
            "Ordinary Pilus",
            "F Pilus"
        ],
        "answer": 3,
        "correctAnswer": "F Pilus",
        "explanation": "Conjugation is a mechanism of horizontal gene transfer where DNA is passed directly from one bacterium (donor) to another (recipient) via a physical bridge. The F (fertility) pilus, also called sex pilus, is a specialized appendage encoded by the F plasmid that extends from the donor cell to attach to the recipient, forming a conjugation tube for DNA transfer. Ordinary pili (fimbriae) are for adhesion, not conjugation. Capsule and cell wall provide protection but are not involved in conjugation.",
        "whyNotOtherOptions": {
            "a": "Capsule is a protective layer, not involved in gene transfer.",
            "b": "Cell wall provides structure but does not facilitate conjugation.",
            "c": "Ordinary pili aid in attachment to surfaces, not specific for conjugation."
        },
        "relatedQuestions": ["21"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 13,
        "question": "What is a plasmid?",
        "options": [
            "A bacterial chromosome",
            "Plasmids are necessary for cellular survival",
            "Self-replicating extra chromosomal double stranded DNA",
            "Escaped pieces of mitochondrial DNA"
        ],
        "answer": 2,
        "correctAnswer": "Self-replicating extra chromosomal double stranded DNA",
        "explanation": "Plasmids are small, circular, double-stranded DNA molecules separate from the bacterial chromosome, capable of autonomous replication. They often carry genes for non-essential but advantageous traits like antibiotic resistance, virulence factors, or metabolic capabilities. Unlike the chromosome, plasmids are not required for basic cellular functions and can be transferred between bacteria via conjugation. They are widely used in genetic engineering as vectors.",
        "whyNotOtherOptions": {
            "a": "The bacterial chromosome is the main genomic DNA, not extra-chromosomal.",
            "b": "Plasmids provide accessory functions but are not essential for survival under normal conditions.",
            "d": "Mitochondrial DNA is eukaryotic; plasmids are prokaryotic."
        },
        "relatedQuestions": ["12"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 14,
        "question": "A type of bacterial capsule that occurs as a non-uniform, loosely attached and of variable thickness is called:",
        "options": [
            "Protoplasm",
            "Glycocalyx",
            "Slime layer",
            "Nucleoid"
        ],
        "answer": 2,
        "correctAnswer": "Slime layer",
        "explanation": "The glycocalyx is an extracellular polysaccharide layer. When it is organized, tightly attached, and uniform, it is called a capsule. The slime layer is a diffuse, loosely bound variant of the glycocalyx, varying in thickness, aiding in biofilm formation, adhesion, and protection from desiccation and phagocytosis. Protoplasm refers to cellular contents, nucleoid to the DNA region.",
        "whyNotOtherOptions": {
            "a": "Protoplasm is the living content of the cell, including cytoplasm and nucleus/nucleoid.",
            "b": "Glycocalyx is the general term; slime layer is a specific type.",
            "d": "Nucleoid is the region containing bacterial DNA."
        },
        "relatedQuestions": ["23"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 15,
        "question": "When a specimen is stained with Gram‚Äôs stain:",
        "options": [
            "Gram positive bacteria resist the decolorization step and retain the color of the primary dye",
            "Gram negative bacteria would appear violet",
            "Gram positive bacteria would be decolorized by ethanol-acetone and would take the color of the counterstain",
            "Gram negative bacteria would take the color of the mordant solution"
        ],
        "answer": 0,
        "correctAnswer": "Gram positive bacteria resist the decolorization step and retain the color of the primary dye",
        "explanation": "Gram staining differentiates bacteria based on cell wall composition. After applying crystal violet (primary dye) and iodine (mordant), the decolorizer (ethanol-acetone) removes the dye from Gram-negative cells due to their thin peptidoglycan and outer membrane, making them colorless until counterstained with safranin (pink). Gram-positive cells, with thick peptidoglycan, retain the violet complex. Mordant (iodine) enhances dye binding but doesn't provide color.",
        "whyNotOtherOptions": {
            "b": "Gram-negative appear pink after counterstain, not violet.",
            "c": "Gram-positive resist decolorization and stay violet, not taking counterstain.",
            "d": "Mordant (iodine) is colorless; Gram-negative take safranin."
        },
        "relatedQuestions": ["11"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 16,
        "question": "Which of the following components is present in gram-negative bacteria but not in gram-positive bacteria?",
        "options": [
            "Peptidoglycan",
            "Lipid A",
            "Capsule",
            "Pilus"
        ],
        "answer": 1,
        "correctAnswer": "Lipid A",
        "explanation": "Lipid A is the toxic component of lipopolysaccharide (LPS, endotoxin) in the outer membrane of Gram-negative bacteria, responsible for septic shock symptoms. Gram-positive bacteria lack an outer membrane and thus lack LPS/Lipid A. Peptidoglycan is in both (thicker in positive), capsules and pili can be present in both types.",
        "whyNotOtherOptions": {
            "a": "Peptidoglycan is present in both, though differing in amount.",
            "c": "Capsules can be found in both Gram-positive and Gram-negative bacteria.",
            "d": "Pili are appendages that can occur in both types."
        },
        "relatedQuestions": ["5", "9"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 17,
        "question": "Which one of the following statements is not true of the bacterial chromosomes?",
        "options": [
            "It is located in the nucleoid",
            "It usually is a single, circular molecule",
            "Some genes are dominant to others",
            "It usually is haploid"
        ],
        "answer": 2,
        "correctAnswer": "Some genes are dominant to others",
        "explanation": "Bacterial chromosomes are typically single, circular DNA molecules located in the nucleoid region, and bacteria are haploid, meaning they have one copy of each gene, eliminating the concept of dominance/recessiveness which applies to diploid organisms with allele pairs. In bacteria, gene expression is regulated differently, such as through operons and environmental signals.",
        "whyNotOtherOptions": {
            "a": "The nucleoid is the area where the chromosome resides in bacteria.",
            "b": "Most bacterial chromosomes are circular and single.",
            "d": "Bacteria are generally haploid with one gene copy."
        },
        "relatedQuestions": ["13"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 18,
        "question": "The point at which the double-stranded DNA molecule unwinds is called:",
        "options": [
            "polymerase",
            "replication fork",
            "hydrogen bonding",
            "ribosome"
        ],
        "answer": 1,
        "correctAnswer": "replication fork",
        "explanation": "During DNA replication, helicase unwinds the double helix at the origin, creating a Y-shaped replication fork where new strands are synthesized by DNA polymerase. Leading and lagging strands form here, with continuous and discontinuous synthesis respectively. Hydrogen bonds are broken during unwinding, ribosomes are for protein synthesis.",
        "whyNotOtherOptions": {
            "a": "Polymerase is the enzyme that synthesizes new DNA strands.",
            "c": "Hydrogen bonding holds DNA strands together but is not the unwinding point.",
            "d": "Ribosomes are involved in translation, not DNA replication."
        },
        "relatedQuestions": [],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 19,
        "question": "A component of the cell membrane of most fungi is:",
        "options": [
            "Cholesterol",
            "Chitin",
            "Ergosterol",
            "Peptidoglycan"
        ],
        "answer": 2,
        "correctAnswer": "Ergosterol",
        "explanation": "Fungal cell membranes contain ergosterol, a sterol that maintains membrane fluidity and integrity, similar to cholesterol in animal cells. This difference is exploited by antifungal drugs like amphotericin B and azoles, which target ergosterol. Chitin is in fungal cell walls, peptidoglycan in bacterial walls, cholesterol in animals.",
        "whyNotOtherOptions": {
            "a": "Cholesterol is found in animal cell membranes, not fungi.",
            "b": "Chitin is a component of fungal cell walls, not membranes.",
            "d": "Peptidoglycan is in bacterial cell walls."
        },
        "relatedQuestions": ["2"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 20,
        "question": "The basic microscopic unit of molds is:",
        "options": [
            "Yeast",
            "Hypha",
            "Mycelium",
            "Pseudohypha"
        ],
        "answer": 1,
        "correctAnswer": "Hypha",
        "explanation": "Molds are filamentous fungi composed of hyphae, which are elongated, tubular structures that grow by apical extension and branch to form a network. A mass of hyphae constitutes the mycelium, the visible mold body. Yeasts are unicellular fungi, pseudohyphae are chains of yeast-like cells.",
        "whyNotOtherOptions": {
            "a": "Yeast are unicellular forms of fungi, not the unit of molds.",
            "c": "Mycelium is the collective mass of hyphae, not the basic unit.",
            "d": "Pseudohyphae are elongated yeast cells, seen in some fungi like Candida."
        },
        "relatedQuestions": [],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 21,
        "question": "Transmission of genetic information between bacterial cells (e.g. resistance to antibiotic) via virus is named ______.",
        "options": [
            "Insertion",
            "Translation",
            "Conjugation",
            "Transduction"
        ],
        "answer": 3,
        "correctAnswer": "Transduction",
        "explanation": "Transduction involves bacteriophages (viruses) transferring bacterial DNA from one cell to another. During lytic infection, viral particles may package host DNA instead of viral genome (generalized transduction) or specific genes (specialized). This transfers traits like antibiotic resistance. Conjugation is direct cell-to-cell transfer, translation is protein synthesis, insertion is DNA integration.",
        "whyNotOtherOptions": {
            "a": "Insertion refers to integrating DNA into a genome, not transfer via virus.",
            "b": "Translation is the process of synthesizing proteins from mRNA.",
            "c": "Conjugation is direct DNA transfer between bacteria via pili."
        },
        "relatedQuestions": ["12"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 22,
        "question": "Microorganism that can grow in the presence as well as in the absence of molecular oxygen is",
        "options": [
            "Obligate anaerobe",
            "Obligate aerobe",
            "Facultative anaerobe",
            "Facultative aerobe"
        ],
        "answer": 2,
        "correctAnswer": "Facultative anaerobe",
        "explanation": "Facultative anaerobes, like E. coli, can switch between aerobic respiration (using oxygen for efficient ATP production) and anaerobic processes (fermentation or anaerobic respiration) without oxygen. They prefer oxygen but survive without it. Obligate aerobes require oxygen, obligate anaerobes are killed by it. 'Facultative aerobe' is not standard; the term is facultative anaerobe.",
        "whyNotOtherOptions": {
            "a": "Obligate anaerobes cannot tolerate oxygen and grow only in its absence.",
            "b": "Obligate aerobes require oxygen for growth and cannot survive without it.",
            "d": "Facultative aerobe is a misnomer; the correct term for oxygen-flexible organisms is facultative anaerobe."
        },
        "relatedQuestions": ["6"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 23,
        "question": "What is the function of bacterial capsule?",
        "options": [
            "Protection of organism from phagocytosis",
            "Helps in adherence of bacteria to surface in its environment",
            "Prevents the bacteria from desiccation",
            "All of the above"
        ],
        "answer": 3,
        "correctAnswer": "All of the above",
        "explanation": "The bacterial capsule, a polysaccharide layer, serves multiple roles as a virulence factor: it inhibits phagocytosis by making the cell slippery to immune cells, promotes adhesion to surfaces for colonization and biofilm formation, and retains water to prevent drying out in harsh environments. These functions enhance survival and pathogenicity in hosts and external settings.",
        "whyNotOtherOptions": {
            "a": "This is one function, but not the only one.",
            "b": "Adherence is a function, but incomplete.",
            "c": "Protection from desiccation is a function, but not exhaustive."
        },
        "relatedQuestions": ["14"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 24,
        "question": "Psychrophilic would be expected to grow",
        "options": [
            "in hot springs",
            "at refrigeration temperatures",
            "on the human body",
            "at low pH."
        ],
        "answer": 1,
        "correctAnswer": "at refrigeration temperatures",
        "explanation": "Psychrophiles are cold-adapted microorganisms with optimal growth at low temperatures (0-15¬∞C), common in polar regions, oceans, and refrigerators. They have adapted membranes and enzymes for function in cold. Hot springs are for thermophiles, human body (37¬∞C) for mesophiles, low pH for acidophiles.",
        "whyNotOtherOptions": {
            "a": "Hot springs are habitats for thermophiles, not psychrophiles.",
            "c": "Human body temperature suits mesophiles.",
            "d": "Low pH is for acidophiles; psychrophiles are temperature-specific."
        },
        "relatedQuestions": [],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 25,
        "question": "A virus is made up of ______.",
        "options": [
            "Protein coat and nucleic acid",
            "Protein coat and mitochondria",
            "Nucleic acid and cell membrane",
            "Nucleic acid, cell wall and cell membrane"
        ],
        "answer": 0,
        "correctAnswer": "Protein coat and nucleic acid",
        "explanation": "Viruses are simple entities consisting of genetic material (DNA or RNA) encased in a protein coat (capsid). Some have a lipid envelope derived from host membranes. They lack organelles like mitochondria, cell walls, or membranes of their own, relying on hosts for replication. This minimal structure underscores their obligate parasitic nature.",
        "whyNotOtherOptions": {
            "b": "Mitochondria are eukaryotic organelles; viruses lack them.",
            "c": "Viruses do not have their own cell membrane.",
            "d": "Viruses lack cell walls and independent cell membranes."
        },
        "relatedQuestions": ["3", "26"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 26,
        "question": "The protein coat of viruses that enclose the genetic material is called ______.",
        "options": [
            "Virion",
            "Capsid",
            "Peplomers",
            "Capsomers"
        ],
        "answer": 1,
        "correctAnswer": "Capsid",
        "explanation": "The capsid is the protective protein shell surrounding the viral nucleic acid, composed of subunits called capsomers. It determines viral shape (helical, icosahedral) and facilitates attachment to host cells. Peplomers are spike proteins on envelopes, virion is the complete particle.",
        "whyNotOtherOptions": {
            "a": "Virion refers to the entire infectious virus particle.",
            "c": "Peplomers are glycoprotein spikes on enveloped viruses.",
            "d": "Capsomers are the building blocks of the capsid."
        },
        "relatedQuestions": ["25", "30"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 27,
        "question": "Which of the following statements are true about a virion?",
        "options": [
            "Lytic phage",
            "Lysogenic phage",
            "The viral capsid",
            "An infectious and fully formed viral particle"
        ],
        "answer": 3,
        "correctAnswer": "An infectious and fully formed viral particle",
        "explanation": "A virion is the extracellular, infectious form of a virus, comprising the genome, capsid, and possibly an envelope. It is capable of infecting host cells to initiate replication. Lytic and lysogenic refer to phage cycles, capsid is a component.",
        "whyNotOtherOptions": {
            "a": "Lytic phage describes a replication cycle, not the particle.",
            "b": "Lysogenic phage integrates into host DNA, not defining virion.",
            "c": "Capsid is part of the virion, not the whole."
        },
        "relatedQuestions": ["25", "26"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 28,
        "question": "Which of the following is the genome of the virus?",
        "options": [
            "DNA",
            "RNA",
            "DNA or RNA",
            "DNA and RNA"
        ],
        "answer": 2,
        "correctAnswer": "DNA or RNA",
        "explanation": "Viral genomes are either DNA or RNA, but never both in the same virus. DNA viruses replicate in the nucleus or cytoplasm, RNA viruses typically in cytoplasm. This exclusivity is a defining feature, differing from cellular organisms which use DNA genomes and RNA intermediates.",
        "whyNotOtherOptions": {
            "a": "Some viruses have DNA, but not all.",
            "b": "Some have RNA, but not all.",
            "d": "No virus contains both DNA and RNA as genome."
        },
        "relatedQuestions": ["3"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 29,
        "question": "Which of the following statements are true about the viruses?",
        "options": [
            "Free-living",
            "Obligate parasites",
            "Both (a) and (b)",
            "None of the above"
        ],
        "answer": 1,
        "correctAnswer": "Obligate parasites",
        "explanation": "Viruses cannot replicate independently; they must infect a host cell to utilize its metabolic and replicative machinery. They lack ribosomes, energy production systems, and are not free-living. This obligate intracellular parasitism distinguishes them from other microorganisms.",
        "whyNotOtherOptions": {
            "a": "Viruses are not free-living; they require hosts.",
            "c": "Only obligate parasites is correct, not both.",
            "d": "Obligate parasites is true."
        },
        "relatedQuestions": ["3"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 30,
        "question": "Which of the following are the main functions of the capsid?",
        "options": [
            "Determines the antigenic specificity of the virus",
            "Protects genetic material from nuclease attack",
            "Both A and B",
            "None of these"
        ],
        "answer": 2,
        "correctAnswer": "Both A and B",
        "explanation": "The capsid shields the viral genome from environmental nucleases and physical damage, ensuring integrity until infection. It also bears antigenic determinants recognized by the host immune system, influencing vaccine design and immune response. Additionally, it aids in host cell attachment.",
        "whyNotOtherOptions": {
            "a": "This is one function, but not the only main one.",
            "b": "Protection is key, but antigenic specificity is also important.",
            "d": "Both functions are correct."
        },
        "relatedQuestions": ["26"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 31,
        "question": "Positive stranded RNA viruses have which of the following characteristics?",
        "options": [
            "Their genome RNA can be translated directly as mRNA",
            "They have to transcribe their genome RNA to a mirror image copy as a mRNA",
            "This genome is circular",
            "Their RNA genome is segmented"
        ],
        "answer": 0,
        "correctAnswer": "Their genome RNA can be translated directly as mRNA",
        "explanation": "Positive-sense (+) RNA viruses have genomes that mimic mRNA, with 5' cap and 3' poly-A tail in some, allowing immediate translation by host ribosomes upon entry. Examples include picornaviruses, flaviviruses. Negative-sense (-) RNA viruses require transcription to +RNA first. Most viral RNA genomes are linear, not circular; segmentation occurs in some like influenza.",
        "whyNotOtherOptions": {
            "b": "This describes negative-strand RNA viruses.",
            "c": "Viral RNA genomes are typically linear, not circular (except some like viroids).",
            "d": "Segmentation is specific to certain viruses, not a general characteristic of +RNA."
        },
        "relatedQuestions": ["28"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 32,
        "question": "A virus obtains its envelope during which of the following phases?",
        "options": [
            "attachment",
            "penetration",
            "assembly",
            "release"
        ],
        "answer": 3,
        "correctAnswer": "release",
        "explanation": "Enveloped viruses acquire their lipid envelope from host membranes (plasma, nuclear, or ER) during release via budding. The capsid assembles inside, then pushes through the membrane, incorporating viral glycoproteins. Attachment is binding to receptors, penetration is entry, assembly is component formation.",
        "whyNotOtherOptions": {
            "a": "Attachment is the initial binding to host cell receptors.",
            "b": "Penetration involves entry of viral contents into the cell.",
            "c": "Assembly is intracellular formation of virions without envelope acquisition."
        },
        "relatedQuestions": ["33"],
        "category": "Microbiology",
        "difficulty": "Medium"
    },
    {
        "id": 33,
        "question": "What is another name for a non-enveloped virus?",
        "options": [
            "enveloped virus",
            "provirus",
            "naked virus",
            "latent virus"
        ],
        "answer": 2,
        "correctAnswer": "naked virus",
        "explanation": "Non-enveloped (naked) viruses consist only of nucleic acid and capsid, without a lipid envelope. They are more resistant to environmental stresses like heat and detergents but enter cells differently (e.g., endocytosis). Enveloped have lipids, provirus is integrated viral DNA, latent is dormant infection.",
        "whyNotOtherOptions": {
            "a": "Enveloped viruses have a lipid coat.",
            "b": "Provirus refers to viral genome integrated into host DNA.",
            "d": "Latent virus is in a dormant state within the host."
        },
        "relatedQuestions": ["32"],
        "category": "Microbiology",
        "difficulty": "Easy"
    },
    {
        "id": 34,
        "question": "In naming viruses, the family name ends with ______ and genus name ends with ______.",
        "options": [
            "-virus; -viridae",
            "-viridae; -virus",
            "-virion; virus",
            "-virus; virion"
        ],
        "answer": 1,
        "correctAnswer": "-viridae; -virus",
        "explanation": "Viral taxonomy follows ICTV conventions: family names end in -viridae (e.g., Retroviridae), genus in -virus (e.g., Lentivirus). Species are often descriptive. Virion is the particle, not a taxonomic suffix.",
        "whyNotOtherOptions": {
            "a": "This reverses the suffixes; -viridae for family, -virus for genus.",
            "c": "-Virion is not a taxonomic ending; virion is the physical particle.",
            "d": "Virion is not used in naming conventions this way."
        },
        "relatedQuestions": ["8"],
        "category": "Microbiology",
        "difficulty": "Medium"
    }
];

// Core application variables
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const categoriesGrid = document.getElementById('categoriesGrid');
const themeToggle = document.getElementById('themeToggle');
const quizContainer = document.getElementById('quizContainer');
const resultsScreen = document.getElementById('resultsScreen');
const pageTitle = document.getElementById('pageTitle');
const modeButtons = document.querySelectorAll('.mode-btn');
const correctAnswersEl = document.getElementById('correctAnswers');
const timeSpentEl = document.getElementById('timeSpent');
const masteryLevelEl = document.getElementById('masteryLevel');
const streakCountEl = document.getElementById('streakCount');
const searchInput = document.getElementById('searchInput');
const exportProgressBtn = document.getElementById('exportProgress');
const createCustomQuizBtn = document.getElementById('createCustomQuizBtn');
const customQuizModal = document.getElementById('customQuizModal');
const cancelCustomQuizBtn = document.getElementById('cancelCustomQuiz');
const createCustomQuizBtnModal = document.getElementById('createCustomQuiz');
const weakAreasCountEl = document.getElementById('weakAreasCount');
const avgTimePerQuestionEl = document.getElementById('avgTimePerQuestion');
const improvementRateEl = document.getElementById('improvementRate');

// Navigation elements
const navItems = document.querySelectorAll('.nav-item');

// Application state
let currentMode = 'exam';
let selectedCategories = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let questions = [];
let incorrectQuestions = [];
let isAnswerChecked = false;
let bookmarkedQuestions = new Set();
let userProgress = {};
let userStats = {
    totalQuestions: 0,
    correctAnswers: 0,
    timeSpent: 0,
    masteryLevel: 0,
    streak: 0,
    lastActive: null,
    weeklyProgress: []
};
let timerInterval = null;
let startTime = null;
let remainingTime = 0;
let isCountdown = false;
let examCheckMode = 'immediate';
let examSubmitted = false;
let questionTimers = [];
let searchResults = [];
let isSearchActive = false;
let currentPage = 'Dashboard';
let customQuestions = [];

// Core application functions
function init() {
    initializeCategories();
    initializeEventListeners();
    initializeNavigation();
    loadUserData();
    updateDashboardStats();
    updateAnalytics();
    showDashboard();
    createFAB();
    updateCustomQuizModalHTML();
}

function createFAB() {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '<i class="fas fa-plus"></i>';
    fab.title = 'Create Custom Question';
    fab.addEventListener('click', showCustomQuestionCreator);
    document.body.appendChild(fab);
}

function initializeNavigation() {
    navItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            switch(index) {
                case 0: // Dashboard
                    currentPage = 'Dashboard';
                    showDashboard();
                    break;
                case 1: // My Courses
                    currentPage = 'courses';
                    showCourses();
                    break;
                case 2: // Progress Analytics
                    currentPage = 'analytics';
                    showAnalytics();
                    break;
                case 3: // Bookmarked Questions
                    currentPage = 'bookmarks';
                    showBookmarks();
                    break;
                case 4: // Settings
                    currentPage = 'settings';
                    showSettings();
                    break;
            }
            
            closeSidebar();
        });
    });
}

function showDashboard() {
    console.log('showDashboard called'); // Debug
    
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.search-container').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    
    // Reset page title
    pageTitle.textContent = 'Dashboard';
    updateDashboardStats();
    
    // ALWAYS load questions and show quiz layout
    questions = [...quizData, ...customQuestions];
    selectedCategories = [...new Set(questions.map(q => q.category))];
    
    // Reset quiz state
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    console.log('Questions loaded:', questions.length);
    console.log('Current mode:', currentMode);
    
    // Force show quiz container
    quizContainer.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    
    if (questions.length > 0) {
        console.log('Calling renderQuizLayout...');
        renderQuizLayout();
    } else {
        console.log('No questions, showing message');
        showNoQuestionsMessage();
    }
}

function showCourses() {
    hideAllSections();
    pageTitle.textContent = 'My Courses';
    
    quizContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Learning Pathways</h2>
            <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                Structured learning paths designed to build your medical knowledge systematically.
            </p>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 40px;">
                    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Anatomy Mastery', 'fas fa-brain', '#6366f1', 75, 'Build foundational anatomy knowledge')}
                    </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Physiology Deep Dive', 'fas fa-heartbeat', '#06b6d4', 45, 'Understand body systems and functions')}
                   </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Clinical Pathology', 'fas fa-virus', '#10b981', 30, 'Study diseases and diagnostics')}
                    </div> 
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Pharmacology', 'fas fa-pills', '#f59e0b', 20, 'Master drug mechanisms and effects')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Medical Imaging', 'fas fa-x-ray', '#8b5cf6', 15, 'Learn radiology and imaging techniques')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Emergency Medicine', 'fas fa-ambulance', '#ef4444', 10, 'Critical care and emergency procedures')}
                    </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createCourseCard(title, icon, color, progress, description) {
    return `
        <div class="category-card" style="text-align: left; cursor: pointer; border-left: 4px solid ${color};" onclick="startCourse('${title.toLowerCase()}')">
            <div class="category-header">
                <div class="category-icon" style="background: ${color}20; color: ${color};">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <div class="category-name" style="font-size: 16px; font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${description}</div>
                </div>
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${color}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                <span style="font-size: 11px; color: var(--text-tertiary);">${Math.floor(progress/10)}/10 Modules</span>
                <span style="font-size: 11px; color: ${color}; font-weight: 600;">Continue ‚Üí</span>
            </div>
        </div>
    `;
}

function showAnalytics() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    pageTitle.textContent = 'Progress Analytics';
    updateAnalytics();
    
    quizContainer.innerHTML = `
        <div style="padding: 24px;">
            <div class="analytics-section glass-effect" style="border-radius: 24px; padding: 32px;">
                <h3 class="analytics-title" style="font-size: 24px; margin-bottom: 8px;">Performance Insights</h3>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">Detailed analytics to optimize your learning journey</p>
                <div class="analytics-grid">
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: var(--primary);">${weakAreasCountEl.textContent}</div>
                        <div class="analytics-label">Areas Needing Focus</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #06b6d4;">${avgTimePerQuestionEl.textContent}</div>
                        <div class="analytics-label">Average Response Time</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #10b981;">${improvementRateEl.textContent}</div>
                        <div class="analytics-label">Weekly Progress Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">üìä Learning Recommendations</h3>
                <div style="display: grid; gap: 16px;">
                    ${createRecommendation('Focus on Weak Areas', 'fas fa-bullseye', 'var(--primary)', 'Spend 60% of study time on topics below 70% mastery')}
                    ${createRecommendation('Consistent Practice', 'fas fa-chart-line', '#10b981', `Maintain your ${userStats.streak}-day streak for optimal retention`)}
                    ${createRecommendation('Active Recall', 'fas fa-brain', '#8b5cf6', 'Use spaced repetition for better long-term memory')}
                    ${createRecommendation('Mixed Practice', 'fas fa-random', '#f59e0b', 'Combine different topics in single study sessions')}
                </div>
            </div>

            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">üéØ Study Plan</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    ${createStudyPlanItem('Daily Goal', '50 questions', 'fas fa-calendar-day', '#6366f1')}
                    ${createStudyPlanItem('Weekly Target', '5 hours', 'fas fa-chart-bar', '#06b6d4')}
                    ${createStudyPlanItem('Mastery Goal', '85% overall', 'fas fa-trophy', '#f59e0b')}
                    ${createStudyPlanItem('Weak Topics', '2 sessions/week', 'fas fa-exclamation-triangle', '#ef4444')}
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createRecommendation(title, icon, color, description) {
    return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border-left: 4px solid ${color};">
            <i class="${icon}" style="color: ${color}; font-size: 24px;"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${description}</div>
            </div>
        </div>
    `;
}

function createStudyPlanItem(title, value, icon, color) {
    return `
        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
            <i class="${icon}" style="color: ${color}; font-size: 32px; margin-bottom: 12px;"></i>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
            <div style="font-size: 18px; color: ${color}; font-weight: 700;">${value}</div>
        </div>
    `;
}

function showBookmarks() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    hideAllSections();
    pageTitle.textContent = 'Bookmarked Questions';
    
    if (bookmarkedQuestionsList.length === 0) {
        quizContainer.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 96px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                    <i class="far fa-bookmark"></i>
                </div>
                <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">No Bookmarked Questions Yet</h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                    Click the bookmark icon on any question to save it here for quick review. This is perfect for difficult concepts or important topics you want to revisit.
                </p>
                <button class="quiz-btn" onclick="showDashboard(); navItems[0].click()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 32px; border-radius: 16px;">
                    <i class="fas fa-arrow-left"></i>
                    Explore Questions
                </button>
            </div>
        `;
    } else {
        quizContainer.innerHTML = `
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                            ${bookmarkedQuestionsList.length} Saved Question${bookmarkedQuestionsList.length !== 1 ? 's' : ''}
                        </h2>
                        <p style="color: var(--text-secondary);">Your personal collection of important questions</p>
                    </div>
                    <button class="quiz-btn" onclick="startBookmarksQuiz()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px;">
                        <i class="fas fa-play"></i>
                        Practice Bookmarks
                    </button>
                </div>
                <div style="display: grid; gap: 20px;">
                    ${bookmarkedQuestionsList.map(question => `
                        <div class="question-card glass-effect" style="cursor: pointer; border-radius: 20px; padding: 24px;" onclick="jumpToBookmarkQuestion(${question.id})">
                            <div class="question-header">
                                <div class="question-meta">
                                    <div class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Q${question.id}</div>
                                    <div class="question-category glass-effect">${question.category}</div>
                                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                        ${question.difficulty}
                                    </div>
                                    ${question.custom ? '<div class="question-category glass-effect" style="background: #10b98120; color: #10b981;">Custom</div>' : ''}
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn bookmark-btn" onclick="event.stopPropagation(); toggleBookmark(${question.id}); showBookmarks();" aria-label="Remove Bookmark" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="question-text" style="font-size: 16px; line-height: 1.6;">${question.question}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    quizContainer.classList.remove('hidden');
}

// Add this function to handle clicking on individual bookmark questions
function jumpToBookmarkQuestion(questionId) {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    // Start a quiz with just this one question
    questions = [bookmarkedQuestionsList.find(q => q.id === questionId)];
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Question';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

function showSettings() {
    hideAllSections();
    pageTitle.textContent = 'Settings & Preferences';
    
    quizContainer.innerHTML = `
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">üé® Appearance</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Customize the look and feel of your study environment</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Theme</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? '' : 'active'}" onclick="setTheme('light')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-sun"></i>
                                Light Mode
                            </button>
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? 'active' : ''}" onclick="setTheme('dark')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-moon"></i>
                                Dark Mode
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Animation</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn active" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-bolt"></i>
                                Smooth
                            </button>
                            <button class="mode-btn" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-minus"></i>
                                Minimal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">‚ö° Study Preferences</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Optimize your learning experience</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Default Mode</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${currentMode === 'quiz' ? 'active' : ''}" onclick="setDefaultMode('quiz')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-tasks"></i>
                                Quiz
                            </button>
                            <button class="mode-btn ${currentMode === 'exam' ? 'active' : ''}" onclick="setDefaultMode('exam')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-file-alt"></i>
                                Exam
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Questions Per Session</label>
                        <select class="modern-dropdown" style="width: 100%;" onchange="setQuestionsPerSession(this.value)">
                            <option value="10">10 Questions</option>
                            <option value="25" selected>25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">üìä Data & Progress</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Manage your learning data</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="quiz-btn" onclick="exportProgress()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-download" style="margin-right: 12px;"></i>
                         
                    </button>
                    <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-plus" style="margin-right: 12px;"></i>
                        Create Custom Question
                    </button>
                    <button class="quiz-btn" onclick="resetProgress()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-trash" style="margin-right: 12px;"></i>
                        Reset All Progress
                    </button>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">‚ÑπÔ∏è About ALIF</h3>
                <div style="color: var(--text-secondary); line-height: 1.7;">
                    <p>ALIF is an advanced medical education platform designed to help medical students and professionals enhance their knowledge through interactive quizzes and detailed analytics.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                        <div>
                            <strong style="color: var(--text-primary);">Version</strong>
                            <div>2.1.0</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Questions</strong>
                            <div>${quizData.length + customQuestions.length} total</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Last Updated</strong>
                            <div>${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function setTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-moon';
    }
    showNotification(`Theme set to ${theme} mode`, 'success');
}

function setDefaultMode(mode) {
    currentMode = mode;
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[mode === 'quiz' ? 1 : 0].classList.add('active');
    showNotification(`Default mode set to ${mode}`, 'success');
}

function setQuestionsPerSession(count) {
    showNotification(`Questions per session set to ${count === '0' ? 'all' : count}`, 'info');
}

function showCustomQuestionCreator() {
    const modal = document.createElement('div');
    modal.className = 'custom-quiz-modal active';
    modal.innerHTML = `
        <div class="custom-quiz-content glass-effect" style="max-width: 600px; border-radius: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Create Custom Question</h3>
                <button class="action-btn" onclick="closeCustomQuestionModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-question-creator">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Question Text (Markdown supported for tables)</label>
                        <textarea id="customQuestionText" placeholder="Enter your question here... Use Markdown for tables, e.g., | Col1 | Col2 |" style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 100px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Image URL (optional)</label>
                        <input type="url" id="customImageUrl" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Category</label>
                        <select id="customQuestionCategory" class="modern-dropdown" style="width: 100%;">
                            <option value="Custom Anatomy">Custom Anatomy</option>
                            <option value="Custom Physiology">Custom Physiology</option>
                            <option value="Custom Pathology">Custom Pathology</option>
                            <option value="Custom Pharmacology">Custom Pharmacology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Difficulty</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button type="button" class="mode-btn difficulty-btn active" data-difficulty="Easy" style="border-radius: 12px; padding: 12px 16px;">
                                Easy
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Medium" style="border-radius: 12px; padding: 12px 16px;">
                                Medium
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Hard" style="border-radius: 12px; padding: 12px 16px;">
                                Hard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Options</label>
                        <div style="display: grid; gap: 12px;">
                            ${['A', 'B', 'C', 'D'].map(letter => `
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">${letter}</div>
                                    <input type="text" id="customOption${letter}" placeholder="Option ${letter}" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text-primary);">
                                    <input type="radio" name="correctAnswer" value="${letter}" id="correct${letter}" style="transform: scale(1.2);">
                                    <label for="correct${letter}" style="color: var(--text-secondary); font-weight: 600;">Correct</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Explanation</label>
                        <textarea id="customExplanation" placeholder="Explain why the correct answer is right..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                </div>
                
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
                    <button class="quiz-btn" onclick="closeCustomQuestionModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        Cancel
                    </button>
                    <button class="quiz-btn check-btn" onclick="saveCustomQuestion()" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-save"></i>
                        Save Question
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add difficulty button handlers
    modal.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function closeCustomQuestionModal() {
    const modal = document.querySelector('.custom-quiz-modal');
    if (modal) {
        modal.remove();
    }
}

function saveCustomQuestion() {
    const questionText = document.getElementById('customQuestionText').value;
    const imageUrl = document.getElementById('customImageUrl').value || '';
    const category = document.getElementById('customQuestionCategory').value;
    const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    const explanation = document.getElementById('customExplanation').value;
    
    // Get options
    const options = [];
    for (let letter of ['A', 'B', 'C', 'D']) {
        const optionText = document.getElementById(`customOption${letter}`).value;
        if (optionText.trim()) {
            options.push(optionText);
        }
    }
    
    // Get correct answer
    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
    if (!correctAnswerRadio) {
        showNotification('Please select the correct answer', 'error');
        return;
    }
    
    const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerRadio.value);
    
    if (!questionText.trim() || options.length < 2) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Generate a unique ID for the custom question
    const maxId = Math.max(
        ...quizData.map(q => q.id),
        ...customQuestions.map(q => q.id),
        0
    );
    
    const newQuestion = {
        id: maxId + 1,
        question: questionText,
        options: options,
        answer: correctAnswerIndex,
        correctAnswer: options[correctAnswerIndex],
        explanation: explanation || 'No explanation provided.',
        whyNotOtherOptions: {},
        relatedQuestions: [],
        category: category,
        difficulty: difficulty,
        custom: true,
        image: imageUrl
    };
    
    customQuestions.push(newQuestion);
    saveUserData();
    
    closeCustomQuestionModal();
    showNotification('Custom question created successfully!', 'success');
    
    // Refresh the current view and categories
    initializeCategories();
    if (currentPage === 'Dashboard') {
        showDashboard();
    } else if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}

function hideAllSections() {
    quizContainer.classList.add('hidden');
    resultsScreen.classList.add('hidden');
    document.querySelector('.stats-grid').style.display = 'none';
    document.querySelector('.analytics-section').style.display = 'none';
    document.querySelector('.export-section').style.display = 'none';
    // Note: search-container is NOT hidden here - we want it always visible during search
}

function startCourse(courseName) {
    showNotification(`Starting ${courseName} course...`, 'info');
    // Filter questions by course/category and start quiz
    const courseQuestions = [...quizData, ...customQuestions].filter(q => 
        q.category.toLowerCase().includes(courseName.toLowerCase())
    );
    
    if (courseQuestions.length === 0) {
        showNotification('No questions available for this course yet', 'info');
        return;
    }
    
    questions = courseQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active');
    pageTitle.textContent = `Quiz Mode - ${courseName}`;
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

// FIXED BOOKMARK PRACTICE FUNCTION
function startBookmarksQuiz() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    if (bookmarkedQuestionsList.length === 0) {
        showNotification('No bookmarked questions to practice!', 'error');
        return;
    }
    
    questions = bookmarkedQuestionsList;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Questions';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    
    showNotification(`Starting practice with ${questions.length} bookmarked questions`, 'success');
}

function resetProgress() {
    if (confirm('Are you sure you want to reset all your progress? This action cannot be undone.')) {
        userProgress = {};
        userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: new Date().toISOString(),
            weeklyProgress: []
        };
        bookmarkedQuestions = new Set();
        customQuestions = [];
        saveUserData();
        updateDashboardStats();
        updateAnalytics();
        showNotification('All progress has been reset', 'success');
        showDashboard();
    }
}

function initializeEventListeners() {
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
            pageTitle.textContent = `${btn.dataset.mode.charAt(0).toUpperCase() + btn.dataset.mode.slice(1)} Mode`;
            startQuiz();
        });
    });
    
    initializeEnhancedFeatures();
    document.getElementById('backBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // Use browser back navigation
        window.history.back();
    });
}
function updateBackButton() {
    const backBtn = document.getElementById('backBtn');
    // Show back button if there's history to go back to
    if (window.history.length > 1) {
        backBtn.style.display = 'flex';
    } else {
        backBtn.style.display = 'none';
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    mainContent.classList.toggle('sidebar-open');
    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
    document.body.style.overflow = '';
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

function initializeEnhancedFeatures() {
    initializeSearch();
    initializeKeyboardNavigation();
    enhanceAccessibility();
    
    exportProgressBtn.addEventListener('click', exportProgress);
    createCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.add('active');
    });
    cancelCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.remove('active');
    });
    createCustomQuizBtnModal.addEventListener('click', () => {
        const selectedOptions = document.querySelectorAll('.custom-quiz-option.selected');
        const options = {
            categories: selectedCategories,
            difficulty: null,
            bookmarkedOnly: false
        };
        
        selectedOptions.forEach(option => {
            const category = option.dataset.category;
            if (category === 'easy' || category === 'medium' || category === 'hard') {
                options.difficulty = category;
            } else if (category === 'bookmarked') {
                options.bookmarkedOnly = true;
            }
        });
        
        createCustomQuiz(options);
    });
    
    // Add selection toggling for custom quiz options
    document.addEventListener('click', (e) => {
        if (e.target.closest('.custom-quiz-option')) {
            const option = e.target.closest('.custom-quiz-option');
            option.classList.toggle('selected');
        }
    });
    
    // Ensure search works when clicking Dashboard
    navItems[0].addEventListener('click', () => {
        if (searchInput.value.trim().length > 0) {
            // If there's a search query, maintain search state
            isSearchActive = true;
        }
    });
}

// FIXED SEARCH FUNCTIONALITY
function initializeSearch() {
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            // Clear previous search state when input is empty
            if (query.length === 0) {
                document.body.classList.remove('search-blur-active');
                isSearchActive = false;
                if (currentPage === 'Dashboard') {
                    showDashboard();
                }
                return;
            }
            
            // Add blur effect when searching
            document.body.classList.add('search-blur-active');
            
            if (query.length < 2) {
                isSearchActive = false;
                return;
            }
            
            isSearchActive = true;
            performSearch(query);
        });
        
        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    }
}

function performSearch(query) {
    const allQuestions = [...quizData, ...customQuestions];
    searchResults = allQuestions.filter(q => 
        q.question.toLowerCase().includes(query) ||
        q.category.toLowerCase().includes(query) ||
        (q.explanation && q.explanation.toLowerCase().includes(query)) ||
        q.options.some(opt => opt.toLowerCase().includes(query))
    );
    
    console.log('Search query:', query, 'Results:', searchResults.length); // Debug log
    
    if (searchResults.length > 0) {
        // Show search results in quiz layout
        questions = searchResults;
        currentQuestionIndex = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        
        hideAllSections();
        quizContainer.classList.remove('hidden');
        renderQuizLayout();
        
        // Update page title to show search context
        pageTitle.textContent = `Search: "${query}" (${searchResults.length} results)`;
        
        // Highlight search terms
        setTimeout(() => {
            highlightSearchTerms(query);
        }, 100);
    } else {
        // Show no results message
        showSearchNoResults(query);
    }
}

function showSearchNoResults(query) {
    hideAllSections();
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-search"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Results Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                No questions match your search for "<strong style="color: var(--primary);">${query}</strong>". Try different keywords or browse categories.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Clear Search
                </button>
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Browse Categories
                </button>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
    pageTitle.textContent = `Search: "${query}" (0 results)`;
}

function clearSearch() {
    searchInput.value = '';
    document.body.classList.remove('search-blur-active');
    isSearchActive = false;
    showDashboard();
}

function highlightSearchTerms(query) {
    const questionTexts = document.querySelectorAll('.question-text');
    const optionTexts = document.querySelectorAll('.option-text');
    const categoryElements = document.querySelectorAll('.question-category');
    
    const highlightText = (element) => {
        const originalText = element.innerHTML;  // Use innerHTML to preserve Markdown
        const regex = new RegExp(`(${query})`, 'gi');
        const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
        element.innerHTML = highlighted;
    };
    
    questionTexts.forEach(highlightText);
    optionTexts.forEach(highlightText);
    categoryElements.forEach(highlightText);
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                navigateOptions(e.key === 'ArrowDown' ? 1 : -1);
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option:not(.disabled)');
                if (options[index]) {
                    options[index].click();
                }
                break;
            case 'Escape':
                if (document.querySelector('.custom-quiz-modal')) {
                    document.querySelector('.custom-quiz-modal').remove();
                }
                break;
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const currentIndex = Array.from(options).findIndex(opt => opt === document.activeElement);
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    options[nextIndex].focus();
}

function enhanceAccessibility() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('option')) {
            const options = e.target.parentElement.querySelectorAll('.option');
            options.forEach((opt, index) => {
                opt.setAttribute('aria-checked', opt.classList.contains('selected') ? 'true' : 'false');
                opt.setAttribute('role', 'radio');
                opt.setAttribute('tabindex', '0');
            });
        }
    });
}

function loadUserData() {
    const savedProgress = localStorage.getItem('mediQuizProgress');
    const savedStats = localStorage.getItem('mediQuizStats');
    const savedBookmarks = localStorage.getItem('mediQuizBookmarks');
    const savedCustomQuestions = localStorage.getItem('mediQuizCustomQuestions');
    
    if (savedProgress) {
        userProgress = JSON.parse(savedProgress);
    }
    if (savedStats) {
        userStats = JSON.parse(savedStats);
        const today = new Date().toDateString();
        const lastActive = new Date(userStats.lastActive).toDateString();
        if (lastActive !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastActive === yesterday.toDateString()) {
                userStats.streak++;
            } else {
                userStats.streak = 1;
            }
        }
    }
    if (savedBookmarks) {
        bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
    }
    if (savedCustomQuestions) {
        customQuestions = JSON.parse(savedCustomQuestions);
    }
    
    userStats.lastActive = new Date().toISOString();
    saveUserData();
}

function saveUserData() {
    localStorage.setItem('mediQuizProgress', JSON.stringify(userProgress));
    localStorage.setItem('mediQuizStats', JSON.stringify(userStats));
    localStorage.setItem('mediQuizBookmarks', JSON.stringify(Array.from(bookmarkedQuestions)));
    localStorage.setItem('mediQuizCustomQuestions', JSON.stringify(customQuestions));
}

function updateDashboardStats() {
    correctAnswersEl.textContent = userStats.correctAnswers;
    timeSpentEl.textContent = `${Math.floor(userStats.timeSpent / 60)}h ${userStats.timeSpent % 60}m`;
    masteryLevelEl.textContent = `${userStats.masteryLevel}%`;
    streakCountEl.textContent = userStats.streak;
}

function updateAnalytics() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => allQuestions.find(q => q.id == id)?.category)
        .reduce((acc, category) => {
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        
    weakAreasCountEl.textContent = Object.keys(weakAreas).length;
    
    const totalTime = userStats.timeSpent * 60;
    const avgTime = userStats.totalQuestions > 0 ? Math.round(totalTime / userStats.totalQuestions) : 0;
    avgTimePerQuestionEl.textContent = `${avgTime}s`;
    
    if (userStats.weeklyProgress.length > 1) {
        const latest = userStats.weeklyProgress[userStats.weeklyProgress.length - 1];
        const previous = userStats.weeklyProgress[userStats.weeklyProgress.length - 2];
        const improvement = ((latest - previous) / previous) * 100;
        improvementRateEl.textContent = `${Math.round(improvement)}%`;
    } else {
        improvementRateEl.textContent = "0%";
    }
}

function exportProgress() {
    const data = {
        progress: userProgress,
        stats: userStats,
        bookmarks: Array.from(bookmarkedQuestions),
        customQuestions: customQuestions,
        exportDate: new Date().toISOString(),
        analytics: generateStudyReport()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mediquiz-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Progress data exported successfully!', 'success');
}

function createCustomQuiz(options) {
    let filteredQuestions = [...quizData, ...customQuestions];
    
    if (options.categories && options.categories.length > 0) {
        filteredQuestions = filteredQuestions.filter(q => options.categories.includes(q.category));
    }
    
    if (options.difficulty) {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty.toLowerCase() === options.difficulty);
    }
    
    if (options.bookmarkedOnly) {
        filteredQuestions = filteredQuestions.filter(q => bookmarkedQuestions.has(q.id));
    }
    
    if (options.count && options.count > 0) {
        filteredQuestions = shuffleArray(filteredQuestions).slice(0, options.count);
    }
    
    questions = filteredQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    customQuizModal.classList.remove('active');
    showNotification(`Custom quiz created with ${questions.length} questions`, 'success');
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}


function generateStudyReport() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    const strongAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) >= 0.8)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    return {
        weakAreas,
        strongAreas,
        totalMastered: Object.values(userProgress).filter(p => p.correct >= 3).length,
        totalQuestions: allQuestions.length,
        masteryPercentage: calculateMasteryLevel(),
        generatedAt: new Date().toISOString()
    };
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 20px 28px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
        color: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
        max-width: 400px;
        line-height: 1.5;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="font-size: 20px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

function initializeCategories() {
    const allQuestions = [...quizData, ...customQuestions];
    const categories = [...new Set(allQuestions.map(q => q.category))];
    const categoryIcons = {
        "Anatomy Fundamentals": "fas fa-brain",
        "Neuroanatomy": "fas fa-brain",
        "Gastrointestinal System": "fas fa-stomach",
        "Cardiovascular System": "fas fa-heart",
        "Custom Anatomy": "fas fa-user-md",
        "Custom Physiology": "fas fa-heartbeat",
        "Custom Pathology": "fas fa-virus",
        "Custom Pharmacology": "fas fa-pills",
        "General Medicine": "fas fa-stethoscope"
    };
    
    const categoryColors = {
        "Anatomy Fundamentals": "#6366f1",
        "Neuroanatomy": "#06b6d4",
        "Gastrointestinal System": "#10b981",
        "Cardiovascular System": "#ef4444",
        "Custom Anatomy": "#8b5cf6",
        "Custom Physiology": "#f59e0b",
        "Custom Pathology": "#ec4899",
        "Custom Pharmacology": "#84cc16",
        "General Medicine": "#64748b"
    };

    categoriesGrid.innerHTML = '';
    categories.forEach(category => {
        const categoryQuestions = allQuestions.filter(q => q.category === category);
        const mastered = categoryQuestions.filter(q =>
            userProgress[q.id] && userProgress[q.id].correct >= 3
        ).length;
        const progress = categoryQuestions.length > 0 ?
            Math.round((mastered / categoryQuestions.length) * 100) : 0;
            
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card active glass-effect';
        categoryCard.dataset.category = category;
        categoryCard.style.borderLeft = `4px solid ${categoryColors[category] || '#6366f1'}`;
        categoryCard.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background: ${categoryColors[category] || '#6366f1'}20; color: ${categoryColors[category] || '#6366f1'}">
                    <i class="${categoryIcons[category] || 'fas fa-question'}"></i>
                </div>
                <div class="category-name">${category}</div>
                ${category.includes('Custom') ? '<div style="font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 8px;">Custom</div>' : ''}
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${categoryColors[category] || '#6366f1'}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${categoryQuestions.length} question${categoryQuestions.length !== 1 ? 's' : ''}
                ${categoryQuestions.filter(q => q.custom).length > 0 ? ` ¬∑ ${categoryQuestions.filter(q => q.custom).length} custom` : ''}
            </div>
        `;
        
        if (categoryQuestions.length > 1) {
            const dropdown = document.createElement('div');
            dropdown.className = 'modern-dropdown';
            dropdown.innerHTML = `
                <select onchange="jumpToQuestion(this.value)">
                    <option value="">Jump to Question...</option>
                    ${categoryQuestions.sort((a, b) => a.id - b.id).map(q => 
                        `<option value="question-${q.id}">Q${q.id}: ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}${q.custom ? ' ‚òÖ' : ''}</option>`
                    ).join('')}
                </select>
            `;
            categoryCard.appendChild(dropdown);
        }
        
        categoryCard.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-dropdown') && !e.target.closest('select')) {
                toggleCategory(categoryCard);
                const firstQ = categoryQuestions.sort((a, b) => a.id - b.id)[0];
                if (firstQ) {
                    jumpToQuestion(`question-${firstQ.id}`);
                }
            }
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
    
    selectedCategories = [...categories];
}

function toggleCategory(categoryCard) {
    const category = categoryCard.dataset.category;
    if (categoryCard.classList.contains('active')) {
        categoryCard.classList.remove('active');
        selectedCategories = selectedCategories.filter(c => c !== category);
    } else {
        categoryCard.classList.add('active');
        selectedCategories.push(category);
    }
    startQuiz();
    closeSidebar();
}

function startQuiz() {
    if (currentPage !== 'Dashboard') return;
    
    quizContainer.style.opacity = '0';
    setTimeout(() => {
        const allQuestions = [...quizData, ...customQuestions];
        questions = selectedCategories.length > 0 ? 
            allQuestions.filter(q => selectedCategories.includes(q.category)) : 
            allQuestions;
            
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        if (currentMode === 'learn' && incorrectQuestions.length > 0) {
            questions = allQuestions.filter(q => incorrectQuestions.includes(q.id));
        }
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        questions.sort((a, b) => a.id - b.id);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        examSubmitted = false;
        quizContainer.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        questionTimers = new Array(questions.length).fill(0);
        if (currentMode === 'exam') {
            isCountdown = true;
            remainingTime = 120 * questions.length;
        } else {
            isCountdown = false;
        }
        startTimer();
        renderQuizLayout();
        quizContainer.style.opacity = '1';
    }, 300);
}

function showNoQuestionsMessage() {
    let message = '';
    if (isSearchActive) {
        message = 'No questions match your search criteria. Try different keywords.';
    } else if (selectedCategories.length === 0) {
        message = 'No categories selected. Please select categories from the sidebar.';
    } else {
        message = 'No questions available for the selected categories.';
    }
    
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Questions Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                ${message}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Select Categories
                </button>
                <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Question
                </button>
                ${isSearchActive ? `
                    <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    resultsScreen.classList.add('hidden');
    stopTimer();
    quizContainer.style.opacity = '1';
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    startTime = new Date();
    timerInterval = setInterval(() => {
        if (isCountdown) {
            remainingTime--;
            if (remainingTime <= 0) {
                remainingTime = 0;
                clearInterval(timerInterval);
                if (currentMode === 'exam' && !examSubmitted) {
                    showNotification('Time up! Submitting exam.', 'error');
                    submitExam();
                }
            }
            updateTimerDisplay(formatTime(remainingTime), 'timerDisplay', true);
        } else {
            questionTimers[currentQuestionIndex]++;
            updateTimerDisplay(formatTime(questionTimers[currentQuestionIndex]), 'timerDisplay', false);
        }
    }, 1000);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

function updateTimerDisplay(time, id, isCountdown = false) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Time: ${time}`;
        if (isCountdown) {
            el.classList.remove('timer-warning', 'timer-error');
            if (remainingTime <= 30) {
                el.classList.add('timer-error');
            } else if (remainingTime <= 60) {
                el.classList.add('timer-warning');
            }
        }
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        if (startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000 / 60);
            userStats.timeSpent += timeSpent;
            userStats.lastActive = new Date().toISOString();
            saveUserData();
            updateDashboardStats();
        }
    }
}

function renderQuizLayout() {
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    if (currentMode === 'exam') {
        renderExamLayout();
    } else {
        renderSingleQuestionLayout();
    }
}

function renderExamLayout() {
    const isImmediateMode = examCheckMode === 'immediate';
    quizContainer.innerHTML = `
        <div class="exam-header" style="margin-bottom: 24px; padding: 20px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Exam Mode: ${questions.length} Questions
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ${isImmediateMode ?
                          'Immediate Check - See explanations as you answer' :
                          'All-in-One Check - Check all answers at the end'}
                    </p>
                </div>
                <div class="exam-mode-toggle" style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: var(--radius);">
                    <button class="mode-toggle-btn ${isImmediateMode ? 'active' : ''}" data-mode="immediate" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="Immediate Check Mode">
                        Immediate Check
                    </button>
                    <button class="mode-toggle-btn ${!isImmediateMode ? 'active' : ''}" data-mode="all-at-once" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${!isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${!isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="All-at-Once Check Mode">
                        Check All
                    </button>
                </div>
            </div>
            <div class="progress-info" style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 14px; color: var(--text-secondary);" id="answeredCount">0/${questions.length} answered</span>
                <div class="progress-bar" style="flex: 1; height: 6px;">
                    <div class="progress-fill" id="examProgressFill" style="width: 0%"></div>
                </div>
                <span id="timerDisplay" style="font-size: 14px; color: var(--text-secondary);">Time: ${formatTime(remainingTime)}</span>
                ${examSubmitted ? `<span style="color: var(--success); font-weight: 600; font-size: 14px;">Submitted!</span>` : ''}
            </div>
        </div>
        <div class="exam-mode-layout">
            ${questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const showExplanationButton = examSubmitted || (isImmediateMode && userAnswer !== undefined);
                return `
                    <div class="question-card fade-in" data-question-index="${index}" id="question-${question.id}">
                        <div class="question-header">
                            <div class="question-meta">
                                <div class="question-number">Q${question.id}</div>
                                <div class="question-category">${question.category}</div>
                                <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                    ${question.difficulty}
                                </div>
                                ${userAnswer !== undefined ? `
                                    <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                                        ${isCorrect ? 'Correct' : 'Incorrect'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="question-actions">
                                <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                                    <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="question-image-container">
                            ${question.image ? `<img src="${question.image}" alt="Question image" class="question-image">` : ''}
                        </div>
                        <div class="question-text">${marked.parse(question.question)}</div>
                        <div class="options-grid">
                            ${question.options.map((option, optIndex) => {
                                const isSelected = userAnswer === optIndex;
                                const isCorrectOption = optIndex === question.answer;
                                let optionClass = 'option';
                                if (userAnswer !== undefined) {
                                    if (isCorrectOption) {
                                        optionClass += ' correct';
                                    } else if (isSelected && !isCorrectOption) {
                                        optionClass += ' incorrect';
                                    }
                                    optionClass += ' disabled';
                                } else if (isSelected) {
                                    optionClass += ' selected';
                                }
                                return `
                                    <div class="${optionClass}" data-option-index="${optIndex}" role="button" aria-label="Option ${String.fromCharCode(65 + optIndex)}">
                                        <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                        <div class="option-text">${option}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${showExplanationButton ? `
                            <div class="explanation-section">
                                <details open>
                                    <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                                    <div class="explanation-content correct-answer">
                                        <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                                    </div>
                                </details>
                                ${userAnswer !== undefined && userAnswer !== question.answer ? `
                                    <details>
                                        <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                                        <div class="explanation-content why-not-section">
                                            <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                            <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                                        </div>
                                    </details>
                                ` : ''}
                                <details>
                                    <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                                    <div class="explanation-content">${question.explanation}</div>
                                </details>
                                <details>
                                    <summary><i class="fas fa-link"></i> Related Questions</summary>
                                    <div class="explanation-content related-questions">
                                        <div class="related-questions-list">
                                            ${question.relatedQuestions.map(q => {
                                                const qId = q.match(/\d+/)[0];
                                                return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    ${examCheckMode === 'all-at-once' && !examSubmitted ? `
                        <button class="quiz-btn check-btn" id="checkAllBtn" ${userAnswers.filter(a => a !== undefined).length === 0 ? 'disabled' : ''} aria-label="Check All Answers">
                            <i class="fas fa-check-double"></i>
                            Check All Answers
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn submit-btn" id="examSubmitBtn" ${examSubmitted ? 'disabled' : ''} aria-label="Submit Exam">
                    <i class="fas fa-paper-plane"></i>
                    ${examSubmitted ? 'Exam Submitted' : `Submit Exam (${questions.length} questions)`}
                </button>
            </div>
        </div>
    `;
    initializeExamModeEvents();
    updateExamSubmitButton();
}

function renderSingleQuestionLayout() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const isCorrect = userAnswer === question.answer;
    quizContainer.innerHTML = `
        <div class="question-card fade-in" data-question-index="${currentQuestionIndex}">
            <div class="question-header">
                <div class="question-meta">
                    <div class="question-number">Q${question.id}</div>
                    <div class="question-category">${question.category}</div>
                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                        ${question.difficulty}
                    </div>
                    ${userAnswer !== undefined ? `
                        <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </div>
                    ` : ''}
                </div>
                <div class="question-actions">
                    <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                        <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                    </button>
                </div>
            </div>
            <div class="question-image-container">
                ${question.image ? `<img src="${question.image}" alt="Question image" class="question-image">` : ''}
            </div>
            <div class="question-text">${marked.parse(question.question)}</div>
            <div class="options-grid">
                ${question.options.map((option, index) => {
                    const isSelected = userAnswer === index;
                    const isCorrectOption = index === question.answer;
                    let optionClass = 'option';
                    if (isAnswerChecked) {
                        if (isCorrectOption) {
                            optionClass += ' correct';
                        } else if (isSelected && !isCorrectOption) {
                            optionClass += ' incorrect';
                        }
                        optionClass += ' disabled';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    return `
                        <div class="${optionClass}" data-option-index="${index}" role="button" aria-label="Option ${String.fromCharCode(65 + index)}">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isAnswerChecked ? `
                <div class="explanation-section">
                    <details open>
                        <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                        <div class="explanation-content correct-answer">
                            <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                        </div>
                    </details>
                    ${userAnswer !== undefined && userAnswer !== question.answer ? `
                        <details>
                            <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                            <div class="explanation-content why-not-section">
                                <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                            </div>
                        </details>
                    ` : ''}
                    <details>
                        <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                        <div class="explanation-content">${question.explanation}</div>
                    </details>
                    <details>
                        <summary><i class="fas fa-link"></i> Related Questions</summary>
                        <div class="explanation-content related-questions">
                            <div class="related-questions-list">
                                ${question.relatedQuestions.map(q => {
                                    const qId = q.match(/\d+/)[0];
                                    return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                </div>
            ` : ''}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    <button class="quiz-btn check-btn" id="checkAnswerBtn" ${userAnswer === undefined ? 'disabled' : ''} aria-label="Check Answer">
                        <i class="fas fa-check"></i>
                        Check Answer
                    </button>
                    ${currentMode === 'learn' && incorrectQuestions.length > 0 ? `
                        <button class="quiz-btn" id="incorrectOnlyBtn" aria-label="Show Incorrect Only">
                            <i class="fas fa-filter"></i>
                            Incorrect Only
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn next-btn" id="nextQuestionBtn" ${!isAnswerChecked ? 'disabled' : ''} aria-label="Next Question">
                    <i class="fas fa-arrow-right"></i>
                    ${currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish'}
                </button>
            </div>
        </div>
    `;
    initializeQuizEvents();
    updateTimerDisplay(formatTime(isCountdown ? remainingTime : questionTimers[currentQuestionIndex]), 'timerDisplay', isCountdown);
}

function initializeQuizEvents() {
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const incorrectOnlyBtn = document.getElementById('incorrectOnlyBtn');
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    const options = document.querySelectorAll('.option:not(.disabled)');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            if (!isAnswerChecked) {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[currentQuestionIndex] = parseInt(option.dataset.optionIndex);
                if (checkAnswerBtn) checkAnswerBtn.disabled = false;
                updateExamSubmitButton();
            }
        });
    });
    
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', () => {
            checkAnswer();
            renderQuizLayout();
        });
    }
    
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (incorrectOnlyBtn) {
        incorrectOnlyBtn.addEventListener('click', () => {
            questions = quizData.filter(q => incorrectQuestions.includes(q.id));
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length);
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', () => {
            const questionId = parseInt(bookmarkBtn.dataset.questionId);
            toggleBookmark(questionId);
            bookmarkBtn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    }
}

function initializeExamModeEvents() {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const checkAllBtn = document.getElementById('checkAllBtn');
    const submitBtn = document.getElementById('examSubmitBtn');
    const modeToggleButtons = document.querySelectorAll('.mode-toggle-btn');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            const questionIndex = parseInt(option.closest('.question-card').dataset.questionIndex);
            const prevSelected = option.closest('.options-grid').querySelector('.selected');
            if (prevSelected) prevSelected.classList.remove('selected');
            option.classList.add('selected');
            userAnswers[questionIndex] = parseInt(option.dataset.optionIndex);
            updateExamProgress();
            updateExamSubmitButton();
            if (examCheckMode === 'immediate') {
                checkAnswer(questionIndex);
                renderQuizLayout();
            }
        });
    });
    
    if (checkAllBtn) {
        checkAllBtn.addEventListener('click', () => {
            userAnswers.forEach((answer, index) => {
                if (answer !== undefined) {
                    checkAnswer(index);
                }
            });
            renderQuizLayout();
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', submitExam);
    }
    
    modeToggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            examCheckMode = btn.dataset.mode;
            renderQuizLayout();
        });
    });
    
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionId = parseInt(btn.dataset.questionId);
            toggleBookmark(questionId);
            btn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    });
}

function updateExamProgress() {
    const answered = userAnswers.filter(a => a !== undefined).length;
    const progressPercent = (answered / questions.length) * 100;
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('examProgressFill');
    if (answeredCount) {
        answeredCount.textContent = `${answered}/${questions.length} answered`;
    }
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
}

function updateExamSubmitButton() {
    const submitBtn = document.getElementById('examSubmitBtn');
    if (submitBtn) {
        const allAnswered = userAnswers.every(a => a !== undefined);
        submitBtn.disabled = !allAnswered || examSubmitted;
        submitBtn.innerHTML = examSubmitted ?
            '<i class="fas fa-paper-plane"></i> Exam Submitted' :
            `<i class="fas fa-paper-plane"></i> Submit Exam (${questions.length} questions)`;
    }
}

function checkAnswer(questionIndex = currentQuestionIndex) {
    const question = questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    isAnswerChecked = true;
    if (userAnswer === question.answer) {
        score++;
        userStats.correctAnswers++;
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].correct++;
        userProgress[question.id].attempts++;
        incorrectQuestions = incorrectQuestions.filter(id => id !== question.id);
    } else {
        if (!incorrectQuestions.includes(question.id)) {
            incorrectQuestions.push(question.id);
        }
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].attempts++;
    }
    userStats.totalQuestions++;
    userStats.masteryLevel = calculateMasteryLevel();
    saveUserData();
    updateDashboardStats();
}

function submitExam() {
    examSubmitted = true;
    if (examCheckMode === 'all-at-once') {
        userAnswers.forEach((answer, index) => {
            if (answer !== undefined) {
                checkAnswer(index);
            }
        });
    }
    stopTimer();
    showResults();
}

function calculateMasteryLevel() {
    const masteredQuestions = Object.values(userProgress).filter(p => p.correct >= 3).length;
    return quizData.length > 0 ? Math.round((masteredQuestions / quizData.length) * 100) : 0;
}

function showResults() {
    stopTimer();
    quizContainer.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
    
    let restartText = 'Restart Quiz';
    if (currentPage === 'bookmarks') {
        restartText = 'Practice Again';
    }
    
    resultsScreen.innerHTML = `
        <div class="results-card fade-in">
            <div class="results-header">
                <h2 class="results-title">${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Results</h2>
                <p class="score-text">You completed ${questions.length} question${questions.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="score-display">${percentage}%</div>
            <div class="score-text">Score: ${score} out of ${questions.length} correct</div>
            <div class="results-details">
                ${questions.map((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    return `
                        <div class="result-item">
                            <div class="result-question">Q${q.id}: ${q.question}</div>
                            <div class="result-status ${isCorrect ? 'result-correct' : 'result-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="restart-btn" id="restartQuiz" aria-label="Restart Quiz" style="margin: 0;">
                    <i class="fas fa-redo"></i>
                    ${restartText}
                </button>
                ${currentPage === 'bookmarks' ? `
                    <button class="quiz-btn" onclick="showBookmarks()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 16px 24px; border-radius: var(--radius);">
                        <i class="fas fa-bookmark"></i>
                        Back to Bookmarks
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('restartQuiz').addEventListener('click', () => {
        if (currentPage === 'bookmarks') {
            startBookmarksQuiz();
        } else {
            startQuiz();
        }
    });
}

function toggleBookmark(questionId) {
    if (bookmarkedQuestions.has(questionId)) {
        bookmarkedQuestions.delete(questionId);
        showNotification('Question removed from bookmarks', 'info');
    } else {
        bookmarkedQuestions.add(questionId);
        showNotification('Question bookmarked', 'success');
    }
    saveUserData();
    
    // If we're on the bookmarks page, refresh it
    if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}


function getDifficultyColor(difficulty) {
    switch (difficulty.toLowerCase()) {
        case 'easy': return '#10b981';
        case 'medium': return '#f59e0b';
        case 'hard': return '#ef4444';
        default: return '#64748b';
    }
}

function jumpToQuestion(questionId) {
    const questionIndex = questions.findIndex(q => `question-${q.id}` === questionId);
    if (questionIndex !== -1) {
        if (currentMode === 'exam') {
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } else {
            currentQuestionIndex = questionIndex;
            isAnswerChecked = false;
            renderQuizLayout();
        }
    } else {
        // If question not in current quiz, start a new quiz with that question's category
        const question = quizData.find(q => `question-${q.id}` === questionId) || customQuestions.find(q => `question-${q.id}` === questionId);
        if (question) {
            selectedCategories = [question.category];
            startQuiz();
            setTimeout(() => {
                const element = document.getElementById(questionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }
}

// Initialize the application
init();
    </script>
</body>

</html>