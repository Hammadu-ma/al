<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Register - ALIF Medical Quiz Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="auth-check.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --trial-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --trial-color: #10b981;
            --trial-dark: #059669;
            --surface: #ffffff;
            --background: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
        }
        body.dark-mode {
            --surface: #1e293b;
            --background: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: pan-x pan-y;
        }
        html {
            touch-action: none;
        }

        /* Enhanced UI Elements */
        .connection-status {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }
        .connection-status.online {
            background: var(--success);
            color: white;
        }
        .connection-status.offline {
            background: var(--error);
            color: white;
        }
        .connection-status.syncing {
            background: var(--warning);
            color: white;
        }

        .data-backup-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            z-index: 998;
        }

        .persistence-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            z-index: 998;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }
        .logo i {
            font-size: 1.5rem;
        }
        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .action-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            text-decoration: none;
            position: relative;
        }
        .action-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        .action-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .action-btn.primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 80px 1rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 80px);
            overflow: hidden;
        }
        .registration-container {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        .registration-header {
            background: var(--gradient);
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .registration-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .registration-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        .registration-body {
            padding: 1.5rem;
        }
        .trial-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin: 1rem 0;
            cursor: pointer;
            transition: var(--transition);
        }
        .trial-option:hover {
            border-color: var(--trial-color);
            background: rgba(16, 185, 129, 0.05);
        }
        .trial-option.selected {
            border-color: var(--trial-color);
            background: rgba(16, 185, 129, 0.1);
        }
        .trial-option .radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .trial-option.selected .radio {
            border-color: var(--trial-color);
        }
        .trial-option.selected .radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--trial-color);
            border-radius: 50%;
        }
        .trial-option-content {
            flex: 1;
        }
        .trial-option-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .trial-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .trial-option-badge {
            background: var(--trial-gradient);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .price-info {
            text-align: center;
            margin: 1rem 0;
            color: var(--warning);
            font-weight: 600;
            font-size: 1.1rem;
        }
        .account-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        .account-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .account-title i {
            color: var(--primary);
        }
        .account-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        .account-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .account-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .account-number {
            font-family: monospace;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .copy-btn:hover {
            background: var(--primary-dark);
        }
        .copy-btn.copied {
            background: var(--success);
        }
        .payment-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            text-align: center;
        }
        .temp-login-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.05);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        .temp-login-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .temp-login-title i {
            color: var(--purple);
        }
        .temp-login-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .temp-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-group i {
            position: absolute;
            left: 1rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        select, input {
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s;
            width: 100%;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .file-upload {
            position: relative;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .file-upload:hover {
            border-color: var(--primary-light);
        }
        .file-upload i {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .file-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .receipt-preview {
            margin-top: 1rem;
            max-width: 100%;
            max-height: 150px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            display: none;
        }
        .submit-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            width: 100%;
            margin-top: 1rem;
        }
        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .submit-btn.loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        .login-link {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
        }
        .login-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            overflow-y: auto;
            max-height: 80vh;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content h2 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .modal-content h2 i {
            color: var(--primary);
        }
        .back-btn, .cancel-btn, .ok-btn {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            width: 100%;
        }
        .back-btn:hover, .cancel-btn:hover, .ok-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        .ok-btn {
            background: var(--gradient);
            color: white;
            border: none;
        }
        .ok-btn:hover {
            background: var(--primary-dark);
        }
        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .trial-features {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }
        .trial-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(16, 185, 129, 0.05);
            border-radius: var(--radius);
        }
        .trial-feature i {
            color: var(--trial-color);
            font-size: 1.1rem;
        }
        .trial-timer {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--trial-color);
            text-align: center;
            margin: 1rem 0;
            font-family: monospace;
        }
        .trial-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .trial-btn {
            background: var(--trial-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .trial-btn:hover {
            background: var(--trial-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .trial-btn.secondary {
            background: transparent;
            color: var(--trial-color);
            border: 1px solid var(--trial-color);
        }
        .trial-btn.secondary:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        /* Enhanced Registration Styles */
        .registration-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }
        .step-number.active {
            background: var(--primary);
            color: white;
        }
        .step-number.completed {
            background: var(--success);
            color: white;
        }
        .step-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }
        .step-label.active {
            color: var(--primary);
            font-weight: 600;
        }
        .progress-line {
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            z-index: -1;
        }
        .progress-fill {
            position: absolute;
            top: 15px;
            left: 0;
            height: 2px;
            background: var(--primary);
            transition: var(--transition);
        }

        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        .nav-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .nav-btn.prev {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .nav-btn.prev:hover {
            background: var(--border);
        }
        .nav-btn.next {
            background: var(--primary);
            color: white;
        }
        .nav-btn.next:hover {
            background: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .header-container {
                padding: 0.75rem;
            }
            .main-content {
                padding: 70px 0.75rem 1rem;
                height: calc(100vh - 70px);
            }
            .registration-body {
                padding: 1.25rem;
            }
            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }
            .connection-status {
                top: 60px;
                right: 10px;
                font-size: 0.7rem;
            }
            .data-backup-indicator,
            .persistence-indicator {
                bottom: 10px;
                font-size: 0.7rem;
                padding: 0.4rem 0.8rem;
            }
        }
        @media (max-width: 480px) {
            .registration-header h1 {
                font-size: 1.25rem;
            }
            .modal-content h2 {
                font-size: 1.5rem;
            }
            .trial-actions {
                flex-direction: column;
            }
            .trial-btn {
                width: 100%;
                justify-content: center;
            }
            .navigation-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Enhanced UI Elements -->
    <div id="connectionStatus" class="connection-status online" style="display: none;">
        <i class="fas fa-wifi"></i>
        <span>Connected</span>
    </div>

    <div id="dataBackupIndicator" class="data-backup-indicator" style="display: none;">
        <i class="fas fa-cloud-upload-alt"></i>
        <span>Backing up data...</span>
    </div>

    <div id="persistenceIndicator" class="persistence-indicator" style="display: none;">
        <i class="fas fa-shield-alt"></i>
        <span>Secure Registration</span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo" id="logoBtn">
                <i class="fas fa-stethoscope"></i>
                <span>ALIF</span>
            </div>
            <div class="nav-actions">
                <button class="action-btn" id="themeToggle">
                    <i class="fas fa-sun"></i>
                </button>
                <a href="index.html" class="action-btn">
                    <i class="fas fa-home"></i> Home
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="registration-container">
            <div class="registration-header">
                <h1><i class="fas fa-user-plus"></i> Register</h1>
                <p>Join ALIF Medical Quiz Platform to access comprehensive medical quizzes</p>
            </div>
            <div class="registration-body">
                <!-- Registration Progress -->
                <div class="registration-progress">
                    <div class="progress-line"></div>
                    <div class="progress-fill" style="width: 33.33%;"></div>
                    <div class="progress-step">
                        <div class="step-number active">1</div>
                        <div class="step-label active">Plan</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-number">2</div>
                        <div class="step-label">Details</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-number">3</div>
                        <div class="step-label">Verify</div>
                    </div>
                </div>

                <!-- Step 1: Plan Selection -->
                <div class="form-section active" id="step1">
                    <!-- Free Trial Option -->
                    <div class="trial-option" id="trialOption">
                        <div class="radio"></div>
                        <div class="trial-option-content">
                            <div class="trial-option-title">Free Trial Access</div>
                            <div class="trial-option-desc">Get 3 days of free access to all programs</div>
                        </div>
                        <div class="trial-option-badge">FREE</div>
                    </div>
                    
                    <!-- Regular Registration Option -->
                    <div class="trial-option selected" id="regularOption">
                        <div class="radio"></div>
                        <div class="trial-option-content">
                            <div class="trial-option-title">Full Program Access</div>
                            <div class="trial-option-desc">Pay once and get permanent access to selected program</div>
                        </div>
                    </div>
                    
                    <div id="priceInfo" class="price-info">Select Year to View Price</div>
                    
                    <!-- Account Numbers Section -->
                    <div class="account-section" id="accountSection">
                        <h3 class="account-title"><i class="fas fa-university"></i> Payment Accounts</h3>
                        <div class="account-list">
                            <div class="account-item">
                                <div class="account-info">
                                    <span class="account-name">CBE</span>
                                    <span class="account-number">1000544233185</span>
                                </div>
                                <button class="copy-btn" onclick="copyToClipboard('1000544233185', this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div class="account-item">
                                <div class="account-info">
                                    <span class="account-name">Awash Bank</span>
                                    <span class="account-number">014251165418600</span>
                                </div>
                                <button class="copy-btn" onclick="copyToClipboard('014251165418600', this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div class="account-item">
                                <div class="account-info">
                                    <span class="account-name">Tele birr</span>
                                    <span class="account-number">0912496441</span>
                                </div>
                                <button class="copy-btn" onclick="copyToClipboard('0912496441', this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <p class="payment-note">Please use your name as payment reference</p>
                    </div>

                    <div class="navigation-buttons">
                        <button class="nav-btn next" id="step1Next">
                            Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Registration Details -->
                <div class="form-section" id="step2">
                    <form id="regForm">
                        <div class="form-group">
                            <div class="input-group">
                                <i class="fas fa-graduation-cap"></i>
                                <select id="year" required>
                                    <option value="" disabled selected>Select Year of Study</option>
                                    <option value="1">Pre Med - 100 ETB</option>
                                    <option value="2">Intro Med - 100 ETB</option>
                                    <option value="3">Meta - 100 ETB</option>
                                    <option value="4">Hema - 100 ETB</option>
                                    <option value="5">CVS - 100 ETB</option>
                                    <option value="6">RESPA - 100 ETB</option>
                                    <option value="7">Musclo - 100 ETB</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <i class="fas fa-user"></i>
                                <input id="name" placeholder="Full Name" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <i class="fas fa-phone"></i>
                                <input id="phone" type="tel" placeholder="Phone Number" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <i class="fas fa-envelope"></i>
                                <input id="email" type="email" placeholder="Email (optional)">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <i class="fab fa-telegram-plane"></i>
                                <input id="telegram" placeholder="Telegram Username (required for fast auth.)">
                            </div>
                        </div>
                        
                        <div class="form-group" id="receiptUploadSection">
                            <div class="file-upload" id="receiptUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span id="uploadText">Upload Payment Receipt</span>
                                <input id="receipt" type="file" accept="image/*" required>
                            </div>
                            <img id="receiptPreview" class="receipt-preview" alt="Receipt Preview">
                        </div>
                        
                        <div class="navigation-buttons">
                            <button type="button" class="nav-btn prev" id="step2Prev">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button type="submit" class="nav-btn next" id="step2Next">
                                Submit <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div id="regError" class="error"></div>
                    </form>
                </div>

                <!-- Step 3: Verification -->
                <div class="form-section" id="step3">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <i class="fas fa-envelope-circle-check" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                        <h3 style="margin-bottom: 0.5rem;">Verification Required</h3>
                        <p style="color: var(--text-secondary);">We've sent a 6-digit code to verify your registration.</p>
                    </div>

                    <div class="form-group">
                        <div class="input-group">
                            <i class="fas fa-key"></i>
                            <input id="verifyCode" placeholder="Enter 6-digit code" maxlength="6" required>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="nav-btn prev" id="step3Prev">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="nav-btn next" id="verifyBtn">
                            Verify <i class="fas fa-check-circle"></i>
                        </button>
                    </div>
                    <div id="verifyError" class="error"></div>

                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="action-btn" id="resendCodeBtn" style="margin: 0 auto;">
                            <i class="fas fa-redo"></i> Resend Code
                        </button>
                    </div>
                </div>
                
                <!-- Temporary Password Login Section -->
                <div class="temp-login-section">
                    <h3 class="temp-login-title"><i class="fas fa-key"></i> Admin Password Login</h3>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Already registered? Login with temporary password from admin
                    </p>
                    <button class="temp-login-btn" id="tempPasswordLoginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login with Admin Password
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Free Trial Modal -->
    <div id="trialModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2><i class="fas fa-gift"></i> Start Your Free Trial</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                Get 3 days of full access to all programs completely free!
            </p>
            
            <div class="trial-features">
                <div class="trial-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>Access to all 7 medical programs</span>
                </div>
                <div class="trial-feature">
                    <i class="fas fa-clock"></i>
                    <span>3 days of unlimited access</span>
                </div>
                <div class="trial-feature">
                    <i class="fas fa-book-medical"></i>
                    <span>All quizzes and study materials</span>
                </div>
                <div class="trial-feature">
                    <i class="fas fa-chart-line"></i>
                    <span>Track your progress and scores</span>
                </div>
            </div>
            
            <div class="trial-timer" id="trialCountdown">
                72:00:00
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-secondary); text-align: center; margin: 1rem 0;">
                No payment required. Start learning immediately!
            </p>
            
            <div class="trial-actions">
                <button class="trial-btn" id="startTrialBtn">
                    <i class="fas fa-play"></i> Start Free Trial
                </button>
                <button class="trial-btn secondary" id="cancelTrialBtn">
                    <i class="fas fa-times"></i> Maybe Later
                </button>
            </div>
        </div>
    </div>

    <!-- Temporary Password Login Modal -->
    <div id="tempPasswordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2><i class="fas fa-key"></i> Admin Password Login</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                Enter your phone number and temporary password provided by admin
            </p>
            
            <form id="tempPasswordForm">
                <div class="form-group">
                    <div class="input-group">
                        <i class="fas fa-phone"></i>
                        <input id="tempPhone" type="tel" placeholder="Your registered phone number" required>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input id="tempPassword" type="text" placeholder="Temporary password from admin" required>
                    </div>
                </div>
                <button type="submit" class="submit-btn" id="tempLoginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <div id="tempLoginError" class="error"></div>
            </form>
            
            <button class="back-btn" id="backToRegBtn">
                <i class="fas fa-arrow-left"></i> Back to Registration
            </button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Enhanced Registration Manager
        class EnhancedRegistrationManager {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 3;
                this.isTrialSelected = false;
                this.pendingRegistration = null;
                this.connectionStatus = document.getElementById('connectionStatus');
                this.dataBackupIndicator = document.getElementById('dataBackupIndicator');
                this.persistenceIndicator = document.getElementById('persistenceIndicator');
                this.isInitialized = false;
            }

            async init() {
                if (this.isInitialized) return;

                console.log('Initializing Enhanced Registration Manager...');
                
                // Initialize connection monitoring
                this.initConnectionMonitoring();
                
                // Initialize data persistence
                await this.initDataPersistence();
                
                // Check for existing registration data
                await this.restoreRegistrationState();
                
                // Setup enhanced event listeners
                this.setupEnhancedEventListeners();
                
                this.isInitialized = true;
                console.log('Enhanced Registration Manager initialized');
            }

            // Connection Monitoring
            initConnectionMonitoring() {
                window.addEventListener('online', () => {
                    this.handleConnectionRestored();
                });

                window.addEventListener('offline', () => {
                    this.handleConnectionLost();
                });

                this.updateConnectionStatus(navigator.onLine);
            }

            updateConnectionStatus(isOnline) {
                if (isOnline) {
                    this.connectionStatus.className = 'connection-status online';
                    this.connectionStatus.innerHTML = '<i class="fas fa-wifi"></i><span>Connected</span>';
                    this.connectionStatus.style.display = 'flex';
                    
                    setTimeout(() => {
                        this.connectionStatus.style.display = 'none';
                    }, 3000);
                } else {
                    this.connectionStatus.className = 'connection-status offline';
                    this.connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline - Working locally</span>';
                    this.connectionStatus.style.display = 'flex';
                }
            }

            handleConnectionLost() {
                console.log('Connection lost - registration data saved locally');
                this.updateConnectionStatus(false);
                this.showOfflineMessage();
            }

            handleConnectionRestored() {
                console.log('Connection restored');
                this.updateConnectionStatus(true);
                
                this.connectionStatus.className = 'connection-status syncing';
                this.connectionStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>Syncing...</span>';
                this.connectionStatus.style.display = 'flex';
                
                setTimeout(() => {
                    this.connectionStatus.style.display = 'none';
                }, 2000);
            }

            // Data Persistence
            async initDataPersistence() {
                this.persistenceIndicator.style.display = 'flex';
                await this.backupRegistrationState();
            }

            async backupRegistrationState() {
                try {
                    const state = {
                        currentStep: this.currentStep,
                        isTrialSelected: this.isTrialSelected,
                        formData: this.getFormData(),
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('registrationState', JSON.stringify(state));
                    sessionStorage.setItem('registrationBackup', JSON.stringify(state));
                    
                    console.log('Registration state backed up');
                } catch (error) {
                    console.error('Error backing up registration state:', error);
                }
            }

            async restoreRegistrationState() {
                try {
                    const savedState = localStorage.getItem('registrationState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        
                        // Check if state is not too old (last 1 hour)
                        const oneHourAgo = Date.now() - (60 * 60 * 1000);
                        if (state.timestamp > oneHourAgo) {
                            this.currentStep = state.currentStep;
                            this.isTrialSelected = state.isTrialSelected;
                            this.restoreFormData(state.formData);
                            this.updateProgress();
                            console.log('Registration state restored');
                        } else {
                            localStorage.removeItem('registrationState');
                        }
                    }
                } catch (error) {
                    console.error('Error restoring registration state:', error);
                }
            }

            getFormData() {
                return {
                    year: document.getElementById('year')?.value || '',
                    name: document.getElementById('name')?.value || '',
                    phone: document.getElementById('phone')?.value || '',
                    email: document.getElementById('email')?.value || '',
                    telegram: document.getElementById('telegram')?.value || ''
                };
            }

            restoreFormData(formData) {
                if (formData.year) document.getElementById('year').value = formData.year;
                if (formData.name) document.getElementById('name').value = formData.name;
                if (formData.phone) document.getElementById('phone').value = formData.phone;
                if (formData.email) document.getElementById('email').value = formData.email;
                if (formData.telegram) document.getElementById('telegram').value = formData.telegram;
            }

            // Enhanced Event Listeners
            setupEnhancedEventListeners() {
                // Auto-save form data on change
                const formInputs = ['year', 'name', 'phone', 'email', 'telegram'];
                formInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            this.backupRegistrationState();
                        });
                    }
                });

                // Handle page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.backupRegistrationState();
                    }
                });

                // Handle beforeunload
                window.addEventListener('beforeunload', (e) => {
                    if (this.currentStep > 1) {
                        this.backupRegistrationState();
                    }
                });
            }

            // Progress Management
            updateProgress() {
                // Update step numbers
                for (let i = 1; i <= this.totalSteps; i++) {
                    const stepNumber = document.querySelector(`.step-number:nth-child(${i})`);
                    const stepLabel = document.querySelector(`.step-label:nth-child(${i})`);
                    
                    if (stepNumber && stepLabel) {
                        stepNumber.className = 'step-number';
                        stepLabel.className = 'step-label';
                        
                        if (i < this.currentStep) {
                            stepNumber.classList.add('completed');
                        } else if (i === this.currentStep) {
                            stepNumber.classList.add('active');
                            stepLabel.classList.add('active');
                        }
                    }
                }

                // Update progress fill
                const progressFill = document.querySelector('.progress-fill');
                const progressPercentage = ((this.currentStep - 1) / (this.totalSteps - 1)) * 100;
                if (progressFill) {
                    progressFill.style.width = `${progressPercentage}%`;
                }

                // Show/hide sections
                for (let i = 1; i <= this.totalSteps; i++) {
                    const section = document.getElementById(`step${i}`);
                    if (section) {
                        section.classList.remove('active');
                        if (i === this.currentStep) {
                            section.classList.add('active');
                        }
                    }
                }
            }

            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    this.updateProgress();
                    this.backupRegistrationState();
                }
            }

            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateProgress();
                    this.backupRegistrationState();
                }
            }

            showOfflineMessage() {
                // Could implement a subtle offline indicator
                console.log('Registration in offline mode - data saved locally');
            }

            // Cleanup
            destroy() {
                this.isInitialized = false;
            }
        }

        // Initialize enhanced registration manager
        const registrationManager = new EnhancedRegistrationManager();

        // Your existing Firebase User Manager and other code remains the same
        class FirebaseUserManager {
            constructor() {
                this.usersCollection = db.collection('users');
                this.trialsCollection = db.collection('trials');
            }

            // Check if user is eligible for trial
            async isEligibleForTrial(phone) {
                try {
                    const trialSnapshot = await this.trialsCollection.where('phone', '==', phone).get();
                    return trialSnapshot.empty;
                } catch (error) {
                    console.error('Error checking trial eligibility:', error);
                    return false;
                }
            }

            // Create a new trial user
            async createTrialUser(userData) {
                try {
                    if (await this.checkPhoneExists(userData.phone)) {
                        return { success: false, error: 'Phone already registered. Please login.' };
                    }
                    
                    const code = Math.floor(100000 + Math.random() * 900000).toString();
                    const trialEndDate = new Date();
                    trialEndDate.setDate(trialEndDate.getDate() + 3);
                    
                    const userRecord = {
                        ...userData,
                        verificationCode: code,
                        codeTimestamp: new Date().getTime(),
                        registeredYears: ['1', '2', '3', '4', '5', '6', '7'],
                        createdAt: new Date().getTime(),
                        lastLogin: null,
                        lastActive: new Date().getTime(),
                        isOnline: true,
                        status: 'pending',
                        role: 'user',
                        plan: 'trial',
                        isTrial: true,
                        trialStart: new Date().getTime(),
                        trialDuration: 3,
                        trialEndDate: trialEndDate.getTime()
                    };

                    const docRef = await this.usersCollection.add(userRecord);
                    
                    await this.trialsCollection.add({
                        phone: userData.phone,
                        name: userData.name,
                        startDate: new Date().getTime(),
                        endDate: trialEndDate.getTime(),
                        userId: docRef.id,
                        used: true
                    });
                    
                    return { success: true, userId: docRef.id, code };
                } catch (error) {
                    console.error('Error creating trial user:', error);
                    return { success: false, error: error.message };
                }
            }

            // Create regular user
            async createUser(userData) {
                try {
                    if (await this.checkPhoneExists(userData.phone)) {
                        return { success: false, error: 'Phone already registered. Please login.' };
                    }
                    const code = Math.floor(100000 + Math.random() * 900000).toString();
                    const userRecord = {
                        ...userData,
                        verificationCode: code,
                        codeTimestamp: new Date().getTime(),
                        registeredYears: [userData.year],
                        createdAt: new Date().getTime(),
                        lastLogin: null,
                        lastActive: new Date().getTime(),
                        isOnline: true,
                        status: 'pending',
                        role: 'user',
                        plan: 'basic',
                        isTrial: false
                    };

                    const docRef = await this.usersCollection.add(userRecord);
                    return { success: true, userId: docRef.id, code };
                } catch (error) {
                    console.error('Error creating user:', error);
                    return { success: false, error: error.message };
                }
            }

            async checkPhoneExists(phone) {
                const snapshot = await this.usersCollection.where('phone', '==', phone).get();
                return !snapshot.empty;
            }

            isCodeExpired(timestamp) {
                const now = new Date().getTime();
                const twoDaysInMs = 2 * 24 * 60 * 60 * 1000;
                return now - timestamp > twoDaysInMs;
            }

            // Temporary password login method
            async loginWithTemporaryPassword(phone, password) {
                try {
                    const snapshot = await this.usersCollection.where('phone', '==', phone).get();
                    if (snapshot.empty) {
                        return { success: false, error: 'Phone number not found. Please register first.' };
                    }

                    const doc = snapshot.docs[0];
                    const user = doc.data();
                    
                    if (!user.verificationCode) {
                        return { success: false, error: 'No temporary password set. Please use regular login.' };
                    }

                    if (user.verificationCode !== password) {
                        return { success: false, error: 'Invalid temporary password.' };
                    }

                    if (user.codeTimestamp && this.isCodeExpired(user.codeTimestamp)) {
                        return { success: false, error: 'Temporary password has expired. Please contact admin.' };
                    }

                    // Check uses limit
                    const usesCount = user.tempPasswordUsesCount || 0;
                    if (usesCount >= (user.tempPasswordUsesAllowed || 10)) {
                        return { success: false, error: 'Temporary password uses limit reached. Please contact admin.' };
                    }

                    // Check if trial has expired
                    if (user.isTrial && this.isTrialExpired(user.trialEndDate)) {
                        return { success: false, error: 'Your free trial has expired. Please upgrade to continue.' };
                    }

                    // Increment uses count
                    await this.usersCollection.doc(doc.id).update({
                        tempPasswordUsesCount: firebase.firestore.FieldValue.increment(1)
                    });

                    // Update user status
                    await this.usersCollection.doc(doc.id).update({
                        status: 'verified',
                        lastLogin: Date.now(),
                        lastActive: Date.now(),
                        isOnline: true
                    });

                    user.id = doc.id;
                    user.status = 'verified';
                    user.lastLogin = Date.now();
                    user.lastActive = Date.now();

                    return { success: true, user };
                } catch (error) {
                    console.error('Error logging in with temporary password:', error);
                    return { success: false, error: 'Login failed. Please try again.' };
                }
            }

            isTrialExpired(trialEndDate) {
                return new Date().getTime() > trialEndDate;
            }

            async verifyUser(phone, code) {
                try {
                    const snapshot = await this.usersCollection.where('phone', '==', phone).get();
                    if (snapshot.empty) {
                        return { success: false, error: 'User not found' };
                    }

                    let user = null;
                    let userDocId = null;
                    
                    snapshot.forEach(doc => {
                        user = doc.data();
                        userDocId = doc.id;
                    });

                    if (user.verificationCode !== code) {
                        return { success: false, error: 'Invalid verification code' };
                    }

                    const codeTimestamp = user.codeTimestamp;
                    const now = new Date().getTime();
                    const twoDaysInMs = 2 * 24 * 60 * 60 * 1000;
                    
                    if (now - codeTimestamp > twoDaysInMs) {
                        return { success: false, error: 'Verification code has expired' };
                    }

                    await this.usersCollection.doc(userDocId).update({
                        status: 'verified',
                        verifiedAt: new Date().getTime(),
                        lastLogin: new Date().getTime(),
                        lastActive: new Date().getTime(),
                        isOnline: true
                    });

                    user.id = userDocId;
                    user.status = 'verified';
                    user.lastLogin = new Date().getTime();
                    user.lastActive = new Date().getTime();

                    return { success: true, user };
                } catch (error) {
                    console.error('Error verifying user:', error);
                    return { success: false, error: 'Verification failed' };
                }
            }
        }

        const firebaseUserManager = new FirebaseUserManager();

        // Price data
        const prices = {
            1: 100,
            2: 100,
            3: 100,
            4: 100,
            5: 100,
            6: 100,
            7: 100
        };

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const trialOption = document.getElementById('trialOption');
        const regularOption = document.getElementById('regularOption');
        const accountSection = document.getElementById('accountSection');
        const receiptUploadSection = document.getElementById('receiptUploadSection');
        const priceInfo = document.getElementById('priceInfo');
        const yearSelect = document.getElementById('year');
        const regForm = document.getElementById('regForm');
        const receiptInput = document.getElementById('receipt');
        const receiptPreview = document.getElementById('receiptPreview');
        const uploadText = document.getElementById('uploadText');
        const regError = document.getElementById('regError');
        const tempPasswordLoginBtn = document.getElementById('tempPasswordLoginBtn');
        const tempPasswordModal = document.getElementById('tempPasswordModal');
        const tempPasswordForm = document.getElementById('tempPasswordForm');
        const tempLoginBtn = document.getElementById('tempLoginBtn');
        const tempLoginError = document.getElementById('tempLoginError');
        const backToRegBtn = document.getElementById('backToRegBtn');
        const trialModal = document.getElementById('trialModal');
        const startTrialBtn = document.getElementById('startTrialBtn');
        const cancelTrialBtn = document.getElementById('cancelTrialBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const verifyError = document.getElementById('verifyError');
        const loginLink = document.getElementById('loginLink');
        const resendCodeBtn = document.getElementById('resendCodeBtn');

        // Navigation buttons
        const step1Next = document.getElementById('step1Next');
        const step2Prev = document.getElementById('step2Prev');
        const step2Next = document.getElementById('step2Next');
        const step3Prev = document.getElementById('step3Prev');

        // Theme toggle
        function toggleTheme() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                themeToggle.querySelector('i').className = 'fas fa-moon';
                localStorage.setItem('themePreference', 'light');
            } else {
                document.body.classList.add('dark-mode');
                themeToggle.querySelector('i').className = 'fas fa-sun';
                localStorage.setItem('themePreference', 'dark');
            }
        }
        themeToggle.addEventListener('click', toggleTheme);

        // Load saved theme preference
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('themePreference');
            if (savedTheme === 'light') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                themeToggle.querySelector('i').className = 'fas fa-moon';
            }
        }

        // Trial option selection
        trialOption.addEventListener('click', () => {
            trialOption.classList.add('selected');
            regularOption.classList.remove('selected');
            registrationManager.isTrialSelected = true;
            
            // Hide payment-related elements for trial
            accountSection.style.display = 'none';
            receiptUploadSection.style.display = 'none';
            document.getElementById('receipt').required = false;
            priceInfo.textContent = 'Free Trial - 3 Days Access to All Programs';
            
            registrationManager.backupRegistrationState();
        });

        regularOption.addEventListener('click', () => {
            regularOption.classList.add('selected');
            trialOption.classList.remove('selected');
            registrationManager.isTrialSelected = false;
            
            // Show payment-related elements for regular registration
            accountSection.style.display = 'block';
            receiptUploadSection.style.display = 'block';
            document.getElementById('receipt').required = true;
            
            // Update price info based on selected year
            const year = document.getElementById('year').value;
            priceInfo.textContent = year ? `Price: ${prices[year]} ETB` : 'Select Year to View Price';
            
            registrationManager.backupRegistrationState();
        });

        // Update price info when year changes (for regular registration)
        yearSelect.addEventListener('change', () => {
            if (!registrationManager.isTrialSelected) {
                const year = yearSelect.value;
                priceInfo.textContent = year ? `Price: ${prices[year]} ETB` : 'Select Year to View Price';
            }
        });

        // Receipt preview
        receiptInput.addEventListener('change', () => {
            const file = receiptInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    receiptPreview.src = e.target.result;
                    receiptPreview.style.display = 'block';
                    uploadText.textContent = 'Change Payment Receipt';
                };
                reader.readAsDataURL(file);
            } else {
                receiptPreview.style.display = 'none';
                uploadText.textContent = 'Upload Payment Receipt';
            }
        });

        // Copy to clipboard function
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
                
            }).catch(err => {
                console.error('Failed to copy: ', err);
                button.innerHTML = '<i class="fas fa-times"></i> Failed';
                button.style.background = 'var(--error)';
                
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    button.style.background = 'var(--primary)';
                }, 2000);
            });
        }

        // Navigation
        step1Next.addEventListener('click', () => {
            registrationManager.nextStep();
        });

        step2Prev.addEventListener('click', () => {
            registrationManager.prevStep();
        });

        step3Prev.addEventListener('click', () => {
            registrationManager.prevStep();
        });

        // Registration form submission
        regForm.addEventListener('submit', async e => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('step2Next');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            
            const year = document.getElementById('year').value;
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value || '';
            const telegram = document.getElementById('telegram').value || 'N/A';
            const receipt = document.getElementById('receipt').files[0];

            if (!year || !name || !phone || (!registrationManager.isTrialSelected && !receipt)) {
                regError.textContent = 'Please fill all required fields.';
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                return;
            }

            // If trial is selected, show trial modal instead
            if (registrationManager.isTrialSelected) {
                trialModal.style.display = 'flex';
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                return;
            }

            // Otherwise, proceed with regular registration
            const userData = {
                name: name,
                phone: phone,
                email: email,
                telegram: telegram,
                year: year,
                price: prices[year]
            };

            const result = await firebaseUserManager.createUser(userData);
            
            if (result.success) {
                // Send to Telegram with the code
                const caption = `New Registration\nYear: ${year} (${prices[year]} ETB)\nName: ${name}\nPhone: ${phone}\nEmail: ${email}\nCode: ${result.code}`;
                const formData = new FormData();
                formData.append('chat_id', '7986574047');
                formData.append('photo', receipt);
                formData.append('caption', caption);
                formData.append('parse_mode', 'Markdown');

                try {
                    const response = await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendPhoto', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.ok) {
                        localStorage.setItem('pendingPhone', phone);
                        localStorage.setItem('tempUserData', JSON.stringify(userData));
                        localStorage.setItem('codeTimestamp', new Date().getTime());
                        
                        registrationManager.nextStep();
                        regError.textContent = '';
                    } else {
                        regError.textContent = 'Error sending to Telegram: ' + data.description;
                    }
                } catch (err) {
                    regError.textContent = 'Error: ' + err.message;
                }
            } else {
                regError.textContent = 'Error creating user: ' + result.error;
            }

            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
        });

        // Start trial button
        startTrialBtn.addEventListener('click', async () => {
            startTrialBtn.classList.add('loading');
            startTrialBtn.disabled = true;
            
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value || '';
            const telegram = document.getElementById('telegram').value || 'N/A';

            if (!name || !phone) {
                alert('Please fill in your name and phone number to start the trial.');
                startTrialBtn.classList.remove('loading');
                startTrialBtn.disabled = false;
                return;
            }

            // Check trial eligibility
            const isEligible = await firebaseUserManager.isEligibleForTrial(phone);
            if (!isEligible) {
                alert('You have already used your free trial. Please register for a full program.');
                startTrialBtn.classList.remove('loading');
                startTrialBtn.disabled = false;
                return;
            }

            // Create trial user
            const userData = {
                name: name,
                phone: phone,
                email: email,
                telegram: telegram,
                year: 'trial'
            };

            const result = await firebaseUserManager.createTrialUser(userData);
            
            if (result.success) {
                // Send to Telegram with the code
                const caption = `New Trial Registration\nName: ${name}\nPhone: ${phone}\nEmail: ${email}\nCode: ${result.code}`;
                const formData = new FormData();
                formData.append('chat_id', '7986574047');
                formData.append('text', caption);
                formData.append('parse_mode', 'Markdown');

                try {
                    const response = await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendMessage', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.ok) {
                        localStorage.setItem('pendingPhone', phone);
                        localStorage.setItem('tempUserData', JSON.stringify(userData));
                        localStorage.setItem('codeTimestamp', new Date().getTime());
                        
                        trialModal.style.display = 'none';
                        registrationManager.nextStep();
                        regError.textContent = '';
                    } else {
                        regError.textContent = 'Error sending to Telegram: ' + data.description;
                    }
                } catch (err) {
                    regError.textContent = 'Error: ' + err.message;
                }
            } else {
                alert('Error creating trial account: ' + result.error);
            }

            startTrialBtn.classList.remove('loading');
            startTrialBtn.disabled = false;
        });

        // Cancel trial button
        cancelTrialBtn.addEventListener('click', () => {
            trialModal.style.display = 'none';
        });

        // Temporary password login button
        tempPasswordLoginBtn.addEventListener('click', () => {
            tempPasswordModal.style.display = 'flex';
        });

        // Back to registration from temp password modal
        backToRegBtn.addEventListener('click', () => {
            tempPasswordModal.style.display = 'none';
        });

        // Temporary password form submission
        tempPasswordForm.addEventListener('submit', async e => {
            e.preventDefault();
            tempLoginBtn.classList.add('loading');
            tempLoginBtn.disabled = true;
            
            const phone = document.getElementById('tempPhone').value;
            const password = document.getElementById('tempPassword').value;

            if (!phone || !password) {
                tempLoginError.textContent = 'Please enter both phone number and password.';
                tempLoginBtn.classList.remove('loading');
                tempLoginBtn.disabled = false;
                return;
            }

            const result = await firebaseUserManager.loginWithTemporaryPassword(phone, password);
            
            if (result.success) {
                // Store user data in localStorage
                localStorage.setItem('currentUser', JSON.stringify(result.user));
                localStorage.setItem('userYears', JSON.stringify(result.user.registeredYears));
                localStorage.setItem('verified', 'true');
                
                // Clear registration state
                localStorage.removeItem('registrationState');
                
                // Redirect to dashboard
                window.location.href = 'dashboard.html';
            } else {
                tempLoginError.textContent = result.error;
            }

            tempLoginBtn.classList.remove('loading');
            tempLoginBtn.disabled = false;
        });

        // Verification
        verifyBtn.addEventListener('click', async () => {
            const enteredCode = document.getElementById('verifyCode').value;
            const phone = localStorage.getItem('pendingPhone');

            if (!phone) {
                verifyError.textContent = 'Session expired. Please register again.';
                return;
            }

            verifyBtn.classList.add('loading');
            verifyBtn.disabled = true;

            const result = await firebaseUserManager.verifyUser(phone, enteredCode);
            
            if (result.success) {
                // Send verification notification to Telegram
                const caption = `User Verified\nName: ${result.user.name}\nPhone: ${result.user.phone}\n${result.user.isTrial ? 'Trial User - All Programs' : 'Year(s): ' + result.user.registeredYears.join(', ')}`;
                const formData = new FormData();
                formData.append('chat_id', '7986574047');
                formData.append('text', caption);
                formData.append('parse_mode', 'Markdown');
                await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendMessage', {
                    method: 'POST',
                    body: formData
                });

                // Store user data in localStorage
                localStorage.setItem('currentUser', JSON.stringify(result.user));
                localStorage.setItem('userYears', JSON.stringify(result.user.registeredYears));
                localStorage.setItem('verified', 'true');
                localStorage.removeItem('pendingPhone');
                localStorage.removeItem('tempUserData');
                localStorage.removeItem('codeTimestamp');
                localStorage.removeItem('registrationState');
                
                // Redirect to dashboard
                window.location.href = 'dashboard.html';
            } else {
                verifyError.textContent = result.error;
            }

            verifyBtn.classList.remove('loading');
            verifyBtn.disabled = false;
        });

        // Resend code
        resendCodeBtn.addEventListener('click', async () => {
            // Implementation for resending code would go here
            alert('Code resend functionality would be implemented here');
        });

        // Initialize the registration manager when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                // Redirect to dashboard if user is already logged in
                window.location.href = 'dashboard.html';
                return;
            }

            // Load theme preference
            loadThemePreference();
            
            // Initialize enhanced registration manager
            await registrationManager.init();
        });

        // Handle Telegram Mini App Back Button
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                console.log("Telegram back button pressed");
                handleBackAction();
            });
        }

        // Handle Browser/Phone Back Button
        window.addEventListener('popstate', () => {
            console.log("Browser back button pressed");
            handleBackAction();
        });

        // Function to handle back action globally
        function handleBackAction() {
            if (registrationManager.currentStep > 1) {
                registrationManager.prevStep();
            } else if (document.referrer && window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // Prevent unwanted exits
        history.pushState(null, '', location.href);
    </script>
</body>
</html>